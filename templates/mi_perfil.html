{% extends "base.html" %}
{% block title %}Mi Perfil - ATiempo{% endblock %}
{% block extra_styles %}
<style>
  body {
    margin: 0;
    padding: 0;
    font-family: 'Roboto', sans-serif;
    background: #f4f4f4;
    height: 100vh;
    overflow: hidden;
  }

  .content-wrapper {
    display: flex;
    height: calc(100vh - 120px);
    overflow: hidden;
  }

  .main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    background-color: #f4f4f4;
    padding: 20px 40px;
    overflow-y: auto;
    overflow-x: hidden;
    box-sizing: border-box;
  }

  #profile-content {
    width: 100%;
    max-width: none;
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .profile-card {
    background: #ffffff;
    padding: 25px;
    border: 2px solid black;
    border-radius: 8px;
    margin-bottom: 25px;
    width: 100%;
    box-sizing: border-box;
  }

  .profile-header {
    text-align: center;
    margin-bottom: 20px;
    border-bottom: 1px solid #eeeeee;
    padding-bottom: 20px;
  }

  .profile-header img {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    border: 3px solid #004080;
    object-fit: cover;
  }

  .tab-switcher {
    border-bottom: 2px solid black;
    margin: 0 0 20px 0;
    display: flex;
    gap: 10px;
    justify-content: center;
    width: 100%;
  }

  .tab-link {
    background-color: #f1f1f1;
    border: 1px solid #cccccc;
    border-bottom: none;
    cursor: pointer;
    padding: 10px 20px;
    font-size: 16px;
    font-weight: 700;
  }

  .tab-link.active {
    background-color: #004080;
    color: white;
  }

  .tab-content {
    display: none;
    flex: 1;
  }

  .tab-content.active {
    display: block;
  }

  .details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 15px 25px;
  }

  .detail-item strong {
    display: block;
    font-size: 12px;
    color: #555;
    text-transform: uppercase;
  }

  .detail-item span {
    font-size: 16px;
    color: #000;
  }

  .puesto-section {
    margin-bottom: 25px;
  }

  .puesto-section h3 {
    color: #004080;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
    margin-bottom: 15px;
  }

  .puesto-section ul {
    list-style-type: disc;
    margin-left: 20px;
  }

  .puesto-section ul li {
    margin-bottom: 5px;
  }

  .hierarchy-item {
    margin-left: 20px;
    margin-bottom: 5px;
  }

  /* Tables */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    background-color: white;
  }

  thead th {
    background-color: #004080;
    color: white;
    text-transform: uppercase;
    font-weight: 600;
    text-align: center;
    padding: 10px;
  }

  td, th {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: center;
  }

  .status-chip {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    color: white;
    text-transform: uppercase;
  }

  .status-completo { background-color: #28a745; }
  .status-incompleto { background-color: #ffc107; color: black; }
  .status-ausente { background-color: #dc3545; }
  .status-vacaciones-permiso { background-color: #0d6efd; }

  .attendance-summary td,
  .payroll-summary td {
    background-color: #e8f1ff;
    font-weight: bold;
    border-top: 2px solid #004080;
  }

  .btn-pdf {
    background-color: #004080;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    font-size: 13px;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .btn-pdf:hover {
    background-color: #0066cc;
  }

  .btn {
    background-color: #004080;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 14px;
    font-size: 14px;
    cursor: pointer;
  }

  .btn:hover {
    background-color: #0066cc;
  }

  /* Modal styling */
  .modal {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.5);
    align-items: center;
    justify-content: center;
    z-index: 2000;
  }

  .modal-content {
    background: #fff;
    padding: 20px;
    border-radius: 8px;
    width: 760px;
    max-width: 95%;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
  }

  .modal-content iframe {
    width: 100%;
    height: 72vh;
    border: none;
  }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 30px;
    right: 30px;
    background-color: #004080;
    color: white;
    padding: 12px 20px;
    border-radius: 6px;
    font-size: 14px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease, transform 0.4s ease;
    transform: translateY(30px);
    z-index: 3000;
  }

  .toast.show {
    opacity: 1;
    pointer-events: auto;
    transform: translateY(0);
  }

  /* Filter section */
  .filter-group {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }

  /* ‚úÖ Custom scrollbar */
  .main-content::-webkit-scrollbar {
    width: 10px;
  }
  .main-content::-webkit-scrollbar-track {
    background: #e0e0e0;
  }
  .main-content::-webkit-scrollbar-thumb {
    background: #004080;
    border-radius: 5px;
  }
  .main-content::-webkit-scrollbar-thumb:hover {
    background: #0066cc;
  }
  #center-loader {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 40px 0;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.4s ease;
}

#center-loader.visible {
  opacity: 1;
  pointer-events: all;
}

#center-loader-animation {
  width: 200px;
  height: 200px;
  margin-bottom: 15px;
}

#center-loader-text {
  font-weight: 600;
  color: #004080;
  font-size: 18px;
}
/* --- Attendance Table (styled like payroll) --- */
#attendanceTable {
  border: 2px solid black;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
  background-color: #ffffff;
}

#attendanceTable th {
  background-color: #004080;
  color: #fff;
  font-weight: 700;
  font-size: 14px;
  padding: 10px;
  border-right: 1px solid #002d5a;
}

#attendanceTable td {
  background-color: #f9fbff;
  color: #000;
  font-size: 14px;
  padding: 8px;
  border: 1px solid #d0d0d0;
}

#attendanceTable tr:nth-child(even) td {
  background-color: #f2f7ff;
}

#attendanceTable tr:hover td {
  background-color: #e7f0ff;
}

#attendanceTable tfoot td {
  background-color: #e8f1ff;
  font-weight: bold;
  color: #004080;
  border-top: 2px solid #004080;
}
#attendanceTable th:first-child {
  border-top-left-radius: 8px;
}
#attendanceTable th:last-child {
  border-top-right-radius: 8px;
}
.puesto-section {
  background-color: #fff;
  border: 2px solid black;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 3px 6px rgba(0,0,0,0.1);
}
/* ==========================================================
   üé® STATUS CHIP COLORS FOR ASISTENCIA (Estatus Column)
========================================================== */
.status-cell {
  font-weight: 600;
  text-transform: uppercase;
  text-align: center;
  padding: 6px 10px;
  border-radius: 8px;
  color: #fff;
  display: inline-block;
  min-width: 110px;
}

.status-completo { background-color: #16a34a; }         /* Green */
.status-incompleto { background-color: #f59e0b; }       /* Orange */
.status-tarde { background-color: #dc2626; }            /* Red */
.status-ausencia { background-color: #7f1d1d; }         /* Dark red */
.status-jornada { background-color: #0d6efd; }          /* Blue */
.status-default { background-color: #6b7280; }          /* Gray */

/* Optional hover effect */
.status-cell:hover {
  filter: brightness(1.1);
  cursor: default;
}
#progressResumen {
  animation: fadeIn 0.8s ease;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-6px); }
  to { opacity: 1; transform: translateY(0); }
}
/* ======================================================
   üßæ ATTENDANCE SUMMARY CARD (Same Style as Mi N√≥mina)
====================================================== */
.resumen-card {
  width: 100%;
  border: 2px solid black;
  border-radius: 12px;
  background: #ffffff;
  padding: 24px;
  margin-top: 25px;
  box-shadow: 2px 4px 8px rgba(0,0,0,0.1);
}

.resumen-card .card-title {
  color: #004080;
  font-weight: 700;
  font-size: 1.3em;
  border-bottom: 2px solid #004080;
  padding-bottom: 8px;
  margin-bottom: 18px;
  text-transform: uppercase;
}

.resumen-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 10px 30px;
  font-size: 15px;
}

.resumen-grid div {
  padding: 8px 0;
}

.resumen-grid strong {
  color: #222;
}

.resumen-grid span {
  color: #004080;
  font-weight: 600;
}
/* ---- Mi Asistencia header row ---- */
#attendanceTop {
  display: flex;
  justify-content: space-between;
  align-items: flex-end;    /* aligns the progress label with the selects */
  gap: 16px;
  margin: 6px 0 12px 0;
}

#attendanceTop .filter-group {
  margin: 0;                /* remove extra spacing so the row is tight */
}

.progress-box {
  min-width: 260px;
  max-width: 320px;
}

.progress-box .progress-title {
  font-weight: 600;
  font-size: 14px;
  color: #004080;
  display: flex;
  justify-content: space-between;
  margin-bottom: 4px;
}

#progressBarOuter {
  width: 100%;
  height: 16px;
  border-radius: 8px;
  background-color: #ddd;
  overflow: hidden;
}

#progressBarInner {
  height: 100%;
  width: 0%;
  background-color: #16a34a;
  transition: width 0.8s ease;
}
#attendanceWrapper {
  flex-wrap: wrap;
}

#miniResumenCard {
  min-width: 260px;
  max-width: 280px;
}

@media (max-width: 900px) {
  #attendanceWrapper {
    flex-direction: column;
  }
  #miniResumenCard {
    width: 100%;
    order: 2;
  }
}
/* ======================================================
   üìò MINI RESUMEN MENSUAL CARD (Matches Big .resumen-card)
====================================================== */
#miniResumenCard {
  border: 2px solid black;
  border-radius: 12px;
  background: #ffffff;
  padding: 18px 22px;
  box-shadow: 2px 4px 8px rgba(0, 0, 0, 0.12);
  min-width: 300px;
  max-width: 340px;
  animation: fadeIn 0.6s ease;
}

#miniResumenCard h4 {
  margin: 0 0 10px 0;
  padding-bottom: 6px;
  border-bottom: 2px solid #004080;
  font-size: 15px;
  font-weight: 700;
  color: #004080;
  text-transform: uppercase;
  text-align: left;
}

/* Two-column data grid */
#miniResumenCard .resumen-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  column-gap: 20px;
  row-gap: 6px;
  font-size: 14px;
}

#miniResumenCard .resumen-grid div {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 4px 0;
  border-bottom: 1px dotted #ccc;
}

#miniResumenCard .resumen-grid strong {
  color: #000;
  font-weight: 600;
}

#miniResumenCard .resumen-grid span {
  color: #004080;
  font-weight: 700;
}

#miniResumenCard .resumen-grid div:last-child {
  border-top: 2px solid #004080;
  border-bottom: none;
  margin-top: 6px;
  padding-top: 6px;
  grid-column: span 2;
  font-weight: 700;
  color: #004080;
}
#attendanceTopSummary {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 30px;
  margin-top: 12px;
  margin-bottom: 12px;
  flex-wrap: wrap;
}

#cumplimientoContainer {
  flex: 1;
  min-width: 320px;
}

@media (max-width: 900px) {
  #attendanceTopSummary {
    flex-direction: column;
  }
  #miniResumenCard {
    width: 100%;
  }
}


</style>
{% endblock %}
{% block content %}
<div id="auth-message">
  <div id="center-loader">
    <div id="center-loader-animation"></div>
    <p id="center-loader-text">Autenticando...</p>
  </div>
</div>


<div id="profile-content" style="display: none;">
  <div class="profile-card profile-header">
    <img id="detail_photo" src="https://placehold.co/120" alt="Foto de Perfil">
    <h2 id="detail_nombre_completo">---</h2>
    <p id="detail_puesto">---</p>
  </div>

  <div class="tab-switcher">
    <button class="tab-link active" onclick="openTab(event, 'personales')">Datos Personales</button>
    <button class="tab-link" onclick="openTab(event, 'asistencia')">Mi Asistencia</button>
    <button class="tab-link" onclick="openTab(event, 'nomina')">Mis N√≥minas</button>
    <button class="tab-link" onclick="openTab(event, 'puesto')">Mi Puesto</button>
  </div>

  <!-- DATOS PERSONALES -->
  <div id="personales" class="tab-content active">
    <div class="profile-card">
      <h3>Informaci√≥n Personal</h3> 
      <div class="details-grid" id="personal-details-grid"></div>
    </div>
  </div>

  <!-- ASISTENCIA -->
  <div id="asistencia" class="tab-content">
    <div class="profile-card">
      <div class="filter-group">
        <label for="yearSelect">A√±o:</label><select id="yearSelect"></select>
        <label for="monthSelect">Mes:</label><select id="monthSelect"></select>
      </div>
      <table id="attendanceTable">
        <thead>
          <tr>
            <th>D√≠a</th>
            <th>Entrada</th>
            <th>Salida</th>
            <th>Horas Trabajadas</th>
            <th>Observaciones</th>
            <th>Explicaci√≥n</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr class="attendance-summary">
            <td colspan="3" style="text-align: right;">Total Horas Trabajadas:</td>
            <td id="totalHorasCell">0.00</td>
            <td colspan="2"></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- N√ìMINA -->
  <div id="nomina" class="tab-content">
    <div class="profile-card">
      <h3>Historial de N√≥minas</h3>
      <table id="payrollTable">
        <thead>
          <tr>
            <th>Periodo</th>
            <th>Fecha de Pago</th>
            <th>Salario Bruto</th>
            <th>Deducciones Totales</th>
            <th>Salario Neto</th>
            <th>Estado</th>
            <th>Acci√≥n</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr class="payroll-summary">
            <td colspan="4" style="text-align: right;">Total Salario Neto:</td>
            <td id="totalSalarioCell">0.00 CFA</td>
            <td colspan="2"></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- PUESTO -->
  <div id="puesto" class="tab-content">
    <div class="profile-card">
      <div class="puesto-section">
        <h3>Descripci√≥n del Puesto</h3>
        <p id="job-description"></p>
      </div>
      <div class="puesto-section">
        <h3>Responsabilidades y Funciones</h3>
        <ul id="responsibilities-list"></ul>
      </div>
      <div class="puesto-section">
        <h3>Jerarqu√≠a Departamental</h3>
        <div id="hierarchy-map"></div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: JUSTIFICACI√ìN -->
<div id="justificationModal" class="modal">
  <div class="modal-content" style="width: 480px;">
    <span class="close-btn" onclick="closeJustificationModal()" style="float:right;cursor:pointer;font-size:20px;">&times;</span>
    <h3 id="justification-title">A√±adir Justificaci√≥n</h3>
    <textarea id="justification-text" style="width:100%;height:120px;margin-top:10px;"></textarea>
    <button id="save-justification-btn" class="btn" style="margin-top:10px;width:100%;">Guardar</button>
  </div>
</div>

<!-- MODAL: VISOR PDF DE N√ìMINA -->
<div id="pdfViewerModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closePdfViewerModal()" style="float:right;cursor:pointer;font-size:20px;">&times;</span>
    <h3 id="pdfViewerTitle" style="margin-top:0;">N√≥mina</h3>
    <iframe id="pdfViewer" src=""></iframe>
    <div style="margin-top:10px;display:flex;gap:10px;justify-content:flex-end;">
      <a id="downloadPdfButton" href="#" download class="btn">Descargar PDF</a>
      <button class="btn" onclick="closePdfViewerModal()">Cerrar</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast" class="toast">Justificaci√≥n guardada correctamente.</div>
{% endblock %}
{% block extra_scripts %}<script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
<script>
/* =============================================================
   üìÑ Mi Perfil ‚Äì Full Script
   -------------------------------------------------------------
   Encapsulated logic to avoid global conflicts.
   Uses Firebase app initialized in renderer.js (base.html).
==============================================================*/

// ---------------------- Loader Logic ------------------------
function showLoader(message = "Autenticando...") {
  const loader = document.getElementById("center-loader");
  const text = document.getElementById("center-loader-text");
  if (loader) loader.classList.add("visible");
  if (text) text.textContent = message;

  const animBox = document.getElementById("center-loader-animation");
  if (animBox && !animBox.dataset.initialized) {
    lottie.loadAnimation({
      container: animBox,
      renderer: "svg",
      loop: true,
      autoplay: true,
      path: "/static/assets/Loading sand clock.json",
    });
    animBox.dataset.initialized = "true";
  }
}

function hideLoader() {
  const loader = document.getElementById("center-loader");
  if (!loader) return;
  loader.style.transition = "opacity 0.8s ease";
  loader.style.opacity = "0";
  setTimeout(() => {
    loader.classList.remove("visible");
    loader.style.opacity = "1";
  }, 800);
}

// Startup loader
showLoader("Autenticando‚Ä¶");

// ---------------------- Main IIFE Logic ----------------------
(function () {
  // Wait for Firebase initialization
  function waitForFirebase() {
    return new Promise((resolve, reject) => {
      const start = Date.now();
      const check = () => {
        try {
          if (window.firebase && firebase.apps && firebase.apps.length && firebase.auth) {
            resolve(firebase.auth());
            return;
          }
        } catch (_) {}
        if (Date.now() - start > 7000) {
          reject(new Error("Firebase not loaded in time"));
        } else {
          setTimeout(check, 100);
        }
      };
      check();
    });
  }

  // -------------------- Async Scope -------------------------
  (async () => {
    let currentUserId = null;
    let firebaseIdToken = null;
    let employeeFullName = "Cargando...";

    // Wait for Firebase
    const auth = await waitForFirebase().catch(err => {
      console.error("üî• Firebase init failed:", err);
      const el = document.getElementById("auth-message");
      if (el) el.textContent = "Error cargando Firebase.";
      return null;
    });
    if (!auth) return;

    console.log("‚úÖ Firebase ready (Mi Perfil)");

    // -------------------- UI Helpers -------------------------
    window.openTab = function (event, tabName) {
      document.querySelectorAll(".tab-content").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".tab-link").forEach(l => l.classList.remove("active"));
      const target = document.getElementById(tabName);
      if (target) target.classList.add("active");
      if (event?.currentTarget) event.currentTarget.classList.add("active");
    };

    function showToast(msg) {
      const toast = document.getElementById("toast");
      if (!toast) return;
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    }

    function showAuthError(msg) {
      const el = document.getElementById("auth-message");
      if (el) {
        el.innerHTML = `<p style="color:red;">${msg}</p>`;
        el.style.display = "block";
      }
    }

    function animateCounter(id, finalValue, suffix = "", duration = 800) {
      const el = document.getElementById(id);
      if (!el) return;
      let start = 0;
      const stepTime = 20;
      const increment = finalValue / (duration / stepTime);
      const timer = setInterval(() => {
        start += increment;
        if (start >= finalValue) {
          start = finalValue;
          clearInterval(timer);
        }
        el.textContent = `${start.toFixed(2).toLocaleString("es-GQ")}${suffix}`;
      }, stepTime);
    }

    // -------------------- PERSONAL TAB -------------------------
    function populatePersonalTab(data) {
      const grid = document.getElementById("personal-details-grid");
      if (!grid) return;
      grid.innerHTML = "";
      const fields = {
        "Email Personal": data.email_personal,
        "Tel√©fono Personal": data.telefono_personal,
        "Direcci√≥n": data.direccion,
        "Fecha de Nacimiento": data.fecha_nacimiento,
        "Edad": data.edad,
        "Estado Civil": data.estado_civil,
        "Sexo": data.sexo,
        "Dependientes": data.dependientes,
        "Nacionalidad": data.nacionalidad,
        "Natural de": data.natural_de,
        "DIP": data.dip_numero,
        "Pasaporte": data.pasaporte_numero,
      };
      for (const [label, value] of Object.entries(fields)) {
        const item = document.createElement("div");
        item.className = "detail-item";
        item.innerHTML = `<strong>${label}</strong><span>${value || "---"}</span>`;
        grid.appendChild(item);
      }
    }

/* ======================================================
   üìÖ YEAR & MONTH DROPDOWNS (AUTO-REFRESH ENABLED)
====================================================== */
function populateYearAndMonthDropdowns() {
  const yearSel = document.getElementById("yearSelect");
  const monthSel = document.getElementById("monthSelect");

  if (!yearSel || !monthSel) {
    console.warn("‚ö†Ô∏è Dropdowns not found in DOM.");
    return;
  }

  // --- Years ---
  const currentYear = new Date().getFullYear();
  if (yearSel.options.length === 0) {
    for (let y = currentYear; y >= currentYear - 5; y--) {
      const opt = document.createElement("option");
      opt.value = String(y);
      opt.textContent = String(y);
      yearSel.appendChild(opt);
    }
  }
  yearSel.value = String(currentYear);

  // --- Months ---
  const months = [
    "enero","febrero","marzo","abril","mayo","junio",
    "julio","agosto","septiembre","octubre","noviembre","diciembre"
  ];
  const currentMonth = new Date().getMonth() + 1;
  if (monthSel.options.length === 0) {
    months.forEach((m, i) => {
      const opt = document.createElement("option");
      opt.value = String(i + 1).padStart(2, "0");
      opt.textContent = m.charAt(0).toUpperCase() + m.slice(1);
      monthSel.appendChild(opt);
    });
  }
  monthSel.value = String(currentMonth).padStart(2, "0");

  console.log(`‚úÖ Dropdowns ready ‚Üí A√±o=${yearSel.value}, Mes=${monthSel.value}`);
}

/* ======================================================
   üìä LOAD ATTENDANCE (Final Clean & Compact)
====================================================== */
async function loadMyAttendance() {
  const yearSel = document.getElementById("yearSelect");
  const monthSel = document.getElementById("monthSelect");
  const tbody = document.querySelector("#attendanceTable tbody");
  const totalCell = document.getElementById("totalHorasCell");

  if (!yearSel || !monthSel || !tbody) return;

  const empId = window.currentEmployeeId || null;
  if (!empId) {
    console.warn("‚ö†Ô∏è No employee ID loaded yet");
    return;
  }

  tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;">Cargando asistencia...</td></tr>`;

  try {
    const year = yearSel.value;
    const monthName = monthSel.options[monthSel.selectedIndex].text.toLowerCase();

    const res = await fetch(`/attendance?employee_id=${empId}&year=${year}&month=${monthName}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    if (data.status !== "success") throw new Error(data.message || "Unknown error");

    const days = data.days || {};
    tbody.innerHTML = "";

    // --- monthly totals ---
    let horasTrabajadasMes = 0;
    let horasEsperadasMes = 0;
    let diasCompletosMes = 0;
    let diasIncompletosMes = 0;
    let diasTardeMes = 0;
    let diasAusenteMes = 0;

    const parseTS = (v) => {
      if (!v) return null;
      const s = String(v).trim();
      if (s === "-" || s === "‚Äì") return null;
      return new Date(s.includes("T") ? s : s.replace(" ", "T"));
    };

    Object.keys(days)
      .sort((a, b) => Number(a) - Number(b))
      .forEach((day) => {
        const r = days[day] || {};
        const entradaDT = parseTS(r.hora_entrada || r.HORA_DE_ENTRADA);
        const salidaDT = parseTS(r.hora_salida || r.HORA_DE_SALIDA);
        const obs = r.observaciones || r.OBSERVACION || "‚Äî";
        const justific = r.justificacion || r.explicacion || r.EXPLICACION || "‚Äî";

        const dateObj = new Date(`${year}-${monthSel.value}-${String(day).padStart(2, "0")}T00:00:00`);
        const weekday = dateObj.getDay();
        let expected = 0;
        if (weekday >= 1 && weekday <= 4) expected = 7.5;
        else if (weekday === 5) expected = 4.5;

        let worked = 0;
        if (entradaDT && salidaDT) {
          const diffMs = salidaDT - entradaDT;
          if (diffMs > 0) worked = diffMs / (1000 * 60 * 60);
        }

        let estatus = "‚Äî";
        if (!entradaDT && !salidaDT) estatus = "AUSENCIA INJUSTIFICADA";
        else if (entradaDT && !salidaDT) estatus = "JORNADA INCOMPLETA";
        else if (worked >= expected - 0.25) estatus = "COMPLETO";
        else if (worked > 0 && worked < expected - 0.25) estatus = "INCOMPLETO";

        if (entradaDT) {
          const hEnt = entradaDT.getHours();
          const mEnt = entradaDT.getMinutes();
          if (hEnt > 9 || (hEnt === 9 && mEnt > 45)) estatus = "TARDE";
        }

        let statusClass = "status-default";
        if (estatus === "COMPLETO") statusClass = "status-completo";
        else if (estatus === "INCOMPLETO") statusClass = "status-incompleto";
        else if (estatus === "TARDE") statusClass = "status-tarde";
        else if (estatus === "AUSENCIA INJUSTIFICADA") statusClass = "status-ausencia";
        else if (estatus === "JORNADA INCOMPLETA") statusClass = "status-jornada";

        horasTrabajadasMes += worked;
        horasEsperadasMes += expected;
        if (estatus === "COMPLETO") diasCompletosMes++;
        if (estatus === "INCOMPLETO" || estatus === "JORNADA INCOMPLETA") diasIncompletosMes++;
        if (estatus === "TARDE") diasTardeMes++;
        if (estatus === "AUSENCIA INJUSTIFICADA") diasAusenteMes++;

        const entradaTxt = entradaDT ? entradaDT.toISOString().replace("T", " ").slice(0, 19) : "--";
        const salidaTxt = salidaDT ? salidaDT.toISOString().replace("T", " ").slice(0, 19) : "--";
        const workedStr = worked > 0 ? worked.toFixed(2) : "0.00";

        const row = document.createElement("tr");
        row.dataset.date = `${year}-${monthSel.value}-${String(day).padStart(2, "0")}`;
        row.innerHTML = `
          <td>${day}</td>
          <td>${entradaTxt}</td>
          <td>${salidaTxt}</td>
          <td>${workedStr}</td>
          <td><span class="status-cell ${statusClass}">${estatus}</span></td>
          <td class="justificacion-cell">${justific}</td>
        `;
        tbody.appendChild(row);
      });

    totalCell.textContent = horasTrabajadasMes.toFixed(2);
    const porcentaje = horasEsperadasMes > 0 ? (horasTrabajadasMes / horasEsperadasMes) * 100 : 0;

    // --- Clean up duplicate static bars ---
    document.querySelectorAll(".redundant-progress").forEach((el) => el.remove());

    // --- Build single clean top row ---
    let summaryRow = document.getElementById("attendanceTopSummary");
    if (!summaryRow) {
      const parent = document.querySelector("#attendanceFilters") || document.querySelector("#monthSelect").closest("div");
      summaryRow = document.createElement("div");
      summaryRow.id = "attendanceTopSummary";
      summaryRow.style.cssText = `
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-top: 10px;
        margin-bottom: 10px;
        gap: 20px;
        flex-wrap: wrap;
      `;
      parent.insertAdjacentElement("afterend", summaryRow);
    }

    // --- Left: Cumplimiento Bar ---
    let barContainer = document.getElementById("cumplimientoContainer");
    if (!barContainer) {
      barContainer = document.createElement("div");
      barContainer.id = "cumplimientoContainer";
      barContainer.style.cssText = `
        flex: 1;
        min-width: 280px;
      `;
      summaryRow.appendChild(barContainer);
    }

    barContainer.innerHTML = `
      <div style="font-weight:600;color:#004080;">Cumplimiento Mensual</div>
      <div style="background:#e5e7eb;border-radius:6px;overflow:hidden;height:10px;margin-top:4px;">
        <div id="progressBarInner" style="width:0%;height:100%;background:#16a34a;transition:width 0.5s;"></div>
      </div>
      <div id="progressPercent" style="font-size:13px;color:#333;margin-top:4px;">0%</div>
    `;

    // --- Right: Compact Resumen ---
    let resumenContainer = document.getElementById("miniResumenCard");
    if (!resumenContainer) {
      resumenContainer = document.createElement("div");
      resumenContainer.id = "miniResumenCard";
      resumenContainer.className = "card resumen-mini";
      resumenContainer.style.cssText = `
        flex: 0 0 320px;
        background: #ffffff;
        border: 1px solid #ccc;
        border-radius: 10px;
        padding: 14px 18px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        font-size: 13px;
      `;
      summaryRow.appendChild(resumenContainer);
    }

    resumenContainer.innerHTML = `
      <h4 style="margin:0 0 6px 0;font-size:15px;font-weight:600;color:#004080;">Resumen Mensual</h4>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);column-gap:10px;row-gap:4px;">
        <div><strong>Horas Trabajadas:</strong> ${horasTrabajadasMes.toFixed(2)}</div>
        <div><strong>Horas Esperadas:</strong> ${horasEsperadasMes.toFixed(2)}</div>
        <div><strong>D√≠as Completos:</strong> ${diasCompletosMes}</div>
        <div><strong>Incompletos:</strong> ${diasIncompletosMes}</div>
        <div><strong>Tardanzas:</strong> ${diasTardeMes}</div>
        <div><strong>Ausencias:</strong> ${diasAusenteMes}</div>
        <div style="grid-column: span 2; border-top: 1px solid #ddd; margin-top:4px; padding-top:4px;">
          <strong>% Cumplimiento:</strong> ${porcentaje.toFixed(1)}%
        </div>
      </div>
    `;

    // --- Update Bar ---
    const bar = document.getElementById("progressBarInner");
    const pct = document.getElementById("progressPercent");
    if (bar && pct) {
      bar.style.width = `${Math.min(porcentaje, 100).toFixed(1)}%`;
      pct.textContent = `${porcentaje.toFixed(1)}%`;
      bar.style.backgroundColor =
        porcentaje >= 95 ? "#16a34a" :
        porcentaje >= 75 ? "#f59e0b" : "#dc2626";
    }

    // --- Editable Justifications (same as before) ---
    const today = new Date();
    document.querySelectorAll(".justificacion-cell").forEach((cell) => {
      const row = cell.closest("tr");
      const dateStr = row?.dataset?.date;
      if (!dateStr) return;
      const recordDate = new Date(dateStr);
      const diffDays = (today - recordDate) / (1000 * 60 * 60 * 24);
      const isLocked = diffDays > 7;
      if (isLocked) {
        cell.style.opacity = "0.6";
        cell.style.cursor = "not-allowed";
        cell.title = "Edici√≥n bloqueada (m√°s de 7 d√≠as)";
        return;
      }

      cell.addEventListener("dblclick", () => {
        const oldVal = cell.textContent.trim();
        cell.innerHTML = "";

        const select = document.createElement("select");
        select.style.width = "95%";
        select.style.fontSize = "13px";
        select.style.borderRadius = "4px";
        select.innerHTML = `
          <option value="">Seleccione motivo</option>
          <option value="Emergencia">Emergencia</option>
          <option value="Imprevisto">Imprevisto</option>
          <option value="Enfermedad">Enfermedad</option>
          <option value="Permiso Reglamentario">Permiso Reglamentario</option>
          <option value="Otro">Otro</option>
        `;
        cell.appendChild(select);
        select.focus();

        let input = null;
        select.addEventListener("change", () => {
          if (select.value === "Otro") {
            input = document.createElement("input");
            input.type = "text";
            input.placeholder = "Especifique...";
            input.style.width = "95%";
            input.style.marginTop = "4px";
            input.style.fontSize = "13px";
            cell.appendChild(input);
            input.focus();
          } else if (input) {
            input.remove();
            input = null;
          }
        });

        const saveValue = async () => {
          const justification =
            select.value === "Otro" && input ? input.value.trim() : select.value;
          cell.textContent = justification || oldVal || "‚Äî";
          if (!justification || justification === oldVal) return;

          try {
            const res = await fetch("/attendance/update", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                employee_id: empId,
                year,
                month: monthName,
                day,
                justificacion: justification
              }),
            });
            const data = await res.json();
            if (data.status === "success") showToast("Justificaci√≥n guardada correctamente.");
            else alert("Error al guardar la justificaci√≥n.");
          } catch (err) {
            console.error("‚ùå Error guardando justificaci√≥n:", err);
            alert("No se pudo guardar la justificaci√≥n.");
          }
        };

        select.addEventListener("blur", saveValue);
        if (input) input.addEventListener("blur", saveValue);
      });
    });

  } catch (err) {
    console.error("‚ùå Error al cargar asistencia:", err);
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:red;">Error al cargar asistencia.</td></tr>`;
  }
}



/* ======================================================
   ‚úèÔ∏è INLINE OBSERVATION HANDLERS (dblclick edit + 7-day lock)
====================================================== */
function attachObservationHandlers() {
  const today = new Date();

  document.querySelectorAll("#attendanceTable td.observaciones").forEach(cell => {
    const row = cell.closest("tr");
    const dateStr = row?.dataset?.date;
    if (!dateStr) return;

    const recordDate = new Date(dateStr);
    const diffDays = (today - recordDate) / (1000 * 60 * 60 * 24);
    const isLocked = diffDays > 7; // üîí lock after 7 days

    if (isLocked) {
      cell.style.opacity = "0.6";
      cell.style.cursor = "not-allowed";
      cell.title = "Edici√≥n bloqueada (m√°s de 7 d√≠as)";
      return; // skip attaching double-click
    }

    cell.addEventListener("dblclick", () => {
      const oldValue = cell.textContent.trim();
      const input = document.createElement("input");
      input.type = "text";
      input.value = oldValue === "‚Äî" ? "" : oldValue;
      input.style.width = "95%";
      input.style.fontSize = "13px";
      input.style.border = "1px solid #ccc";
      input.style.borderRadius = "4px";
      cell.innerHTML = "";
      cell.appendChild(input);
      input.focus();

      input.addEventListener("blur", async () => {
        const newVal = input.value.trim();
        cell.textContent = newVal || "‚Äî";
        if (newVal !== oldValue) {
          const empId = window.currentUserId;
          const date = row.dataset.date;
          try {
            const res = await fetch("/api/attendance/justification", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                employee_id: empId,
                date: date,
                justification: newVal,
              }),
            });
            const data = await res.json();
            if (data.status === "success") {
              showToast("Observaci√≥n guardada correctamente.");
            } else {
              alert("Error al guardar la observaci√≥n: " + data.message);
            }
          } catch (err) {
            console.error("‚ùå Error guardando observaci√≥n:", err);
            alert("No se pudo guardar la observaci√≥n.");
          }
        }
      });
    });
  });
}

/* ======================================================
   üßæ JUSTIFICATION MODAL (Stable + Safe)
====================================================== */
let currentEdit = {};

function openJustificationModal(empId, year, month, day) {
  currentEdit = { empId, year, month, day };

  const modal = document.getElementById("justificationModal");
  const title = document.getElementById("justification-title");
  const textarea = document.getElementById("justification-text");

  // Clean old dropdown
  document.getElementById("observacionSelect")?.remove();

  // Add dropdown right above the textarea
  const dropdown = document.createElement("select");
  dropdown.id = "observacionSelect";
  dropdown.style.cssText = "width:100%;margin-top:5px;margin-bottom:10px;";
  dropdown.innerHTML = `
    <option value="">Seleccione observaci√≥n</option>
    <option value="Presente">Presente</option>
    <option value="Llegada tarde">Llegada tarde</option>
    <option value="Ausencia justificada">Ausencia justificada</option>
    <option value="Ausencia no justificada">Ausencia no justificada</option>
    <option value="Permiso">Permiso</option>
    <option value="Vacaciones">Vacaciones</option>
  `;
  textarea.insertAdjacentElement("beforebegin", dropdown);

  textarea.value = "";
  title.textContent = `A√±adir Justificaci√≥n ‚Äî D√≠a ${day}`;
  modal.style.display = "flex";
}

function closeJustificationModal() {
  const modal = document.getElementById("justificationModal");
  modal.style.display = "none";
  document.getElementById("observacionSelect")?.remove();
}
window.closeJustificationModal = closeJustificationModal;  // ‚úÖ Make it visible to inline onclick


document.getElementById("save-justification-btn").addEventListener("click", async () => {
  const justification = document.getElementById("justification-text").value.trim();
  const observation = document.getElementById("observacionSelect")?.value || "";

  if (!justification && !observation) {
    alert("Debe escribir una justificaci√≥n o seleccionar una observaci√≥n.");
    return;
  }

  try {
    const res = await fetch("/api/attendance/justification", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        employee_id: currentEdit.empId,
        date: `${currentEdit.year}-${String(monthToNumber(currentEdit.month)).padStart(2,"0")}-${String(currentEdit.day).padStart(2,"0")}`,
        justification,
        observation
      })
    });

    const data = await res.json();
    if (data.status === "success") {
      showToast("Justificaci√≥n guardada correctamente.");
      closeJustificationModal();
      loadMyAttendance();
    } else {
      alert("Error al guardar la justificaci√≥n: " + data.message);
    }
  } catch (err) {
    console.error("‚ùå Error guardando justificaci√≥n:", err);
    alert("No se pudo guardar la justificaci√≥n.");
  }
});

// Helper: convert "enero" ‚Üí 1, etc.
function monthToNumber(monthName) {
  const months = {
    enero: 1, febrero: 2, marzo: 3, abril: 4, mayo: 5, junio: 6,
    julio: 7, agosto: 8, septiembre: 9, octubre: 10, noviembre: 11, diciembre: 12
  };
  return months[monthName.toLowerCase()] || 1;
}


document.getElementById("save-justification-btn").addEventListener("click", async () => {
  const text = document.getElementById("justification-text").value.trim();
  const obs = document.getElementById("observacionSelect")?.value || "";

  if (!text && !obs) {
    alert("Debe escribir una justificaci√≥n o seleccionar una observaci√≥n.");
    return;
  }

  try {
    const res = await fetch("/attendance/update", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        employee_id: currentEdit.empId,
        year: currentEdit.year,
        month: currentEdit.month,
        day: currentEdit.day,
        explicacion: text,
        observacion: obs
      })
    });

    const data = await res.json();
    if (data.status === "success") {
      showToast("Justificaci√≥n guardada correctamente.");
      closeJustificationModal();
      loadMyAttendance(); // Refresh the table
    } else {
      alert("Error al guardar la justificaci√≥n.");
    }
  } catch (err) {
    console.error("‚ùå Error guardando justificaci√≥n:", err);
    alert("No se pudo guardar la justificaci√≥n.");
  }
});


/* ======================================================
   üß≠ LOAD JOB / POSITION TAB (ATiempo - CONSEJERO DELEGADO)
====================================================== */
function populateJobTab(data = {}) {
  const descEl = document.getElementById("job-description");
  const respEl = document.getElementById("responsibilities-list");
  const hierEl = document.getElementById("hierarchy-map");

  if (!descEl || !respEl || !hierEl) return;

  // --- Company Context: ATiempo ---
  const puesto = (data.puesto || document.getElementById("detail_puesto")?.textContent || "").toLowerCase();

  // --- Specific role: Consejero Delegado ---
  const mock = {
    descripcion:
      "El Consejero Delegado de ATiempo es el m√°ximo responsable ejecutivo de la compa√±√≠a. Dirige las operaciones generales, la estrategia tecnol√≥gica y comercial, y garantiza el crecimiento sostenible del ecosistema digital de la empresa. Supervisa la ejecuci√≥n de proyectos de software, el cumplimiento de objetivos financieros y la expansi√≥n de la marca ATiempo en los mercados internacionales.",
    funciones: [
      "Definir y ejecutar la estrategia general de ATiempo en coordinaci√≥n con el Consejo de Administraci√≥n.",
      "Liderar el desarrollo de productos tecnol√≥gicos innovadores y garantizar su calidad, seguridad y escalabilidad.",
      "Supervisar los departamentos de ingenier√≠a, finanzas, marketing y soporte t√©cnico.",
      "Promover alianzas estrat√©gicas con entidades p√∫blicas y privadas para la adopci√≥n del software ATiempo.",
      "Velar por la cultura corporativa, el cumplimiento de normas internas y la motivaci√≥n del equipo de trabajo.",
      "Representar oficialmente a la empresa ante clientes, socios tecnol√≥gicos e instituciones gubernamentales.",
    ],
    jerarquia: [
      { nivel: "Consejo de Administraci√≥n", superior: "Accionistas principales de ATiempo S.A." },
      { nivel: "Consejero Delegado (CEO)", superior: "Consejo de Administraci√≥n" },
      { nivel: "Directores de √Årea (CTO, CFO, COO, CMO)", superior: "Consejero Delegado" },
      { nivel: "Responsables de Proyecto / Ingenieros L√≠deres", superior: "Directores de √Årea" },
      { nivel: "Equipo T√©cnico y de Soporte", superior: "Responsables de Proyecto" },
    ],
  };

  // --- Render to DOM ---
  descEl.textContent = mock.descripcion;

  respEl.innerHTML = "";
  mock.funciones.forEach(f => {
    const li = document.createElement("li");
    li.textContent = f;
    respEl.appendChild(li);
  });

  hierEl.innerHTML = "";
  mock.jerarquia.forEach(j => {
    const div = document.createElement("div");
    div.className = "hierarchy-item";
    div.innerHTML = `<strong>${j.nivel}</strong> <span style="color:#555;">‚Üí ${j.superior}</span>`;
    hierEl.appendChild(div);
  });

  console.log("‚úÖ Mi Puesto: Consejero Delegado de ATiempo cargado correctamente.");
}

/* ======================================================
   üß© INIT: Populate dropdowns + Auto-reload setup
====================================================== */
function initAttendanceUI() {
  populateYearAndMonthDropdowns();


  const yearSel  = document.getElementById("yearSelect");
  const monthSel = document.getElementById("monthSelect");

  if (yearSel)  yearSel.addEventListener("change", loadMyAttendance);
  if (monthSel) monthSel.addEventListener("change", loadMyAttendance);
}

// Run immediately if DOM is ready; otherwise wait
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", initAttendanceUI);
} else {
  initAttendanceUI();
}

       function closePdfViewerModal() {
      const modal = document.getElementById("pdfViewerModal");
      const iframe = document.getElementById("pdfViewer");
      if (iframe) iframe.src = "";
      if (modal) modal.style.display = "none";
    }


    // -------------------- PAYROLL -------------------------
/* =========================================================
   üßæ LOAD PAYROLL + FRONT-END MONTH FILTER
========================================================= */
async function loadMyPayroll() {
  if (!firebaseIdToken) return;
  const tbody = document.querySelector("#payrollTable tbody");
  const totalCell = document.getElementById("totalSalarioCell");
  if (!tbody) return;

  tbody.innerHTML = "<tr><td colspan='7'>Cargando n√≥minas...</td></tr>";

  try {
    const res = await fetch("/api/me/payroll", {
      headers: { Authorization: `Bearer ${firebaseIdToken}` },
    });
    const data = await res.json();
    tbody.innerHTML = "";

    if (data.status !== "success" || !Array.isArray(data.payroll) || data.payroll.length === 0) {
      tbody.innerHTML = "<tr><td colspan='7'>No hay n√≥minas disponibles.</td></tr>";
      animateCounter("totalSalarioCell", 0, " CFA", 600);
      return;
    }

    // ‚úÖ Inject random deductions if missing
    data.payroll.forEach(slip => {
      if (!slip.deducciones) slip.deducciones = {};
      if (!slip.deducciones.seguridad_social) slip.deducciones.seguridad_social = Math.random() * 25000 + 10000;
      if (!slip.deducciones.iprf) slip.deducciones.iprf = Math.random() * 35000 + 5000;
      if (!slip.deducciones.otros) slip.deducciones.otros = Math.random() * 15000;

      const totalDeds = slip.deducciones.seguridad_social + slip.deducciones.iprf + slip.deducciones.otros;
      if (!slip.salario_bruto) slip.salario_bruto = slip.salario_neto ? slip.salario_neto + totalDeds : 250000 + Math.random() * 200000;
      if (!slip.salario_neto) slip.salario_neto = slip.salario_bruto - totalDeds;
    });

    // ‚úÖ Sort latest first
    data.payroll.sort((a, b) => new Date(b.fecha_pago) - new Date(a.fecha_pago));

    // ‚úÖ Build month filter
    buildPayrollMonthDropdown(data.payroll);

    // ‚úÖ Render rows initially (no filter ‚Üí show all)
    renderPayrollTable(data.payroll);

  } catch (err) {
    console.error("Error fetching payroll:", err);
    tbody.innerHTML = "<tr><td colspan='7' style='color:red;'>Error al cargar n√≥minas.</td></tr>";
  }
}

/* =========================================================
   üîΩ MONTH FILTER UI + LOGIC
========================================================= */
function buildPayrollMonthDropdown(payrollList) {
  // Remove old if exists
  document.getElementById("monthPayrollFilter")?.remove();

  // Build unique months
  const months = Array.from(
    new Set(
      payrollList
        .map(p => p.periodo)
        .filter(Boolean)
    )
  );

  if (months.length === 0) return;

  const filterGroup = document.createElement("div");
  filterGroup.style.cssText = "display:flex;justify-content:flex-end;margin-top:10px;margin-bottom:-10px;";
  filterGroup.innerHTML = `
    <label for="monthPayrollFilter" style="margin-right:8px;font-weight:600;">Filtrar por periodo:</label>
    <select id="monthPayrollFilter" style="padding:5px 10px;border-radius:6px;">
      <option value="all">Todos</option>
      ${months.map(m => `<option value="${m}">${m}</option>`).join("")}
    </select>
  `;
  const table = document.getElementById("payrollTable");
  table.insertAdjacentElement("beforebegin", filterGroup);

  // Attach listener
  document.getElementById("monthPayrollFilter").addEventListener("change", e => {
    const selected = e.target.value;
    const filtered = selected === "all" ? payrollList : payrollList.filter(p => p.periodo === selected);
    renderPayrollTable(filtered);
  });
}

/* =========================================================
   üßÆ RENDER TABLE + SUM NETO
========================================================= */
function renderPayrollTable(payrollList) {
  const tbody = document.querySelector("#payrollTable tbody");
  const totalCell = document.getElementById("totalSalarioCell");
  tbody.innerHTML = "";

  let totalNeto = 0;
  payrollList.forEach(slip => {
    totalNeto += parseFloat(slip.salario_neto || 0);
    renderPayrollRow(slip, tbody);
  });

  animateCounter("totalSalarioCell", totalNeto, " CFA", 800);
}

/* =========================================================
   üßæ SINGLE ROW RENDERING (unchanged except visual)
========================================================= */
function renderPayrollRow(slip, tableBody) {
  const bruto = parseFloat(slip.salario_bruto || 0).toLocaleString("es-GQ", { minimumFractionDigits: 2 });
  const neto = parseFloat(slip.salario_neto || 0).toLocaleString("es-GQ", { minimumFractionDigits: 2 });
  const ss = parseFloat(slip.deducciones?.seguridad_social || 0);
  const irpf = parseFloat(slip.deducciones?.iprf || 0);
  const otros = parseFloat(slip.deducciones?.otros || 0);
  const totalDeducciones = (ss + irpf + otros).toLocaleString("es-GQ", { minimumFractionDigits: 2 });

  const statusText = slip.pagado ? "PAGADO" : "PENDIENTE";
  const statusClass = slip.pagado ? "status-completo" : "status-incompleto";

  const row = document.createElement("tr");
  row.innerHTML = `
    <td>${slip.periodo || "--"}</td>
    <td>${slip.fecha_pago || "--"}</td>
    <td>FCFA ${bruto}</td>
    <td>FCFA ${totalDeducciones}</td>
    <td>FCFA ${neto}</td>
    <td><span class="status-chip ${statusClass}">${statusText}</span></td>
    <td><button class="btn-pdf">Ver</button></td>
  `;

  const btn = row.querySelector(".btn-pdf");
  btn.addEventListener("click", () => viewPayroll(slip));

  tableBody.appendChild(row);
}

/* ============================
   N√ìMINA TABLE & PDF VIEWER
============================ */

/**
 * Renders one payroll row safely and attaches event listener for PDF preview
 */
function renderPayrollRow(slip, tableBody) {
  const bruto = parseFloat(slip.salario_bruto || 0).toLocaleString("es-GQ", { minimumFractionDigits: 2 });
  const neto = parseFloat(slip.salario_neto || 0).toLocaleString("es-GQ", { minimumFractionDigits: 2 });
  const ss = parseFloat(slip.deducciones?.seguridad_social || 0);
  const irpf = parseFloat(slip.deducciones?.iprf || 0);
  const otros = parseFloat(slip.deducciones?.otros || 0);
  const totalDeducciones = (ss + irpf + otros).toLocaleString("es-GQ", { minimumFractionDigits: 2 });

  const statusText = slip.pagado ? "PAGADO" : "PENDIENTE";
  const statusClass = slip.pagado ? "status-completo" : "status-incompleto";

  // ‚úÖ Build row normally
  const row = document.createElement("tr");
  row.innerHTML = `
    <td>${slip.periodo || "--"}</td>
    <td>${slip.fecha_pago || "--"}</td>
    <td>FCFA ${bruto}</td>
    <td>FCFA ${totalDeducciones}</td>
    <td>FCFA ${neto}</td>
    <td><span class="status-chip ${statusClass}">${statusText}</span></td>
    <td><button class="btn-pdf">Ver</button></td>
  `;

  // ‚úÖ Attach JS listener instead of inline JSON
  const btn = row.querySelector(".btn-pdf");
  btn.addEventListener("click", () => viewPayroll(slip));

  tableBody.appendChild(row);
}

/**
 * Opens the PDF preview for a given payroll slip
 */
async function viewPayroll(slip) {
  try {
    closePdfViewerModal(); // clear any previous preview

    // ‚úÖ Include robust fallbacks
    const empId = slip.employee_id || slip.emp_id || slip.id || currentUserId || "";
    const period = slip.periodo || slip.period || "";
    if (!empId || !period) {
      alert("No se pudo determinar el empleado o el periodo de la n√≥mina.");
      console.warn("Invalid slip object:", slip);
      return;
    }

    const pdfUrl = `/api/payroll/pdf/${encodeURIComponent(empId)}/${encodeURIComponent(period)}`;
    console.log("üìÑ Fetching payroll PDF:", pdfUrl);

    const res = await fetch(pdfUrl, { headers: { Authorization: `Bearer ${firebaseIdToken}` } });
    if (!res.ok) {
      console.error("‚ùå Error al obtener PDF:", res.status);
      alert("No se pudo cargar la n√≥mina. Verifique su conexi√≥n o permisos.");
      return;
    }

    // ‚úÖ Create object URL and assign
    const blob = await res.blob();
    const objectUrl = URL.createObjectURL(blob);

    const iframe = document.getElementById("pdfViewer");
    const title = document.getElementById("pdfViewerTitle");
    const downloadBtn = document.getElementById("downloadPdfButton");
    const modal = document.getElementById("pdfViewerModal");

    if (iframe) iframe.src = objectUrl;
    if (title) title.textContent = `N√≥mina - ${period}`;
    if (downloadBtn) {
      downloadBtn.href = objectUrl;
      downloadBtn.download = `nomina_${(slip.employee_name || "empleado").replace(/\s+/g, "_")}_${period}.pdf`;
    }
    if (modal) modal.style.display = "flex";

  } catch (err) {
    console.error("‚ùå Error mostrando n√≥mina:", err);
    alert("Ocurri√≥ un error al abrir la vista previa de la n√≥mina.");
  }
}

    // -------------------- AUTH & PROFILE -------------------------
    auth.onAuthStateChanged(async user => {
      showLoader();
      if (user) {
        try {
          firebaseIdToken = await user.getIdToken();
          await loadUserProfile(user);
          hideLoader();
        } catch (e) {
          console.error("Error loading profile:", e);
          showAuthError("Error cargando el perfil: " + e.message);
        }
      }
    });

    async function loadUserProfile(user) {
  const res = await fetch("/api/me", { headers: { Authorization: `Bearer ${firebaseIdToken}` } });
  const data = await res.json();
  if (data.status !== "success") throw new Error(data.message);

  currentUserId = data.id;
  window.currentEmployeeId = data.id; // ‚úÖ ensures it's set globally
  employeeFullName = data.nombre_completo || "---";

  document.getElementById("detail_photo").src = data.url_foto || "https://placehold.co/120";
  document.getElementById("detail_nombre_completo").textContent = employeeFullName;
  document.getElementById("detail_puesto").textContent = data.puesto || "---";

  populatePersonalTab(data);
  populateJobTab(data.puesto_info);

  // ‚úÖ Wait briefly before loading attendance
  setTimeout(async () => {
    console.log("üìÖ Loading attendance for:", window.currentEmployeeId);
    await loadMyAttendance();
    await loadMyPayroll();
  }, 500);

  document.getElementById("auth-message").style.display = "none";
  document.getElementById("profile-content").style.display = "block";
}


    // Make available to HTML
    window.closePdfViewerModal = closePdfViewerModal;
  })(); // <-- end async IIFE
})();   // <-- end outer wrapper
</script>

{{ super() }}
<script src="{{ url_for('static', filename='js/renderer.js') }}"></script>
{% endblock %}
