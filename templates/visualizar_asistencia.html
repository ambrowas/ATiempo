{% extends "base.html" %}
{% block title %}Informes de Asistencia - ATiempo{% endblock %}
{% block page_title %}INFORMES DE ASISTENCIA{% endblock %}
{% block extra_styles %}
<style>
  .filters {
    background: #fff;
    padding: 15px;
    border: 2px solid black;
    border-radius: 8px;
    margin-bottom: 25px;
  }

  .filter-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    flex-wrap: wrap;
    gap: 20px;
  }

  .filter-group {
    display: flex;
    align-items: flex-end;
    gap: 15px;
    flex-wrap: wrap;
  }

  label {
    font-size: 13px;
    font-weight: bold;
    color: #333;
  }

  select {
    padding: 8px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 6px;
  }

  .actions button {
    padding: 8px 12px;
    font-size: 14px;
    background-color: #004080;
    color: white;
    border: 2px solid black;
    border-radius: 4px;
    cursor: pointer;
    height: 38px;
  }

  .summary-wrapper {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 25px;
  }

  .summary-box {
    background: white;
    border: 2px solid black;
    border-radius: 8px;
    padding: 20px;
    flex: 1;
    min-width: 320px;
    text-align: center;
  }

  .photo-placeholder {
    width: 160px;
    height: 160px;
    background: #eee;
    border-radius: 50%;
    overflow: hidden;
    margin: auto;
  }

  .photo-placeholder img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  #attendanceChart {
    max-width: 100%;
    max-height: 220px;
    margin: auto;
  }

  #attendanceTable {
    width: 100%;
    border-collapse: collapse;
    background: white;
    font-size: 13px;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  }

  #attendanceTable th {
    background-color: #004080;
    color: white;
    padding: 10px;
  }

  #attendanceTable td {
    border-bottom: 1px solid #ddd;
    padding: 8px;
    text-align: center;
  }

  #attendanceTable tr:nth-child(even) {
    background: #f9f9f9;
  }

  .chip {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 12px;
    font-weight: bold;
    color: white;
    font-size: 12px;
  }
  /* =========================
   TOP SUMMARY CARDS
========================= */
.summary-wrapper {
  display: flex;
  justify-content: space-between;
  align-items: stretch;
  gap: 20px;
  margin: 15px 0 25px 0;
}

.summary-box {
  background: #ffffff;
  border: 2px solid #000;
  border-radius: 12px;
  box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  padding: 25px;
  transition: transform 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.summary-box:hover {
  transform: translateY(-4px);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

/* Employee Photo Card */
.summary-box .photo-placeholder {
  width: 150px;
  height: 150px;
  border-radius: 50%;
  border: 3px solid #004080;
  overflow: hidden;
  margin-bottom: 10px;
}

.summary-box .photo-placeholder img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* Employee name and position */
.employee-info h3 {
  font-size: 18px;
  margin: 6px 0 2px;
  color: #000;
}

.employee-info p {
  font-size: 14px;
  color: #555;
  margin: 0;
}

/* Pie Chart */
#attendanceChart {
  max-width: 260px;
  max-height: 260px;
}

/* Summary Table */
#summaryTable {
  border-collapse: collapse;
  width: 100%;
  font-size: 13px;
}

#summaryTable th {
  background-color: #004080;
  color: #fff;
  text-transform: uppercase;
  font-size: 13px;
  padding: 8px;
}

#summaryTable td {
  border: 1px solid #ccc;
  padding: 6px 8px;
  text-align: center;
}

#summaryTable td:nth-child(1) {
  text-align: left;
}

#summaryTable td.green { color: #28a745; font-weight: bold; }
#summaryTable td.yellow { color: #f0ad4e; font-weight: bold; }
#summaryTable td.red { color: #dc3545; font-weight: bold; }


  .chip.success { background: #28a745; }
  .chip.warning { background: #f0ad4e; }
  .chip.danger { background: #dc3545; }

  /* ======================================================
   游 FULL-WIDTH SCROLLABLE ATTENDANCE TABLE
====================================================== */
#attendanceTableWrapper {
  width: 100%;
  max-width: 100%;
  max-height: calc(100vh - 350px); /* 游댢 expands until just above the footer */
  overflow-y: auto;
  overflow-x: auto;  /* allows horizontal scroll if needed */
  background: #ffffff;
  border: 2px solid black;
  border-radius: 12px;
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
  margin-top: 15px;
}

/* Stretch table */
#attendanceTable {
  width: 100%;
  min-width: 900px; /* ensures consistent layout */
  border-collapse: collapse;
  font-size: 14px;
  table-layout: auto;
}

/* Sticky header */
#attendanceTable thead th {
  position: sticky;
  top: 0;
  background-color: #004080;
  color: white;
  text-transform: uppercase;
  font-weight: 600;
  text-align: center;
  padding: 10px;
  border-bottom: 2px solid black;
  z-index: 5;
}

/* Body styling */
#attendanceTable td {
  border: 1px solid #ccc;
  padding: 10px;
  text-align: center;
}

#attendanceTable tbody tr:nth-child(even) {
  background-color: #f8f9fa;
}

/* Scrollbar styling */
#attendanceTableWrapper::-webkit-scrollbar {
  width: 10px;
  height: 10px;
}
#attendanceTableWrapper::-webkit-scrollbar-track {
  background: #e0e0e0;
}
#attendanceTableWrapper::-webkit-scrollbar-thumb {
  background-color: #004080;
  border-radius: 5px;
}
#attendanceTableWrapper::-webkit-scrollbar-thumb:hover {
  background-color: #0b66ff;
}

  
</style>
{% endblock %}

{% block content %}
<div class="filters">
  <div class="filter-row">
    <div class="filter-group">
      <div>
        <label>Empleado:</label>
        <select id="employeeSelect" onchange="loadAttendance()">
          <option value="">Seleccione un empleado</option>
        </select>
      </div>
      <div>
        <label>A침o:</label>
        <select id="yearSelect" onchange="loadAttendance()"></select>
      </div>
      <div>
        <label>Mes:</label>
        <select id="monthSelect" onchange="loadAttendance()"></select>
      </div>
    </div>
    <div class="actions">
      <button onclick="exportTableToPDF()">PDF</button>
      <button onclick="exportTableToExcel()">EXCEL</button>
      <button onclick="window.print()">IMPRIMIR</button>
    </div>
  </div>
</div>

<div class="summary-wrapper">
  <div class="summary-box">
    <div class="photo-placeholder"><img id="employeePhoto" src="https://placehold.co/160"></div>
    <h3 id="employeeName">Seleccione Empleado</h3>
    <p id="employeePosition" style="color:#555;">---</p>
  </div>
  <div class="summary-box">
    <canvas id="attendanceChart"></canvas>
  </div>
  <div class="summary-box">
    <table id="summaryTable" style="width:100%;">
      <thead><tr><th colspan="2">Resumen Mensual</th></tr></thead>
      <tbody>
        <tr><td>D칤as trabajados</td><td id="diasTrabajados">0</td></tr>
        <tr><td>D칤as h치biles</td><td id="diasEsperados">0</td></tr>
        <tr><td>Ausencias</td><td id="faltas">0</td></tr>
        <tr><td>% Asistencia</td><td id="porcentajeDias">0%</td></tr>
        <tr><td>Horas trabajadas</td><td id="horasTrabajadas">0.0</td></tr>
        <tr><td>Horas h치biles</td><td id="horasEsperadas">0.0</td></tr>
        <tr><td>Tardanzas</td><td id="tardanzas">0</td></tr>
        <tr><td>% Puntualidad</td><td id="porcentajeHoras">0%</td></tr>
      </tbody>
    </table>
  </div>
</div>
<div id="attendanceTableWrapper">
  <table id="attendanceTable">
    <thead>
      <tr>
        <th>D칤a</th>
        <th>Hora Entrada</th>
        <th>Hora Salida</th>
        <th>Estado</th>
        <th>Observaci칩n</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

{% endblock %}

{% block extra_scripts %}
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

<script>
  const API_BASE = window.location.origin;
  console.log("游깴 Using API_BASE:", API_BASE);

  Chart.register(ChartDataLabels);
  let pieChart = null;
  let allEmployees = [];
  const employeeCache = {};

  /* ============================================================
     PIE CHART + SUMMARY
  ============================================================ */
  function renderPieChart(worked, missing) {
    const ctx = document.getElementById('attendanceChart').getContext('2d');
    if (pieChart) pieChart.destroy();
    pieChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: ['Horas trabajadas', 'Horas ausentes'],
        datasets: [
          {
            data: [worked, missing],
            backgroundColor: ['#28a745', '#dc3545']
          }
        ]
      },
      options: {
        plugins: {
          datalabels: {
            color: '#fff',
            formatter: (v, ctx) => {
              const sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
              return sum > 0 ? `${((v / sum) * 100).toFixed(1)}%` : "";
            }
          },
          legend: { position: 'bottom' }
        }
      }
    });
  }

  function actualizarResumen(s) {
    document.getElementById("diasTrabajados").textContent = s.diasAtendidos;
    document.getElementById("diasEsperados").textContent = s.diasEsperados;
    document.getElementById("faltas").textContent = s.diasAusentes;

    const pDias = document.getElementById("porcentajeDias");
    const pctDias = s.diasEsperados > 0 ? Math.round((s.diasAtendidos / s.diasEsperados) * 100) : 0;
    pDias.textContent = `${pctDias}%`;
    pDias.className = pctDias >= 85 ? 'green' : pctDias >= 75 ? 'yellow' : 'red';

    document.getElementById("horasTrabajadas").textContent = s.horasTrabajadas.toFixed(1);
    document.getElementById("horasEsperadas").textContent = s.horasEsperadas.toFixed(1);
    document.getElementById("tardanzas").textContent = s.tardinessCount;

    const pHoras = document.getElementById("porcentajeHoras");
    const pctHoras = s.diasAtendidos > 0 ? Math.round(((s.diasAtendidos - s.tardinessCount) / s.diasAtendidos) * 100) : 0;
    pHoras.textContent = `${pctHoras}%`;
    pHoras.className = pctHoras >= 95 ? 'green' : pctHoras >= 85 ? 'yellow' : 'red';
  }

  /* ============================================================
     EMPLOYEE LOADING
  ============================================================ */
  async function loadEmployees() {
    try {
      const res = await fetch(`${API_BASE}/employees`);
      const data = await res.json();
      if (data.status === 'success') {
        allEmployees = data.employees;
        const sel = document.getElementById("employeeSelect");
        sel.innerHTML = '<option value="">Seleccionar empleado</option>';
        allEmployees.forEach(e => {
          const name = e.nombre || e.nombre_completo || `Empleado ${e.id}`;
          sel.add(new Option(name, e.id));
        });
      }
    } catch (err) {
      console.error("Error cargando empleados:", err);
    }
  }

  /* Cache employee details once fetched */
  async function loadEmployeeDetails(id) {
    if (employeeCache[id]) {
      const cached = employeeCache[id];
      document.getElementById("employeeName").textContent = cached.nombre;
      document.getElementById("employeePosition").textContent = cached.puesto;
      document.getElementById("employeePhoto").src = cached.foto;
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/employee-details/${id}`);
      const data = await res.json();

      if (data.status === "success" && data.data) {
        const emp = data.data;
        const info = emp.datos_personales?.info || emp.datos_biometricos?.info || {};
        const nombre = info.nombre || emp.nombre || "Sin nombre";
        const puesto = info.puesto || emp.puesto || "Sin puesto registrado";
        const foto = info.url_foto || emp.url_foto || "https://placehold.co/160";

        employeeCache[id] = { nombre, puesto, foto };

        document.getElementById("employeeName").textContent = nombre;
        document.getElementById("employeePosition").textContent = puesto;
        document.getElementById("employeePhoto").src = foto;
      } else {
        document.getElementById("employeeName").textContent = "Empleado desconocido";
        document.getElementById("employeePosition").textContent = "Sin puesto registrado";
        document.getElementById("employeePhoto").src = "https://placehold.co/160";
      }
    } catch (err) {
      console.error("Error cargando detalles del empleado:", err);
      document.getElementById("employeeName").textContent = "Error cargando datos";
      document.getElementById("employeePosition").textContent = "N/A";
      document.getElementById("employeePhoto").src = "https://placehold.co/160";
    }
  }

  /* ============================================================
     ATTENDANCE LOADING
  ============================================================ */
  async function loadAttendance() {
    const empId = document.getElementById("employeeSelect").value;
    const year = document.getElementById("yearSelect").value;
    const month = document.getElementById("monthSelect").value;
    if (!empId || !year || !month) return;

    await loadEmployeeDetails(empId);

    try {
      const res = await fetch(`${API_BASE}/attendance?employee_id=${encodeURIComponent(empId)}&year=${encodeURIComponent(year)}&month=${encodeURIComponent(month)}`);
      const data = await res.json();

      if (data.status !== "success") throw new Error(data.message);
      const days = data.days || {};
      const tbody = document.querySelector("#attendanceTable tbody");
      tbody.innerHTML = "";

      let stats = { diasAtendidos: 0, diasAusentes: 0, diasEsperados: 0, horasTrabajadas: 0, horasEsperadas: 0, tardinessCount: 0 };
      const LATE = "09:05:00";
      const mMap = {
        "enero": 0, "febrero": 1, "marzo": 2, "abril": 3, "mayo": 4, "junio": 5,
        "julio": 6, "agosto": 7, "septiembre": 8, "octubre": 9, "noviembre": 10, "diciembre": 11
      };

      Object.keys(days).sort((a, b) => a - b).forEach(k => {
        const r = days[k];
        const date = new Date(year, mMap[month], k);
        const dow = date.getDay();
        if (dow === 0 || dow === 6) return; // skip weekends

        stats.diasEsperados++;
        stats.horasEsperadas += (dow === 5) ? 4 : 8;

        let entrada = r.hora_entrada || "";
        let salida = r.hora_salida || "";

        if (entrada.includes(" ")) entrada = entrada.split(" ")[1];
        if (salida.includes(" ")) salida = salida.split(" ")[1];

        let estadoHtml = "";
        if (!entrada) {
          stats.diasAusentes++;
          estadoHtml = '<span class="chip danger">Ausente</span>';
        } else {
          stats.diasAtendidos++;
          if (entrada > LATE) {
            stats.tardinessCount++;
            estadoHtml = '<span class="chip warning">Tarde</span>';
          } else {
            estadoHtml = '<span class="chip success">A Tiempo</span>';
          }
          if (salida) {
            const [h1, m1] = entrada.split(":").map(Number);
            const [h2, m2] = salida.split(":").map(Number);
            if (!isNaN(h1) && !isNaN(h2)) {
              stats.horasTrabajadas += Math.max(0, ((h2 * 60 + m2) - (h1 * 60 + m1)) / 60);
            }
          }
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${date.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric' })}</td>
          <td>${entrada ? entrada.slice(0, 5) : '-'}</td>
          <td>${salida ? salida.slice(0, 5) : '-'}</td>
          <td>${estadoHtml}</td>
          <td>${r.explicacion || ''}</td>
        `;
        tbody.appendChild(tr);
      });

      actualizarResumen(stats);
      renderPieChart(stats.horasTrabajadas, Math.max(0, stats.horasEsperadas - stats.horasTrabajadas));

    } catch (err) {
      console.error("Error cargando asistencia:", err);
    }
  }

  /* ============================================================
     YEAR & MONTH SELECTORS
  ============================================================ */
  function loadYearOptions() {
    const sel = document.getElementById("yearSelect");
    const y = new Date().getFullYear();
    for (let i = y - 1; i <= y; i++) sel.add(new Option(i, i));
    sel.value = y;
  }

  function loadMonthOptions() {
    const sel = document.getElementById("monthSelect");
    const months = ["enero", "febrero", "marzo", "abril", "mayo", "junio",
                    "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"];
    months.forEach(m => sel.add(new Option(m.charAt(0).toUpperCase() + m.slice(1), m)));
    sel.value = months[new Date().getMonth()];
  }

  /* ============================================================
     EXPORTS
  ============================================================ */
  function exportTableToExcel() {
    const t = document.getElementById("attendanceTable");
    const a = document.createElement('a');
    a.href = 'data:application/vnd.ms-excel,' + t.outerHTML;
    a.download = 'reporte_asistencia.xls';
    a.click();
  }

  function exportTableToPDF() {
    const t = document.getElementById("attendanceTable").outerHTML;
    const w = window.open('', 'Print-Window');
    w.document.open();
    w.document.write(`<html><head><title>Reporte</title></head><body onload="window.print()">${t}</body></html>`);
    w.document.close();
    setTimeout(() => w.close(), 10);
  }

  function loadPage(url) { window.location.href = url; }

  /* ============================================================
     SUGGESTIONS (autocomplete)
  ============================================================ */
  function showSuggestions(type) {
    const input = type === 'name' ? document.getElementById('searchByName') : document.getElementById('searchById');
    const list = type === 'name' ? document.getElementById('suggestionsName') : document.getElementById('suggestionsId');
    const q = input.value.toLowerCase();
    list.innerHTML = '';
    if (q.length < 2) { list.style.display = 'none'; return; }

    const filtered = allEmployees.filter(e =>
      type === 'name'
        ? (e.nombre || e.nombre_completo || '').toLowerCase().includes(q)
        : String(e.id).startsWith(q)
    );

    filtered.forEach(e => {
      const d = document.createElement('div');
      d.className = 'suggestion-item';
      d.textContent = `${e.nombre || e.nombre_completo} (ID:${e.id})`;
      d.onclick = () => {
        input.value = '';
        list.style.display = 'none';
        document.getElementById('employeeSelect').value = e.id;
        loadAttendance();
      };
      list.appendChild(d);
    });

    list.style.display = filtered.length ? 'block' : 'none';
  }

  /* ============================================================
     INIT
  ============================================================ */
window.onload = () => {
  loadEmployees();
  loadYearOptions();
  loadMonthOptions();

  const toggleBtn = document.getElementById('toggle-filters-btn');
  if (toggleBtn)
    toggleBtn.onclick = () => document.getElementById('advanced-filters').classList.toggle('expanded');

  const nameInput = document.getElementById('searchByName');
  const idInput = document.getElementById('searchById');
  if (nameInput) nameInput.oninput = () => showSuggestions('name');
  if (idInput) idInput.oninput = () => showSuggestions('id');
};

</script>

{% endblock %}
