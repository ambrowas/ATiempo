{% extends 'base.html' %}
{% block title %}Panel Principal - ATiempo{% endblock %}
{% block extra_styles %}
<style>
  #main-container {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: calc(100vh - 150px);
    position: relative;
  }

  #scan-result {
    font-size: 20px;
    font-weight: bold;
    color: rgb(1, 2, 1);
    text-align: center;
    margin-top: 20px;
  }

  #scannerInput {
    position: absolute;
    left: -9999px;
  }

  #qrAnimation {
    width: 250px;
    height: 250px;
    opacity: 0.5;
  }

  /* Modal styling ‚Äî restored from original */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background-color: rgba(0, 0, 0, 0.6);
}
.modal-content {
  background-color: #fefefe;
  margin: 15% auto;
  padding: 25px 30px;
  border-radius: 8px;
  width: 90%; max-width: 400px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  position: relative;
  text-align: center;
}
.close-btn {
  color: #aaa;
  position: absolute;
  top: 10px; right: 15px;
  font-size: 28px; font-weight: bold;
  cursor: pointer;
}
.close-btn:hover, .close-btn:focus {
  color: black;
}
.modal-content form {
  display: flex; flex-direction: column; text-align: left;
}
.modal-content h2 {
  color: #004080; margin-bottom: 20px;
}
.modal-content label {
  margin-bottom: 5px; font-weight: bold; color: #333;
}
.modal-content input {
  margin-bottom: 15px;
  padding: 10px;
  font-size: 16px;
  border: 1px solid #ccc;
  border-radius: 4px;
}
.modal-content button[type="submit"] {
  padding: 12px;
  background-color: #004080;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 16px;
  font-weight: bold;
}


  .close-btn {
    color: #aaa;
    position: absolute;
    top: 10px;
    right: 15px;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
  }

  .toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 2000;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .toast {
    padding: 12px 18px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: bold;
    color: #fff;
    animation: fadein 0.5s, fadeout 0.5s 3.5s;
    opacity: 0.95;
  }
  .toast.success { background-color: #28a745; }
  .toast.error { background-color: #dc3545; }

  @keyframes fadein { from {opacity: 0; transform: translateY(-10px);} to {opacity: 0.95; transform: translateY(0);} }
  @keyframes fadeout { from {opacity: 0.95;} to {opacity: 0;} }
</style>
{% endblock %}

{% block content %}
<div id="main-container">
  <div id="qrAnimation"></div>
  <div id="scan-result">Escanee su c√≥digo QR para registrar la entrada o salida</div>
</div>

<input id="scannerInput" autofocus />

<!-- üîê Login Modal -->
<div id="loginModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" id="closeLogin">&times;</span>
    <h2>Iniciar Sesi√≥n</h2>
    <form id="loginForm">
      <label for="email">Correo electr√≥nico</label>
      <input type="email" id="email" name="email" required>
      <label for="password">Contrase√±a</label>
      <input type="password" id="password" name="password" required>
      <button type="submit">Entrar</button>
    </form>
  </div>
</div>

<div id="toastContainer" class="toast-container"></div>
<audio id="successSound" src="{{ url_for('static', filename='assets/magic.mp3') }}"></audio>
{% endblock %}
{% block extra_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.10.2/lottie.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const scannerInput = document.getElementById("scannerInput");
  const resultDiv = document.getElementById("scan-result");
  const toastContainer = document.getElementById("toastContainer");
  const successSound = document.getElementById("successSound");
  const qrAnimationContainer = document.getElementById("qrAnimation");
  const loginModal = document.getElementById("loginModal");
  const closeLogin = document.getElementById("closeLogin");
  const loginForm = document.getElementById("loginForm");

  // ‚úÖ Declare before use
  let scanningEnabled = false;

  // ‚ö° Offline Mode detection
  const offlineMode = localStorage.getItem("offlineMode") === "true";
  if (offlineMode) {
    console.warn("üõ∞Ô∏è OFFLINE MODE ACTIVE ‚Äî skipping login and using local data");
    // Hide login modal & start scanner immediately
    loginModal.style.display = "none";
    scanningEnabled = true;
    scannerInput.focus();

    // Override fetch to use local JSON endpoints instead of Firestore
    const originalFetch = window.fetch;
    window.fetch = async (url, options) => {
      // Intercept backend calls
      if (url.includes("/scan")) {
        // Example: simulate success
        return new Response(JSON.stringify({
          message: "‚úÖ Registro simulado (modo sin conexi√≥n)",
          status: "success"
        }), { status: 200 });
      }
      if (url.includes("/api")) {
        // Redirect /api calls to /api/local
        const offlineUrl = url.replace("/api", "/api/local");
        console.log("üì¶ Loading from offline:", offlineUrl);
        return originalFetch(offlineUrl, options);
      }
      return originalFetch(url, options);
    };
  }

  /* ‚úÖ Show loader immediately */
  if (typeof showGlobalLoader === "function") showGlobalLoader();

  // ‚úÖ Lottie animation
  const qrAnim = lottie.loadAnimation({
    container: qrAnimationContainer,
    renderer: "svg",
    loop: true,
    autoplay: true,
    path: "{{ url_for('static', filename='assets/QRcode.json') }}"
  });

  function showToast(msg, type="info") {
    const toast = document.createElement("div");
    toast.className = `toast ${type}`;
    toast.textContent = msg;
    toastContainer.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
  }

  function openLogin() {
    if (offlineMode) return; // üö´ skip in offline mode
    loginModal.style.display = "block";
    scanningEnabled = false;
    setTimeout(() => document.getElementById("email").focus(), 100);
  }

  function closeModal() {
    loginModal.style.display = "none";
    scanningEnabled = true;
    scannerInput.focus();
  }

  closeLogin.onclick = closeModal;
  window.onclick = (e) => { if (e.target === loginModal) closeModal(); };

  loginForm.onsubmit = async (e) => {
    e.preventDefault();
    if (offlineMode) return; // üö´ skip sign-in in offline mode
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    try {
      if (typeof showGlobalLoader === "function") showGlobalLoader();
      await firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL);
      await firebase.auth().signInWithEmailAndPassword(email, password);
      showToast("Inicio de sesi√≥n exitoso", "success");
      closeModal();
    } catch {
      showToast("Error al iniciar sesi√≥n", "error");
    } finally {
      if (typeof hideGlobalLoader === "function") hideGlobalLoader();
    }
  };

  // üöÄ Skip Firebase auth entirely in offline mode
  if (!offlineMode) {
    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        closeModal();
        scanningEnabled = true;
        scannerInput.focus();
        if (typeof hideGlobalLoader === "function") hideGlobalLoader();
      } else {
        openLogin();
        if (typeof hideGlobalLoader === "function") hideGlobalLoader();
      }
    });
  } else {
    // Hide loader quickly in offline mode
    if (typeof hideGlobalLoader === "function") hideGlobalLoader();
  }

  scannerInput.addEventListener("input", async e => {
    if (!scanningEnabled) return;
    const value = e.target.value.trim();
    if (!value) return;

    qrAnimationContainer.style.opacity = 0.3;
    resultDiv.textContent = "Procesando‚Ä¶";

    try {
      const res = await fetch("/scan", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ employee_id: value })
      });
      const data = await res.json();

      resultDiv.textContent = data.message;
      showToast(data.message, data.status === "success" ? "success" : "error");
      if (data.status === "success") successSound.play();
    } catch {
      showToast("Error de conexi√≥n", "error");
    } finally {
      e.target.value = "";
      setTimeout(() => {
        resultDiv.textContent = "Escanee su c√≥digo QR para registrar la entrada o salida";
        qrAnimationContainer.style.opacity = 1;
      }, 2000);
    }
  });

  document.body.addEventListener("click", () => {
    if (scanningEnabled) scannerInput.focus();
  });
});
</script>
{% endblock %}

