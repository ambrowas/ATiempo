{% extends "base.html" %}
{% block title %}Gesti√≥n de Flota - ATiempo{% endblock %}
{% block extra_styles %}
<style>
 /* =============================
   FLEET PAGE ‚Äì SELF-CONTAINED CSS
   (safe with base.html defaults)
============================= */

/* Theme tokens */
:root{
  --brand-700:#004080; --brand-600:#0b66ff; --brand-500:#2d7dff;
  --ok-600:#16a34a; --warn-600:#f59e0b; --err-600:#ef4444;
  --bg-1:#f4f7ff; --bg-card:#fff;
}

/* Let the content column expand to fill the row next to the sidebar */
.content-wrapper{ display:flex !important; }
.content-wrapper .main-content{
  flex:1 1 auto !important;            /* take remaining width in the row */
  width:auto !important;                /* avoid 100% inside a row */
  max-width:none !important;
  padding:28px 24px;
  background:var(--bg-1);
  display:flex; flex-direction:column;
  align-items:stretch;                  /* stop centering inner blocks */
}

/* Generic helpers */
.hidden{ display:none !important; }

/* Page cards & buttons */
.card{
  background:#fff; border:1px solid #e7ecff; border-radius:14px;
  box-shadow:0 6px 18px rgba(35,64,153,.08); padding:18px;
}
.sidebar-button{
  background:linear-gradient(180deg,#2d7dff,#004080);
  border:1px solid #173d9a; color:#fff; padding:10px 18px;
  border-radius:10px; font-weight:700; cursor:pointer;
}

/* Tabs */
.tab{ border-bottom:2px solid #e5e7eb; margin-bottom:16px; width:100%; }
.tab .tablinks{
  padding:12px 14px; background:transparent; border:none;
  font-weight:700; color:#5a6a85; cursor:pointer; position:relative;
}
.tab .tablinks.active{ color:var(--brand-700); }
.tab .tablinks.active::after{
  content:""; position:absolute; left:0; right:0; bottom:-2px; height:3px;
  background:linear-gradient(90deg,#2d7dff,#004080); border-radius:2px;
}
.tabcontent{ display:none; animation:.25s ease fadeIn; width:100%; }
@keyframes fadeIn{ from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }

/* Make top-level cards fill the content width */
.content-wrapper .main-content > .card{ width:100%; max-width:none; }

/* =============================
   VEHICLE LIST ‚Äì RESPONSIVE GRID
============================= */
#listVehiclesTab #vehicleListContainer{
  display:grid !important;
  grid-template-columns:repeat(auto-fill, minmax(300px,1fr)) !important;
  gap:24px !important;
  align-items:start;
  width:100%;
}

/* Individual vehicle card */
.vehicle-card{
  background:#fff; border:1px solid #e7ecff; border-radius:12px;
  padding:14px; box-shadow:0 4px 10px rgba(0,0,0,.06);
  display:flex; flex-direction:column; align-items:center; text-align:center;
}
.vehicle-thumb{
  width:220px; height:160px; object-fit:cover;
  border-radius:8px; margin:0 0 8px;
}
.vehicle-card h3{ margin:6px 0 2px; color:#0b2b57; font-size:16px; }
.vehicle-card p { margin:0; color:#566; font-size:13px; }

/* Ensure the ‚ÄúNo vehicles‚Äù message doesn‚Äôt break the grid */
#noVehiclesMessage{ grid-column:1 / -1; }

/* =============================
   VEHICLE DETAILS (in modal)
============================= */
.modal{
  display:none; position:fixed; inset:0; background:rgba(0,0,0,.4);
  z-index:1000; justify-content:center; align-items:center;
}
.modal:not(.hidden){ display:flex; }
.modal .modal-content{
  background:#fff; border:1px solid #e7ecff; border-radius:14px;
  box-shadow:0 16px 36px rgba(15,31,61,.22); padding:18px;
  width:92%; max-width:920px;   /* wider for details */
}
.modal-close{
  border:none; background:#eef2ff; color:#111; font-weight:700;
  padding:6px 10px; border-radius:8px; cursor:pointer;
}
.modal-close:hover{ background:#e0e7ff; }

/* Small photo in details header */
#vehicleDetailsTab #detail_vehicle_photo{
  width:150px; height:110px; object-fit:contain;
  border:1px solid #edf1ff; border-radius:8px;
}

/* =============================
   TABLES & CHART WRAPPERS
============================= */
table{ width:100%; border-collapse:separate; border-spacing:0; }
thead th{
  background:linear-gradient(180deg,#004080,#002a66); color:#fff; padding:10px;
}
tbody td{ padding:10px; border-bottom:1px solid #edf1ff; }
tbody tr:nth-child(odd){ background:#f9fbff; }

.chart-box{
  background:linear-gradient(180deg,#fff,#f7f9ff);
  border:1px solid #edf1ff; border-radius:12px; padding:14px;
}

/* =============================
   STATUS/TOAST
============================= */
#statusMessage{
  position:fixed; top:18px; left:50%; transform:translateX(-50%);
  z-index:1100; background:#fff; border:1px solid #e6ecff;
  border-left:6px solid var(--brand-600); box-shadow:0 10px 28px rgba(35,64,153,.16);
  padding:10px 14px; border-radius:12px;
}

/* =============================
   FOOTER ‚Äì leave as base.html
============================= */
#refran-display{ position:static !important; width:100% !important; }
/* --- Make the row span the full page and allow children to shrink properly --- */
.content-wrapper{
  display:flex !important;
  width:100% !important;
  min-width:0 !important;         /* prevent mysterious right-side gap */
}

/* --- Make the content column truly fill the remaining space --- */
.content-wrapper > .main-content{
  flex:1 1 auto !important;       /* take all remaining width */
  min-width:0 !important;         /* allow grid/table overflow to shrink */
  max-width:none !important;
  align-items:stretch !important;  /* stop centering children */
  padding:28px 24px;               /* your padding */
  background:#f4f7ff;              /* your page bg */
}

/* Top-level cards and tab panes should stretch */
.content-wrapper > .main-content > .card,
.content-wrapper > .main-content > .tab,
.content-wrapper > .main-content .tabcontent{
  width:100% !important;
  max-width:none !important;
}

/* Vehicle grid: horizontal, responsive */
#vehicleListContainer{
  display:grid !important;
  grid-template-columns:repeat(auto-fill, minmax(300px,1fr)) !important;
  gap:24px !important;
  align-items:start;
  width:100% !important;
}

/* Footer: keep base behavior */
#refran-display{ position:static !important; width:100% !important; }

/* --- make the content column behave like other pages --- */
.content-wrapper .main-content{
  flex:1 1 auto !important;
  display:flex !important;
  flex-direction:column !important;
  align-items:stretch !important;   /* stop centering children */
  padding:28px 24px;                /* your page padding */
  max-width:none !important;
  background:#f4f7ff;               /* same look as before */
}

/* top-level cards (header cards etc.) should span full width */
.content-wrapper .main-content > .card{
  width:100% !important;
  max-width:none !important;
}

/* --- VEHICLE LIST GRID --- */
/* the tab pane itself should fill row */
#listVehiclesTab{ width:100% !important; }

/* turn the container into a responsive grid */
#vehicleListContainer{
  display:grid !important;
  grid-template-columns:repeat(auto-fill, minmax(300px, 1fr)) !important;
  gap:24px !important;
  align-items:start;
  width:100% !important;
  margin:0 !important;
}

/* ensure whatever your JS injects becomes a full grid item */
#vehicleListContainer > *{
  width:100% !important;
  max-width:none !important;
  margin:0 !important;
  box-sizing:border-box;
}

/* if the injected child itself has a "card/panel" look, let it stretch */
#vehicleListContainer > .card,
#vehicleListContainer > .panel,
#vehicleListContainer > .vehicle-card,
#vehicleListContainer > .vehicle-item{
  height:100%;
  display:flex;
  flex-direction:column;
}

/* optional: clamp large images inside those items */
#vehicleListContainer img{
  max-width:100%;
  height:auto;
  display:block;
}

/* keep the ‚Äúno vehicles‚Äù message from breaking layout */
#noVehiclesMessage{ grid-column:1 / -1; }

/* tabs look/feel (unchanged) */
.tab{ border-bottom:2px solid #e5e7eb; margin-bottom:16px; width:100%; }
.tab .tablinks{ padding:12px 14px; background:transparent; border:none; font-weight:700; color:#5a6a85; position:relative; cursor:pointer; }
.tab .tablinks.active{ color:#004080; }
.tab .tablinks.active::after{ content:""; position:absolute; left:0; right:0; bottom:-2px; height:3px; background:linear-gradient(90deg,#2d7dff,#004080); border-radius:2px; }
.tabcontent{ display:none; animation:.25s ease fadeIn; width:100%; }
@keyframes fadeIn{ from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }

/* leave base footer alone */
#refran-display{ position:static !important; width:100% !important; }

/* ===== Vehicle Details Modal: compact landscape layout ===== */

/* widen, reduce padding, and keep the whole thing inside the viewport */
#vehicleDetailsModal .modal-content{
  max-width: 1120px;          /* wider for landscape */
  padding: 14px;              /* tighter */
  max-height: 90vh;           /* never exceed viewport */
  overflow: auto;             /* scroll inside if needed */
}

/* header row: image on the left, text + actions on the right */
#vehicleDetailsTab > .flex{
  display: grid !important;
  grid-template-columns: 180px 1fr;
  gap: 14px;
  align-items: center;
}

/* compact header typography */
#vehicleDetailsTab h3.text-xl{
  font-size: 1.05rem;         /* a bit smaller */
  line-height: 1.25rem;
  margin: 0 0 2px 0;
}
#vehicleDetailsTab p.text-sm{ margin: 0; }

/* slightly smaller photo and neutral frame */
#vehicleDetailsTab #detail_vehicle_photo{
  width: 170px;
  height: 120px;
  object-fit: cover;
  border: 1px solid #eef2ff;
  border-radius: 10px;
}

/* make the four info blocks a tight 2-column grid on all screens >= 768px */
#vehicleDetailsTab .grid.lg\:grid-cols-2{
  grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
  gap: 12px !important;
  margin-top: 12px !important;
}

/* denser cards inside the modal */
#vehicleDetailsTab .card{
  padding: 12px !important;
  border-radius: 12px !important;
}

/* shrink inner label/value spacing */
#vehicleDetailsTab .info-grid{
  gap: 8px !important;
  font-size: 0.92rem;
  line-height: 1.15rem;
}
#vehicleDetailsTab .info-card h3{
  font-size: 0.95rem;
  margin-bottom: 6px;
}

/* sub-tab buttons row: keep it in one line and centered */
#vehicleDetailsTab .flex.gap-2.mb-3{
  gap: 8px !important;
  flex-wrap: wrap;
  justify-content: center;
  margin-bottom: 8px !important;
}
#vehicleDetailsTab .sub-tab-button{
  padding: 6px 10px;
  font-size: 0.85rem;
  border-radius: 8px;
}

/* charts and tables: reduce vertical spacing in modal context */
#vehicleDetailsTab .chart-box{
  padding: 10px !important;
  border-radius: 10px !important;
  margin-top: 10px !important;
}
#vehicleDetailsTab table thead th,
#vehicleDetailsTab table tbody td{
  padding: 6px 8px !important;
  font-size: 0.9rem;
}

/* action buttons in header a touch smaller */
#vehicleDetailsTab .mt-3.flex.gap-2 button{
  padding: 8px 12px;
  font-size: 0.85rem;
  border-radius: 8px;
}
/* --- Detalles: scrollable area --- */
#detailsTab .details-scroll{
  /* leave room for header/tabs; adjust if needed */
  max-height: calc(100vh - 220px);
  overflow: auto;
  padding-right: 8px; /* tiny gutter to avoid hidden scrollbar content */
}

/* --- 3D / image viewer modal sizing --- */
#viewer3DModal .modal-content{
  width: 96%;
  max-width: 1200px;
}
.viewer3d-box{ height: 70vh; }

/* Pan/zoom fallback container */
.pz-wrap{
  position: relative;
  width: 100%;
  height: 70vh;
  overflow: hidden;
  background: #0f1115;
  display: flex;
  align-items: center;
  justify-content: center;
}
.pz-wrap img{
  max-width: none;                /* allow zoom beyond natural size */
  will-change: transform;
  user-select: none;
  pointer-events: none;           /* we track on the wrapper */
}
/* ---- Gestion de Veh√≠culos polish ---- */
.form-grid{display:grid;gap:12px}
.form-grid.md-2{grid-template-columns:repeat(2,minmax(0,1fr))}
.form-grid.md-3{grid-template-columns:repeat(3,minmax(0,1fr))}
.input{border:1px solid #e6ecff;border-radius:10px;padding:10px}
.label{font-size:.9rem;color:#51607a;margin-bottom:6px;display:block}
.card h3{margin-bottom:8px}
.action-row{display:flex;gap:10px;align-items:center}
.primary-btn{background:linear-gradient(180deg,#2d7dff,#004080);color:#fff;border:1px solid #173d9a;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
.secondary-btn{background:#eef2ff;border:1px solid #dee6ff;color:#0b2b57;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
.danger-btn{background:#ef4444;border:1px solid #dc2626;color:#fff;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}

/* === FIX: Make content scroll and prevent footer overlap === */
.content-wrapper {
  flex: 1;
  display: flex;
  flex-direction: row;
  height: auto !important;
  min-height: 0 !important;
}

.main-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: #f4f4f4;
  padding: 20px 30px;
  overflow-y: auto; /* allows scrolling when cards overflow */
  box-sizing: border-box;
}

/* Footer should push down, not overlap */
#refran-display {
  position: relative !important;
  margin-top: auto !important;
  flex-shrink: 0 !important;
  width: 100%;
}
/* Tabs: visible by default; we hide with .hidden */
.tabcontent { display: block !important; }
.tabcontent.hidden { display: none !important; }

.vehicle-marker svg {
  width: 100%;
  height: 100%;
  transform-origin: center center;
  transition: transform 0.6s linear;
}
.card-buttons {
  display: flex;
  gap: 8px;
  margin-top: 8px;
}

.btn-secondary {
  background-color: #2563eb;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9rem;
}

.btn-secondary:hover {
  background-color: #1e40af;
}
/* =============== */
/* TARGETED BORDERS */
/* =============== */

/* üîπ Base button style (shared by all: Ver Detalles / Ver Posici√≥n / Editar / Posicionar) */
.btn {
  background-color: #004080;
  color: white;
  border: 2px solid black;
  padding: 6px 14px;
  border-radius: 6px;
  font-weight: 600;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
  margin-right: 6px;
}

/* üîπ Hover effect for all buttons */
.btn:hover {
  background-color: #003366;
  transform: translateY(-1px);
}

/* üîπ Keep alignment when multiple buttons appear in a row */
.button-group .btn,
.card .btn {
  display: inline-block;
  vertical-align: middle;
}

/* üîπ Optional: consistent spacing when buttons stack or wrap */
.button-group {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}


/* Outer border for main Gestion de Flota card */
.card.mb-6 {
  border: 3px solid black !important;
  border-radius: 8px;
  padding: 15px;
  background: #ffffff;
}

/* Border for individual vehicle cards */
.vehicle-card {
  border: 2px solid black !important;
  border-radius: 8px;
  padding: 10px;
  background: #ffffff;
  transition: transform 0.15s ease, box-shadow 0.2s ease;
}

/* Optional subtle hover effect for depth */
.vehicle-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

/* ============================= */
/* CLEAN BORDER ENHANCEMENTS */
/* ============================= */

/* Main "Gesti√≥n de Flota" card */
.card.mb-6 {
  border: 3px solid black !important;
  border-radius: 8px;
  padding: 15px;
  background: #ffffff;
}

/* Each vehicle card */
.vehicle-card {
  border: 2px solid black !important;
  border-radius: 8px;
  padding: 10px;
  background: #ffffff;
  transition: transform 0.15s ease, box-shadow 0.2s ease;
}

.vehicle-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
}

/* Posicionamiento map panel */
#trackingTab {
  border: 3px solid black !important;
  border-radius: 8px;
  background: #ffffff;
  padding: 20px;
}

/* Optional: border around the map itself */
#map {
  border: 2px solid black;
  border-radius: 6px;
}
/* Border for the lower management card in 'Gesti√≥n de Veh√≠culos' tab */
#gestionTab .card,
#gestionTab .gestion-card {
  border: 3px solid black !important;
  border-radius: 8px;
  padding: 15px;
  background: #ffffff;
}
/* üî∑ Outer border for the main details card */
#vehicleDetailsContent {
  border: 2px solid black;
  border-radius: 8px;
  padding: 16px 20px;
  background-color: #ffffff;
  box-shadow: 0 0 8px rgba(0,0,0,0.1);
}

/* Keep internal elements clean (no nested borders) */
#vehicleDetailsContent .detail-item,
#vehicleDetailsContent .info-row,
#vehicleDetailsContent div {
  border: none !important;
  box-shadow: none !important;
}
/* ‚úÖ Outer border for the main "Ver Detalles" info container */
#detailsTab > .details-scroll,
#detailsTab > .card:not(.hidden) {
  border: 3px solid black !important;
  border-radius: 8px;
  padding: 18px 22px;
  background: #ffffff;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}
/* ============================ */
/*  UNIFIED BUTTON APPEARANCE   */
/* ============================ */

/* üîπ Base look for all main buttons */
.btn,
.primary-btn,
.secondary-btn,
#vehicleDetailsTab button,
.vehicle-card button {
  background-color: #004080 !important; /* deep embassy blue */
  color: #ffffff !important;
  border: 2px solid black !important;
  padding: 8px 14px !important;
  border-radius: 8px !important;
  font-weight: 600 !important;
  font-size: 0.9rem !important;
  cursor: pointer !important;
  transition: all 0.2s ease-in-out !important;
}

/* üîπ Hover and active states */
.btn:hover,
.primary-btn:hover,
.secondary-btn:hover,
#vehicleDetailsTab button:hover,
.vehicle-card button:hover {
  background-color: #003366 !important;
  transform: translateY(-1px);
}

/* üîπ Consistent spacing when multiple buttons appear together */
.vehicle-card .card-buttons,
#vehicleDetailsTab .mt-3.flex.gap-2 {
  display: flex;
  gap: 8px;
}
.modal {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,0.8);
  z-index: 9999;
}

.modal-content {
  position: relative;
  background: #fff;
  border-radius: 10px;
  overflow: hidden;
  width: 85%;
  max-width: 1200px;
  box-shadow: 0 0 25px rgba(0,0,0,0.6);
  animation: fadeIn 0.3s ease;
}

.close-btn {
  position: absolute;
  top: 10px;
  right: 15px;
  background: #ff0000cc;
  color: white;
  border: none;
  border-radius: 4px;
  font-size: 18px;
  padding: 5px 10px;
  cursor: pointer;
  transition: background 0.2s;
}

.close-btn:hover {
  background: #ff0000;
}

.vehicle-card {
  border: 2px solid #004080;
  border-radius: 8px;
  background: #fff;
  padding: 10px;
  margin: 10px;
  text-align: center;
  box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
}

.vehicle-photo {
  width: 100%;
  max-height: 160px;
  object-fit: cover;
  border-radius: 6px;
}

.vehicle-actions {
  margin-top: 10px;
  display: flex;
  justify-content: space-between;
  gap: 10px;
}

.vehicle-actions button {
  flex: 1;
  padding: 8px 12px;
  border: none;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
  transition: background 0.2s ease-in-out;
}

.vehicle-actions .view-btn {
  background-color: #007bff;
  color: white;
}

.vehicle-actions .map-btn {
  background-color: #28a745;
  color: white;
}

.vehicle-actions .view-btn:hover {
  background-color: #0056b3;
}

.vehicle-actions .map-btn:hover {
  background-color: #1e7e34;
}

@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.modal-content {
  background: white;
  padding: 20px;
  border-radius: 10px;
  max-width: 900px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-close {
  position: absolute;
  top: 15px;
  right: 20px;
  background: none;
  border: none;
  font-size: 18px;
  font-weight: bold;
  color: #444;
  cursor: pointer;
}
#documentacionContainer button {
  transition: all 0.2s ease;
}
#documentacionContainer button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0,0,0,0.15);
}
#documentacionContainer .text-xs {
  font-size: 0.75rem;
  line-height: 1rem;
}
/* ======================================================
   üß© Spacing improvements for Mantenimiento tab
====================================================== */
#maintenanceTab {
  display: flex;
  flex-direction: column;
  gap: 1.25rem; /* 20px spacing between major sections */
}

#maintenanceTab .card {
  margin-bottom: 1rem; /* 16px vertical space between cards */
}

#maintenanceSummaryContainer > div {
  margin-bottom: 1rem; /* space between individual summary cards */
}

#maintenanceTab h2,
#maintenanceTab h3 {
  margin-bottom: 0.5rem; /* consistent spacing under headings */
}

#maintenanceTab select {
  margin-bottom: 0.75rem; /* spacing below dropdown */
}

/* ======================================================
   üß© Enhanced Driver Info Card Styling
====================================================== */
#driverInfoCard {
  transition: all 0.3s ease;
}

#driverInfoCard:hover {
  transform: scale(1.02);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

#driverStatusBadge {
  letter-spacing: 0.5px;
}

#driverVehicleTags span {
  transition: background-color 0.2s ease, color 0.2s ease;
}

#driverVehicleTags span:hover {
  background-color: #2563eb;
  color: white;
}
/* ======================================================
   üß© Spacing + Layout for Conductores Tab
====================================================== */
#driversTab {
  display: flex;
  flex-direction: column;
  gap: 1.25rem; /* 20px space between each major card section */
}

/* Individual card spacing */
#driversTab .card {
  margin-bottom: 1rem; /* 16px vertical spacing below each card */
  padding: 1rem;       /* consistent internal padding */
}

/* Title and section spacing */
#driversTab h2,
#driversTab h3 {
  margin-bottom: 0.5rem;
}

/* Inputs and selectors */
#driversTab select,
#driversTab input[type="date"],
#driversTab button {
  margin-bottom: 0.75rem;
}

/* ======================================================
   üßë‚Äç‚úàÔ∏è Driver Info Card Spacing
====================================================== */
#driverInfoCard {
  display: flex;
  align-items: center;
  gap: 1.25rem; /* horizontal space between image and text */
  padding: 1rem 1.25rem;
  border: 2px solid #1e40af;
  border-radius: 12px;
  background: #ffffff;
  box-shadow: 0 3px 6px rgba(0, 0, 0, 0.05);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

/* Slight hover effect */
#driverInfoCard:hover {
  transform: scale(1.02);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

/* Smaller driver photo (50%) */
#driverPhoto {
  width: 3.5rem;  /* 56px */
  height: 3.5rem; /* 56px */
  border-width: 3px;
  object-fit: cover;
}

/* Text spacing inside the info card */
#driverInfoCard div {
  display: flex;
  flex-direction: column;
  gap: 0.35rem; /* tighter vertical spacing between lines */
}

/* Tags section (vehicle list) */
#driverVehicleTags {
  display: flex;
  flex-wrap: wrap;
  gap: 0.4rem; /* small space between vehicle chips */
  margin-top: 0.5rem;
}
#comparisonMode:checked + label {
  color: #1e40af;
  font-weight: 600;
}
/* ======================================================
   ‚õΩ CONSUMO TAB ‚Äî CARD SPACING AND LAYOUT
====================================================== */

#consumptionTab {
  display: flex;
  flex-direction: column;
  gap: 1.25rem; /* 20px gap between major sections (cards) */
}

/* Each card should have comfortable breathing space */
#consumptionTab .card {
  margin-bottom: 1rem;  /* 16px space below each card */
  padding: 1rem 1.25rem;
  background: #ffffff;
  border: 2px solid #1e40af;
  border-radius: 12px;
  box-shadow: 0 3px 6px rgba(0, 0, 0, 0.05);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

/* Slight hover elevation effect */
#consumptionTab .card:hover {
  transform: scale(1.01);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

/* Headings inside cards */
#consumptionTab h2,
#consumptionTab h3 {
  margin-bottom: 0.5rem;
}

/* Flex and gap for control section (selectors, toggle) */
#consumptionTab .flex {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 0.75rem; /* spacing between selectors and labels */
}

/* Table styling consistency */
#consumptionTab table.styled-table {
  border-collapse: collapse;
  width: 100%;
  border: 1px solid #cbd5e1;
}

#consumptionTab table.styled-table th,
#consumptionTab table.styled-table td {
  padding: 0.6rem 0.8rem;
  text-align: left;
}

#consumptionTab table.styled-table th {
  background-color: #e0e7ff;
  font-weight: 600;
  color: #1e3a8a;
}

#consumptionTab table.styled-table tr:nth-child(even) {
  background-color: #f9fafb;
}
/* üíß subtle wobble for bar fill illusion */
canvas#consumptionChart {
  transition: transform 0.2s ease;
}
/* üíô ATiempo-styled floating legend */
.chartjs-legend,
.chartjs-legend ul {
  background: rgba(240, 248, 255, 0.97) !important; /* soft azure background */
  color: #0a2a66 !important;                        /* embassy blue text */
  border: 1px solid rgba(0, 64, 128, 0.35) !important;
  border-radius: 8px !important;
  padding: 10px 16px !important;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15) !important;
  backdrop-filter: blur(6px);
}

.chartjs-legend li {
  color: #0a2a66 !important;
  font-weight: 700 !important;
  font-size: 14px !important;
  letter-spacing: 0.3px;
}

.chartjs-legend li span {
  border-radius: 50% !important;
  border: 2px solid rgba(0, 64, 128, 0.5);
  box-shadow: 0 0 3px rgba(0, 64, 128, 0.4);
}


</style>
{% endblock %}{% block content %}
  <div id="authMessage" class="hidden text-center text-red-600 font-semibold mb-4">Cargando‚Ä¶</div>
  <div id="statusMessage" class="hidden"></div>

  <div id="fleetContent" class="hidden">
    <div class="card mb-6">
      <h2 class="text-2xl font-semibold text-blue-800">Gesti√≥n de Flota</h2>
      <p class="text-sm text-gray-600">Monitoreo, documentaci√≥n y mantenimiento de veh√≠culos.</p>
    </div>

    <div id="loadingIndicator" class="hidden" style="margin:8px 0">Cargando‚Ä¶</div>

    <div class="tab">
      <button class="tablinks active" onclick="openTab(event,'listVehiclesTab')">Veh√≠culos</button>
      <button class="tablinks" onclick="openTab(event,'trackingTab')">Posicionamiento</button>
      <button class="tablinks" onclick="openTab(event,'documentacionTab')">Documentaci√≥n</button>
      <button class="tablinks" onclick="openTab(event,'maintenanceTab')">Mantenimiento</button>
      <button class="tablinks" onclick="openTab(event,'driversTab')">Conductores</button>
      <button class="tablinks" onclick="openTab(event,'consumptionTab')">Consumo</button>
      <button id="detailsTabBtn" class="tablinks hidden" onclick="openTab(event,'detailsTab')">Detalles</button>
    </div>

    <div id="listVehiclesTab" class="tabcontent" style="display:block">
      <div class="card">
        <h3 class="text-lg font-semibold text-blue-800 mb-3">Listado de Veh√≠culos</h3>
        <div id="vehicleListContainer"></div>
        <p id="noVehiclesMessage" class="text-center text-gray-500 hidden">
          No hay veh√≠culos registrados.
        </p>
      </div>
    </div>

     <div id="detailsTab" class="tabcontent hidden">
      <div class="card details-scroll" id="vehicleDetailsTab">
        <div class="flex items-start gap-4">
          <img id="detail_vehicle_photo" src="https://placehold.co/120" class="rounded-lg" alt="">
          <div>
            <h3 class="text-xl font-semibold" id="detail_marca_modelo">‚Äî</h3>
            <p class="text-sm text-gray-600" id="detail_matricula_year">‚Äî</p>
            <div class="mt-3 flex gap-2">
              <button id="editVehicleDetailsBtn" class="sidebar-button">Editar</button>
              <button id="positionVehicleBtn" class="btn btn-primary">Posicionar</button>
              <button id="saveVehicleDetailsBtn" class="sidebar-button hidden">Guardar</button>
              <button id="cancelVehicleDetailsBtn" class="sidebar-button hidden" style="background:#e5e7eb;color:#111;border-color:#e5e7eb">Cancelar</button>
            </div>
          </div>
        </div>

        <div class="grid lg:grid-cols-2 gap-6 mt-6">
          <div class="info-card card">
            <h3 class="font-semibold mb-2">Datos del Veh√≠culo</h3>
            <div class="info-grid grid grid-cols-2 gap-3">
              <div class="detail-item"><strong>Matr√≠cula</strong> <span id="detail_matricula">‚Äî</span></div>
              <div class="detail-item"><strong>Marca</strong> <span id="detail_marca">‚Äî</span></div>
              <div class="detail-item"><strong>Modelo</strong> <span id="detail_modelo">‚Äî</span></div>
              <div class="detail-item"><strong>A√±o</strong> <span id="detail_a√±o">‚Äî</span></div>
              <div class="detail-item"><strong>Color</strong> <span id="detail_color">‚Äî</span></div>
              <div class="detail-item"><strong>VIN</strong> <span id="detail_vin">‚Äî</span></div>
              <div class="detail-item"><strong>Tipo</strong> <span id="detail_tipo">‚Äî</span></div>
            </div>
          </div>
          <div class="info-card card">
            <h3 class="font-semibold mb-2">Seguro</h3>
            <div class="info-grid grid grid-cols-2 gap-3">
              <div class="detail-item"><strong>Compa√±√≠a</strong> <span id="detail_insurance_compania">‚Äî</span></div>
              <div class="detail-item"><strong>P√≥liza</strong> <span id="detail_insurance_poliza">‚Äî</span></div>
              <div class="detail-item"><strong>Vencimiento</strong> <span id="detail_insurance_vencimiento">‚Äî</span></div>
            </div>
          </div>
          <div class="info-card card">
            <h3 class="font-semibold mb-2">Permiso de Circulaci√≥n</h3>
            <div class="info-grid grid grid-cols-2 gap-3">
              <div class="detail-item"><strong>Fecha de Emisi√≥n</strong> <span id="detail_permiso_emision">‚Äî</span></div>
              <div class="detail-item"><strong>Vencimiento</strong> <span id="detail_permiso_vencimiento">‚Äî</span></div>
              <div class="detail-item"><strong>Costo</strong> <span id="detail_permiso_costo">‚Äî</span></div>
            </div>
          </div>
          <div class="info-card card">
            <h3 class="font-semibold mb-2">Tasa Tr√°fico Rodado</h3>
            <div class="info-grid grid grid-cols-2 gap-3">
              <div class="detail-item"><strong>Fecha de Emisi√≥n</strong> <span id="detail_tasa_emision">‚Äî</span></div>
              <div class="detail-item"><strong>Vencimiento</strong> <span id="detail_tasa_vencimiento">‚Äî</span></div>
              <div class="detail-item"><strong>Costo</strong> <span id="detail_tasa_costo">‚Äî</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="trackingTab" class="tabcontent hidden">
        <div class="card">
            <h3 class="text-lg font-semibold text-blue-800 mb-2">Monitoreo de Veh√≠culos</h3>
            <div class="flex items-center gap-4 mb-4">
                <label for="vehicleSelector" class="text-sm text-gray-700">Seleccionar veh√≠culo:</label>
                <select id="vehicleSelector" class="border border-gray-400 rounded px-2 py-1 text-sm">
                    <option value="all">Ver Todos los Veh√≠culos</option>
                </select>
            </div>
            <div id="trackingDisplay" class="text-sm text-gray-600 mb-2">
                <p class="text-gray-500">Selecciona un veh√≠culo para comenzar el monitoreo.</p>
            </div>
            <div id="map" style="width: 100%; height: 480px; border: 2px solid #ccc; border-radius: 8px;"></div>
        </div>
    </div>
<!-- ===================== DOCUMENTACI√ìN ===================== -->
<div id="documentacionTab" class="tabcontent hidden">
  <div class="card">
    <h3 class="text-lg font-semibold text-blue-800 mb-3">
      Documentaci√≥n Oficial ‚Äì Cartilla √önica de Veh√≠culos (CUVE)
    </h3>

    <!-- üîπ Vehicle selector -->
    <div class="flex items-center gap-3 mb-4">
      <label for="docVehicleSelector" class="text-sm text-gray-700">Seleccionar veh√≠culo:</label>
      <select id="docVehicleSelector" class="border border-gray-400 rounded px-2 py-1 text-sm">
        <option value="">Seleccione un veh√≠culo</option>
      </select>
    </div>

    <p class="text-sm text-gray-600 mb-4">
      La <strong>Cartilla √önica de Veh√≠culos (CUVE)</strong> agrupa toda la documentaci√≥n necesaria para circular legalmente por Guinea Ecuatorial. 
      Aqu√≠ puedes consultar los documentos registrados, su fecha de vencimiento y los archivos asociados.
    </p>

    <!-- üìÑ Document List -->
    <div id="documentacionContainer" class="flex flex-col gap-3"></div>
  </div>
</div>

<!-- ===================== PDF MODAL VIEWER ===================== -->
<div id="pdfViewerModal" class="modal hidden" style="position:fixed;inset:0;z-index:1000;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);">
  <div class="modal-content" style="background:#fff;border-radius:10px;padding:16px;width:90%;height:90%;display:flex;flex-direction:column;box-shadow:0 4px 10px rgba(0,0,0,0.4);">
    <div class="flex items-center justify-between mb-3">
      <div class="flex items-center gap-3">
        <img id="miniVehicleImg" src="" alt="Veh√≠culo" style="width:80px;height:60px;object-fit:cover;border-radius:6px;border:1px solid #ccc;">
        <div>
          <h3 id="pdfVehicleName" class="text-lg font-semibold text-gray-800"></h3>
          <p id="pdfVehicleMatricula" class="text-sm text-gray-600"></p>
        </div>
      </div>
     <button id="closeVehicleModal"
  class="absolute top-3 right-3 text-gray-500 hover:text-black text-2xl font-bold focus:outline-none">
  &times;
</button>

    </div>
    <iframe id="pdfViewer" src="" style="flex:1;border:1px solid #ddd;border-radius:6px;"></iframe>
    <div class="flex justify-end mt-3">
      <a id="downloadPdfButton" href="#" download class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow text-sm">Descargar</a>
    </div>
  </div>
</div>

  <!-- ===================== MODAL: SUBIR DOCUMENTO ===================== -->
<div id="uploadDocModal" class="modal hidden" aria-hidden="true">
  <div class="modal-content" style="max-width: 480px;">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-lg font-semibold">Subir nuevo documento</h3>
      <button id="uploadDocClose" class="modal-close" aria-label="Cerrar">‚úï</button>
    </div>

    <form id="uploadDocForm" class="space-y-3">
      <input type="hidden" id="uploadDocVehicleId">
      <input type="hidden" id="uploadDocType">

      <div>
        <label class="block text-sm font-medium">Tipo de documento</label>
        <input type="text" id="uploadDocLabel" class="w-full border rounded-md p-2 bg-gray-100" readonly>
      </div>

      <div>
        <label class="block text-sm font-medium">Archivo PDF</label>
        <input type="file" id="uploadDocFile" accept="application/pdf" class="w-full border rounded-md p-2">
      </div>

      <div class="flex justify-end gap-2 mt-4">
        <button type="button" id="uploadDocCancel" class="sidebar-button" 
                style="background:#e5e7eb;color:#111;border-color:#e5e7eb">Cancelar</button>
        <button type="submit" class="sidebar-button">Subir</button>
      </div>
    </form>
  </div>
</div>
<!-- ======================================================
     üß∞ TAB: MANTENIMIENTO Y REPARACIONES
====================================================== -->
<div id="maintenanceTab" class="tabcontent hidden">
  <div class="card mb-6">
    <h2 class="text-2xl font-semibold text-blue-800">Mantenimiento y Reparaciones</h2>
    <p class="text-sm text-gray-600">
      Historial de talleres, costos y documentos de mantenimiento por veh√≠culo.
    </p>
  </div>

  <!-- ======================================================
       üìä CHART: TOTAL GASTOS POR VEH√çCULO
  ====================================================== -->
  <div class="card mb-6">
    <h3 class="text-xl font-semibold text-blue-800 mb-3">Gasto Total por Veh√≠culo</h3>
    <canvas id="maintenanceChart" width="400" height="200"></canvas>
  </div>

  <!-- üìä Resumen General -->
  <div id="maintenanceSummaryContainer" class="grid md:grid-cols-3 gap-4 mb-8"></div>

  <!-- üßæ Historial Detallado -->
  <div class="card">
    <h3 class="text-xl font-semibold mb-2">Historial de los √öltimos 10 Meses</h3>
    <select id="maintenanceVehicleSelect" class="input mb-3"></select>
    <table id="maintenanceHistoryTable" class="styled-table w-full text-sm border">
      <thead>
        <tr class="bg-blue-50 border-b">
          <th>Fecha</th>
          <th>Tipo</th>
          <th>Taller</th>
          <th>Descripci√≥n</th>
          <th>Cotizado (XAF)</th>
          <th>Pagado (XAF)</th>
          <th>Factura</th>
          <th>Pago</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- ‚ôªÔ∏è Reuse existing PDF modal viewer -->
  <div id="pdfModal" class="modal hidden" aria-hidden="true">
    <div class="modal-content">
      <button id="closePdfBtn" class="modal-close">‚úï</button>
      <iframe id="pdfViewerFrame" src="" width="100%" height="700px"></iframe>
    </div>
  </div>
</div>

<!-- ======================================================
     üöó TAB: CONDUCTORES
====================================================== -->
<div id="driversTab" class="tabcontent hidden">
  <div class="card mb-6">
    <h2 class="text-2xl font-semibold text-blue-800">Conductores Asignados</h2>
    <p class="text-sm text-gray-600">
      Control de asignaciones de veh√≠culos por conductor y fecha.
    </p>
  </div>
  <!-- üìä Actividad de Conductores -->
<div class="card mb-6">
  <h3 class="text-xl font-semibold text-blue-800 mb-3">Trayectos por Conductor</h3>
  <div style="height:260px">
    <canvas id="driversActivityChart"></canvas>
  </div>
</div>
  <!-- üîç Filtros -->
  <div class="card mb-6">
    <h3 class="text-xl font-semibold text-blue-800 mb-3">Filtros de B√∫squeda</h3>
    <div class="grid md:grid-cols-3 gap-4 mb-3">
      <select id="driverSelect" class="input">
        <option value="">Seleccione Conductor</option>
      </select>

      <select id="driverVehicleSelect" class="input">
        <option value="">Seleccione Veh√≠culo</option>
      </select>

      <input type="date" id="driverDateSelect" class="input" />
    </div>
    <button id="searchAssignmentsBtn" class="btn btn-primary">üîç Buscar</button>
  </div>

<!-- üßë‚Äç‚úàÔ∏è Info del Conductor (Enhanced Visual Layout) -->
<div id="driverInfoCard" class="card mb-6 hidden flex items-center gap-4 p-4 border-2 border-blue-700 rounded-xl shadow-sm bg-white">
  <div class="relative">
    <img id="driverPhoto" src="" alt="Foto del conductor"
  class="w-18 h-18 rounded-full border-4 border-blue-600 shadow-md object-cover" />
    <span id="driverStatusBadge"
      class="absolute bottom-0 right-1 bg-green-500 text-white text-xs px-2 py-1 rounded-full shadow-md font-semibold">
      ACTIVO
    </span>
  </div>
  <div class="flex-1">
    <h3 id="driverName" class="text-2xl font-bold text-blue-800 mb-1"></h3>
    <p id="driverLicense" class="text-gray-700"></p>
    <p id="driverExpiry" class="text-gray-700 mb-2"></p>
    <div id="driverVehicleTags" class="flex flex-wrap gap-2"></div>
  </div>
</div>
  <!-- üìã Tabla de Asignaciones -->
  <div class="card">
    <h3 class="text-xl font-semibold mb-3">Historial de Conducci√≥n (√∫ltimos 10 meses)</h3>
    <table id="driverAssignmentsTable" class="styled-table w-full text-sm border">
      <thead>
        <tr class="bg-blue-50 border-b">
          <th>Fecha</th>
          <th>Conductor</th>
          <th>Veh√≠culo</th>
          <th>Matr√≠cula</th>
          <th>Km Inicio</th>
          <th>Km Fin</th>
          <th>Observaciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- ======================================================
     ‚õΩ TAB: CONSUMO DE COMBUSTIBLE
====================================================== -->
<div id="consumptionTab" class="tabcontent hidden">
  <div class="card mb-6">
    <h2 class="text-2xl font-semibold text-blue-800">Consumo de Combustible</h2>
    <p class="text-sm text-gray-600">
      Seguimiento mensual de litros y costos de combustible por veh√≠culo.
    </p>
  </div>

<!-- ====================== CONTROLES ====================== -->
<div class="card mb-6 flex flex-wrap items-center gap-4">
  <label for="consumptionMetric" class="font-medium">Mostrar en:</label>
  <select id="consumptionMetric" class="input">
    <option value="liters">Litros</option>
    <option value="cost">Costo (XAF)</option>
  </select>

  <label for="consumptionVehicleSelect" class="font-medium">Veh√≠culo:</label>
  <select id="consumptionVehicleSelect" class="input"></select>

  <label for="consumptionMonthSelect" class="font-medium">Mes:</label>
  <select id="consumptionMonthSelect" class="input">
    <option value="all">Todos</option>
    <option value="Enero">Enero</option>
    <option value="Febrero">Febrero</option>
    <option value="Marzo">Marzo</option>
    <option value="Abril">Abril</option>
    <option value="Mayo">Mayo</option>
    <option value="Junio">Junio</option>
    <option value="Julio">Julio</option>
    <option value="Agosto">Agosto</option>
    <option value="Septiembre">Septiembre</option>
    <option value="Octubre">Octubre</option>
  </select>

  <div class="flex items-center gap-2 ml-auto">
    <label for="comparisonMode" class="font-medium">Modo Comparativo:</label>
    <input type="checkbox" id="comparisonMode" class="w-5 h-5 accent-blue-600">
  </div>
</div>

  <!-- ====================== GR√ÅFICO ====================== -->
  <div class="card mb-6">
    <h3 class="text-xl font-semibold text-blue-800 mb-3">Tendencia de Consumo Mensual</h3>
    <canvas id="consumptionChart" width="400" height="200"></canvas>
  </div>

  <!-- ====================== HISTORIAL ====================== -->
  <div class="card">
    <h3 class="text-xl font-semibold mb-3">Historial Detallado</h3>
    <table id="consumptionHistoryTable" class="styled-table w-full text-sm border">
      <thead>
        <tr class="bg-blue-50 border-b">
          <th>Mes</th>
          <th>Litros</th>
          <th>Costo (XAF)</th>
          <th>Distancia (km)</th>
          <th>Rendimiento (km/L)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
    <div id="gestionTab" class="tabcontent hidden">
      <div class="card">
        <h3 class="text-lg font-semibold text-blue-800 mb-3">Gesti√≥n de Flota</h3>
        <p class="text-gray-500 mb-4">Administra el estado de los veh√≠culos (alta/baja).</p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="bg-white border border-gray-300 rounded p-4">
            <h4 class="font-semibold mb-2">Dar de Alta/Editar</h4>
            <p class="text-sm text-gray-600">Formulario para a√±adir nuevos veh√≠culos o editar datos clave.</p>
            <button class="mt-3 px-3 py-1 bg-blue-600 text-white rounded text-sm" onclick="showTab(event, 'newVehicleFormTab')">Ir a Formulario</button>
          </div>
          <div class="bg-white border border-gray-300 rounded p-4">
            <h4 class="font-semibold mb-2">Dar de Baja</h4>
            <p class="text-sm text-gray-600">Marcar un veh√≠culo como vendido o fuera de servicio.</p>
            <button class="mt-3 px-3 py-1 bg-blue-600 text-white rounded text-sm" onclick="document.getElementById('modalBaja').classList.remove('hidden')">Gestionar Baja</button>
          </div>
        </div>
      </div>
    </div>


  </div> <div id="modalBaja" class="modal hidden" aria-hidden="true">
    <div class="modal-content">
      <h3 class="text-lg font-semibold mb-1">Dar de baja veh√≠culo</h3>
      <p class="text-sm text-gray-600 mb-3">Se marcar√° como ‚ÄúEn baja‚Äù. Los historiales se mantienen.</p>
      <label class="block text-sm font-medium">Motivo</label>
      <select id="motivoBaja" class="w-full border rounded-md p-2 mb-2">
        <option value="">-- Selecciona --</option>
        <option>Venta</option><option>Siniestro</option><option>Decomiso/Entrega</option>
        <option>Fuera de servicio</option><option>Otro</option>
      </select>
      <label class="block text-sm font-medium">Fecha</label>
      <input type="date" id="fechaBaja" class="w-full border rounded-md p-2 mb-2">
      <label class="block text-sm font-medium">Observaciones (opcional)</label>
      <textarea id="observacionesBaja" rows="3" class="w-full border rounded-md p-2"></textarea>
      <div class="flex justify-end gap-2 mt-3">
        <button id="cancelarBajaBtn" class="sidebar-button" style="background:#e5e7eb;color:#111;border-color:#e5e7eb">Cancelar</button>
        <button id="confirmarBajaBtn" class="sidebar-button">Confirmar baja</button>
      </div>
    </div>
  </div>
  
  <div id="viewer3DModal" class="modal hidden" aria-hidden="true">
    <div class="modal-content">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Vista del veh√≠culo</h3>
        <button id="viewer3DClose" class="modal-close" aria-label="Cerrar">‚úï</button>
      </div>
      <div id="viewer3DContainer" class="viewer3d-box"></div>
    </div>
  </div>
  
  <script>
  window.addEventListener("DOMContentLoaded", () => {
    const modal = document.getElementById("viewer3DModal");
    const closeBtn = document.getElementById("viewer3DClose");

    if (!modal || !closeBtn) {
      console.warn("‚ö†Ô∏è viewer3DModal or viewer3DClose not found.");
      return;
    }

    function closeViewer3DModal() {
      console.log("‚ùé Closing 3D modal...");
      modal.classList.add("hidden");
      modal.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
      const c = document.getElementById("viewer3DContainer");
      if (c) c.innerHTML = "";
    }

    // ‚úï close button
    closeBtn.addEventListener("click", closeViewer3DModal);

    // Backdrop click (only outside .modal-content)
    modal.addEventListener("click", (e) => {
      if (e.target === modal) closeViewer3DModal();
    });

    // ESC key
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && !modal.classList.contains("hidden")) {
        closeViewer3DModal();
      }
    });

    console.log("‚úÖ 3D modal close listeners attached.");
  });
  </script>

 

{% endblock %}{% block extra_scripts %}
<!-- ======================================================
     Firebase (compat v9) + Chart.js
====================================================== -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ======================================================
   1Ô∏è‚É£ FIREBASE INITIALIZATION
====================================================== */
const firebaseConfig = {
  apiKey: "AIzaSyBTehSBePV6bjKkI_htP6NsU4agckkSOrE",
  authDomain: "atiempo-9f08a.firebaseapp.com",
  projectId: "atiempo-9f08a",
  storageBucket: "atiempo-9f08a.appspot.com",
  messagingSenderId: "221735208077",
  appId: "1:221735208077:web:28a3134fa23bd407a20ec4",
  measurementId: "G-NVPGWJQ9J6",
};

// ‚úÖ Initialize Firebase
if (!firebase.apps.length) {
  firebase.initializeApp(firebaseConfig);
  console.log("üî• Firebase initialized (ATiempo project)");
} else {
  console.log("‚ö†Ô∏è Firebase already initialized ‚Äî using existing instance");
}

/* ======================================================
   2Ô∏è‚É£ BACKEND CONFIG (load backend_config.json)
====================================================== */
let backendBaseUrl = "http://127.0.0.1:5000"; // fallback
let __configLoaded = false;

async function loadBackendConfig() {
  try {
    const res = await fetch("backend_config.json", { cache: "no-store" });
    if (res.ok) {
      const cfg = await res.json();
      backendBaseUrl = `http://${cfg.host}:${cfg.port}`;
      console.log("[FLOTA] ‚úÖ backendBaseUrl:", backendBaseUrl);
    } else {
      console.warn("[FLOTA] ‚ö†Ô∏è backend_config.json not found ‚Äî using fallback:", backendBaseUrl);
    }
  } catch (e) {
    console.warn("[FLOTA] ‚ö†Ô∏è Failed to load backend_config.json:", e);
  } finally {
    __configLoaded = true;
  }
}

function api(path) {
  if (!path.startsWith("/")) path = "/" + path;
  return backendBaseUrl + path;
}

async function ensureConfig() {
  if (!__configLoaded) await loadBackendConfig();
}


/* ======================================================
   üîë TOKEN MANAGEMENT (Safe + Cached)
====================================================== */
let firebaseIdToken = null;
let lastTokenRefresh = 0;
const TOKEN_LIFETIME_MS = 50 * 60 * 1000; // ~50 min

async function getValidToken(force = false) {
  const user = firebase.auth().currentUser;
  if (!user) throw new Error("Usuario no autenticado.");

  const now = Date.now();
  if (!firebaseIdToken || force || now - lastTokenRefresh > TOKEN_LIFETIME_MS) {
    firebaseIdToken = await user.getIdToken(force);
    lastTokenRefresh = now;
    console.log("üîê Token actualizado:", new Date(now).toLocaleTimeString());
  }
  return firebaseIdToken;
}

/* ======================================================
   üåê makeAuthenticatedRequest (final stable)
====================================================== */
async function makeAuthenticatedRequest(url, method = "GET", body = null, retry = true) {
  try {
    const token = await getValidToken(); // ‚úÖ use cached token if valid

    const opts = {
      method,
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json",
      },
    };
    if (body) opts.body = JSON.stringify(body);

    const res = await fetch(api(url), opts);

    // If token expired, refresh only once
    if ((res.status === 401 || res.status === 403) && retry) {
      console.warn("‚ö†Ô∏è Token posiblemente expirado ‚Äî intentando refrescar...");
      const fresh = await getValidToken(true);
      opts.headers["Authorization"] = `Bearer ${fresh}`;
      return await makeAuthenticatedRequest(url, method, body, false);
    }

    let data;
    try {
      data = await res.json();
    } catch {
      data = { status: "error", message: "Respuesta no v√°lida del servidor." };
    }

    return data;
  } catch (err) {
    console.error("‚ùå makeAuthenticatedRequest() fall√≥:", err);
    return { status: "error", message: err.message || "Error desconocido" };
  }
}

/* ======================================================
   üöó LOAD VEHICLES (Stable)
====================================================== */
async function loadVehicles() {
  try {
    showLoadingIndicator();
    const result = await makeAuthenticatedRequest("/api/vehicles", "GET");

    if (result.status === "success" && Array.isArray(result.vehicles)) {
      currentAllVehicles = result.vehicles;
      renderVehicleList(result.vehicles);
      populateDecommissionDropdown(result.vehicles);
      populateTrackingDropdown(result.vehicles);
      console.log("[FLOTA] üöó Veh√≠culos cargados correctamente");
    } else {
      showToast("Error al cargar veh√≠culos: " + (result.message || "Error desconocido"), "error");
    }
  } catch (e) {
    console.error("[FLOTA] ‚ùå Error en loadVehicles:", e);
    showToast("Error de red al cargar veh√≠culos: " + e.message, "error");
  } finally {
    hideLoadingIndicator();
  }
}

/* ======================================================
   üë§ Wait for Firebase Session (auth init)
====================================================== */
document.addEventListener("DOMContentLoaded", () => {
  console.log("‚è≥ Esperando sesi√≥n Firebase...");

  const msg = document.getElementById("authMessage");
  if (msg) msg.textContent = "Autenticando...";

  firebase.auth().onAuthStateChanged(async (user) => {
    if (!user) {
      console.warn("‚ö†Ô∏è No hay usuario autenticado. Mostrando UI limitada.");
      if (msg) msg.textContent = "No autenticado. Funcionalidad limitada.";
      document.getElementById("fleetContent")?.classList.remove("hidden");
      return;
    }

    console.log("‚úÖ Sesi√≥n Firebase lista:", user.email);
    if (msg) msg.classList.add("hidden");
    document.getElementById("fleetContent")?.classList.remove("hidden");

  try {
  // ‚úÖ Load backend config BEFORE anything else
  await ensureConfig();
  console.log("[FLOTA] ‚úÖ Configuraci√≥n backend cargada:", backendBaseUrl);

  // ‚úÖ Refresh token once at login
  await getValidToken(true);
  console.log("üîê Token inicial actualizado correctamente.");

  // ‚úÖ Now call the backend safely
  await loadVehicles();
  console.log("[FLOTA] üöó Veh√≠culos cargados y UI inicializada.");

  if (typeof populateVehicleSelector === "function") await populateVehicleSelector();
} catch (err) {

      console.error("‚ùå Error inicializando flota:", err);
      if (msg) msg.textContent = "Error de autenticaci√≥n: " + (err.message || "Token inv√°lido.");
    }
  });
});
</script>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>


  // Globals
  let currentUser = null;
  let selectedVehicleId = null;
  let currentVehicleData = {};
  let currentAllVehicles = [];
  let trackingIntervalId = null;
  let vehiclePositions = {};
  let map;
  let markers = {};

  const vehiclesById = new Map();  // üîπ quick lookup by id
  // Global offset cache for vehicles (used by tracking)
const vehicleGeographicOffsets = {};


// --- NEW: Add placeholder/utility for the missing showToast function ---
function showToast(message, type = "info") {
  const statusMessage = document.getElementById("statusMessage");
  if (!statusMessage) return;

  statusMessage.textContent = message;
  statusMessage.className = "status-message " + (
    type === "success" ? "status-success" : 
    type === "error" ? "status-error" : 
    type === "warning" ? "status-warning" : ""
  );
  statusMessage.classList.remove("hidden");
  
  // üîë FIX: Add the missing timeout logic to hide it after a few seconds
  // This prevents the code that calls removeChild on a non-existent element from running later.
  setTimeout(() => statusMessage.classList.add("hidden"), 5000);
}
window.showToast = showToast; // Expose globally for event handlers


/* ======================================================
   GOOGLE MAPS LOADING AND INITIALIZATION (MALABO CENTER)
   ====================================================== */

function loadGoogleMapsAPI() {
  if (window.google && window.google.maps) {
    console.log("‚úÖ Google Maps API already loaded");
    return Promise.resolve();
  }

  return new Promise((resolve, reject) => {
    const existing = document.querySelector("script[data-google-maps]");
    if (existing) {
      existing.addEventListener("load", resolve);
      existing.addEventListener("error", reject);
      return;
    }

    const script = document.createElement("script");
    // ‚úÖ Include marker library
    script.src =
      "https://maps.googleapis.com/maps/api/js?key=AIzaSyAzv15trZrk9-TTsNgzK5tL0IuMeh_3INI&callback=initMap&libraries=geometry,places,marker";
    script.async = true;
    script.defer = true;
    script.dataset.googleMaps = "true";

    script.onload = () => {
      console.log("‚úÖ Google Maps API loaded (with marker library)");
      resolve();
    };
    script.onerror = (err) => {
      console.error("‚ùå Failed to load Google Maps API", err);
      reject(err);
    };

    document.head.appendChild(script);
  });
}

// ======================================================
//  Initialize Google Map ‚Äî Centered on Malabo
// ======================================================
async function initMap() {
  try {
    const mapElement = document.getElementById("map");
    if (!mapElement) {
      console.warn("‚ö†Ô∏è No se encontr√≥ el contenedor del mapa (#map)");
      return;
    }

    map = new google.maps.Map(mapElement, {
      center: { lat: 3.75, lng: 8.78 },
      zoom: 13,
      mapId: "gestion_flota", // ‚úÖ REQUIRED for Advanced Markers
      mapTypeControl: true,
      streetViewControl: false,
      fullscreenControl: true,
      gestureHandling: "greedy",
    });

    // ‚úÖ Persistent Malabo center marker
    new google.maps.Marker({
      position: { lat: 3.75, lng: 8.78 },
      map,
      title: "Malabo, Guinea Ecuatorial",
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        fillColor: "#004080",
        fillOpacity: 1,
        strokeColor: "#ffffff",
        strokeWeight: 2,
        scale: 6,
      },
    });

    mapInitialized = true;
    console.log("‚úÖ Google Map inicializado correctamente (Malabo)");

    google.maps.event.addListenerOnce(map, "tilesloaded", () => {
      console.log("üó∫Ô∏è Mapa centrado en Malabo y completamente cargado");
    });
  } catch (err) {
    console.error("‚ùå Error al inicializar el mapa:", err);
  }
}

// ======================================================
//  Initialization Sequence on Page Load
// ======================================================
window.addEventListener("load", async () => {
  try {
    await loadGoogleMapsAPI();

    // Wait until google.maps is fully available
    for (let i = 0; i < 10; i++) {
      if (window.google && window.google.maps) break;
      await new Promise((r) => setTimeout(r, 100));
    }

    if (!window.google || !window.google.maps)
      throw new Error("Google Maps API not fully attached.");

    await initMap();
  } catch (err) {
    console.error("‚ùå Error during Google Maps init sequence:", err);
  }
});


// ---- marker anti-overlap + helpers ----
let offsetsAssigned = false;
const vehicleMarkerOffsets = Object.create(null);

/** deterministic tiny jitter per vehicle id */
function assignVehicleOffsets(list = currentAllVehicles) {
  if (!Array.isArray(list) || !list.length) return;
  list.forEach(v => {
    const id = String(v.id ?? '');
    // hash id ‚Üí small offset (‚âà 10‚Äì20m)
    let h = 0;
    for (let i = 0; i < id.length; i++) { h = ((h << 5) - h) + id.charCodeAt(i); h |= 0; }
    const dx = ((h % 7) - 3) * 0.00015;             // lng
    const dy = ((((h / 7) | 0) % 7) - 3) * 0.00015; // lat
    vehicleMarkerOffsets[id] = { dx, dy };
  });
  offsetsAssigned = true;
}

function applyOffsetToPosition(vehicleId, lat, lng) {
  const off = vehicleMarkerOffsets[String(vehicleId)];
  return off ? { lat: lat + off.dy, lng: lng + off.dx } : { lat, lng };
}

// ============================
// SELECTION HANDLER
// ============================

function handleVehicleSelectionChange() {
  const selector = document.getElementById("vehicleSelector");
  const selectedValue = selector.value;

  stopTracking(); // Always clear previous tracking first

  if (selectedValue === "all") {
    console.log("üåç Iniciando rastreo de todos los veh√≠culos");
    startTrackingAllVehicles();
  } else {
    console.log(`üöó Iniciando rastreo de veh√≠culo ${selectedValue}`);
    startTrackingSingleVehicle(selectedValue);
  }
}

// ======================================================
//  WIRE VEHICLE SELECTOR TO TRACKING FUNCTION
// ======================================================
document.addEventListener("DOMContentLoaded", () => {
  const selector = document.getElementById("vehicleSelector");
  if (selector) {
    selector.addEventListener("change", handleVehicleSelectionChange);
    console.log("‚úÖ Vehicle selector listener attached.");
  } else {
    console.warn("‚ö†Ô∏è vehicleSelector not found in DOM at load.");
  }
});


function showSubTab(tabId) {
  console.warn("showSubTab() called for:", tabId);
}


/** Works for both AdvancedMarkerElement and classic Marker */
function setMarkerMap(marker, mapInstance) {
  if (!marker) return;
  if ('map' in marker) {
    // AdvancedMarkerElement
    marker.map = mapInstance || null;
  } else if (typeof marker.setMap === 'function') {
    // google.maps.Marker
    marker.setMap(mapInstance || null);
  }
}

/** Marker DOM content ‚Äì inline SVG keeps CSP happy (no external images) */
function buildMarkerContentForVehicle(vehicleId) {make
  // Use the palette defined globally
  const palette = window.vehicleIconPalette || [];
  
  // Get the global override map
  const overrides = window.vehicleColorOverrides || {};

  // üß© compute a hash (same logic as before)
  let hash = 0;
  for (let i = 0; i < vehicleId.length; i++) {
    hash = (hash + vehicleId.charCodeAt(i)) % 997;
  }

  // üé® Pick icon: 1. Manual Override, 2. Hash lookup
  const icon = overrides[vehicleId] || palette[hash % palette.length];

  // üß± Marker Wrapper (Outer Circle/Shadow)
  const wrapper = document.createElement("div");
  wrapper.className = "vehicle-marker-icon-container"; // Use a unique class for targeting
  wrapper.style.width = "40px"; // Slightly larger wrapper for the SVG
  wrapper.style.height = "40px";
  wrapper.style.display = "flex";
  wrapper.style.alignItems = "center";
  wrapper.style.justifyContent = "center";
  wrapper.style.borderRadius = "50%";
  wrapper.style.backgroundColor = icon.bg;
  wrapper.style.boxShadow = `0 0 10px ${icon.bg}`;
  wrapper.style.transition = "transform 0.5s linear";
  wrapper.style.overflow = "hidden"; // Clip sharp edges of SVG if needed

  // üöó SVG Container (Inner Element)
  const innerSvgContainer = document.createElement("div");
  // The glyph now contains the full SVG string, so we use innerHTML
  innerSvgContainer.innerHTML = icon.glyph;
  
  // Set the SVG to take up the wrapper space, possibly rotating the SVG itself
  // Note: We remove the wrapper's innerText/emoji content.
  innerSvgContainer.style.width = "100%";
  innerSvgContainer.style.height = "100%";
  
  wrapper.appendChild(innerSvgContainer);
  
  // The outer wrapper is what Google Maps inserts into the DOM
  return wrapper;
}


function showTab(id) {
  // 1Ô∏è‚É£ Hide all tabs and deactivate all buttons
  document.querySelectorAll('.tabcontent').forEach(pane => {
    pane.classList.add('hidden');
    pane.style.display = 'none';
  });
  document.querySelectorAll('.tab .tablinks').forEach(btn => btn.classList.remove('active'));

  // 2Ô∏è‚É£ Show requested tab panel
  const pane = document.getElementById(id);
  if (pane) {
    pane.classList.remove('hidden');
    pane.style.display = 'block';
  }

  // 3Ô∏è‚É£ Mark the corresponding button as active
  const btn =
    document.querySelector(`.tab .tablinks[onclick*="'${id}'"]`) ||
    document.querySelector(`.tab .tablinks[data-target="${id}"]`);
  if (btn) btn.classList.add('active');

  // 4Ô∏è‚É£ Map / Tracking logic
  if (id === 'trackingTab') {
    const ensureMapReady = () => {
      if (window.map) {
        if (google?.maps?.event) google.maps.event.trigger(map, 'resize');
        try { map.setCenter(map.getCenter()); } catch (e) {
          console.warn("‚ö†Ô∏è Error setting map center:", e);
        }
      }
    };

    if (!window.mapInitialized && typeof initMap === 'function') {
      initMap();
    }

    requestAnimationFrame(ensureMapReady);
    if (typeof startTrackingAllVehicles === 'function') {
      setTimeout(startTrackingAllVehicles, 100);
    }
  } else {
    if (typeof stopTracking === 'function') stopTracking();
  }

  // 5Ô∏è‚É£ Content loading for management tabs
  switch (id) {
    case 'documentacionTab':
      if (typeof showDocumentacionTabContent === 'function') showDocumentacionTabContent();
      break;

    case 'maintenanceTab':
      // üîß Corrected to call real render functions
      if (typeof renderMaintenanceTab === 'function') renderMaintenanceTab();
      if (typeof renderMaintenanceChart === 'function') renderMaintenanceChart();
      break;

    case 'driversTab':
      if (typeof showDriversTabContent === 'function') showDriversTabContent();
      break;

    case 'consumptionTab':
      if (typeof showConsumoTabContent === 'function') showConsumoTabContent();
      break;

    case 'listVehiclesTab':
      if (
        typeof renderVehicleList === 'function' &&
        Array.isArray(window.currentAllVehicles) &&
        window.currentAllVehicles.length > 0
      ) {
        renderVehicleList(window.currentAllVehicles);
      }
      break;

    default:
      console.debug(`‚ÑπÔ∏è No specific render handler for tab: ${id}`);
      break;
  }
}

// ‚úÖ Global exposure for buttons / onclick
window.showTab = showTab;
window.openTab = (evt, id) => {
  evt?.preventDefault?.();
  showTab(id);
};

window.vehicleIconMap = window.vehicleIconMap || {};

window.vehicleIconPalette = window.vehicleIconPalette || [
  {
    bg: "#0ea5e9", // blue - sedan
    glyph: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 128" width="26" height="52">
      <rect x="18" y="8" width="28" height="112" rx="6" fill="#0ea5e9" stroke="#111" stroke-width="2"/>
      <rect x="20" y="20" width="24" height="20" fill="#444" rx="2"/>
      <rect x="20" y="88" width="24" height="20" fill="#444" rx="2"/>
      <circle cx="16" cy="28" r="4" fill="#222"/>
      <circle cx="48" cy="28" r="4" fill="#222"/>
      <circle cx="16" cy="100" r="4" fill="#222"/>
      <circle cx="48" cy="100" r="4" fill="#222"/>
    </svg>`
  },
  {
    bg: "#a78bfa", // violet - SUV
    glyph: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 128" width="26" height="52">
      <rect x="16" y="6" width="32" height="116" rx="8" fill="#a78bfa" stroke="#111" stroke-width="2"/>
      <rect x="18" y="18" width="28" height="24" fill="#333" rx="2"/>
      <rect x="18" y="86" width="28" height="24" fill="#333" rx="2"/>
      <circle cx="14" cy="28" r="4" fill="#111"/>
      <circle cx="50" cy="28" r="4" fill="#111"/>
      <circle cx="14" cy="100" r="4" fill="#111"/>
      <circle cx="50" cy="100" r="4" fill="#111"/>
    </svg>`
  },
  {
    bg: "#f59e0b", // amber - taxi
    glyph: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 128" width="26" height="52">
      <rect x="18" y="8" width="28" height="112" rx="6" fill="#f59e0b" stroke="#111" stroke-width="2"/>
      <rect x="20" y="20" width="24" height="18" fill="#222"/>
      <rect x="22" y="56" width="20" height="8" fill="#000"/>
      <rect x="20" y="90" width="24" height="18" fill="#222"/>
      <text x="32" y="64" text-anchor="middle" font-size="9" fill="#fff" font-family="sans-serif">TAXI</text>
    </svg>`
  },
  {
    bg: "#22c55e", // green - van
    glyph: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 128" width="26" height="52">
      <rect x="14" y="4" width="36" height="120" rx="10" fill="#22c55e" stroke="#111" stroke-width="2"/>
      <rect x="18" y="20" width="28" height="22" fill="#333" rx="2"/>
      <rect x="18" y="86" width="28" height="22" fill="#333" rx="2"/>
      <rect x="20" y="58" width="24" height="12" fill="#fff" opacity="0.5"/>
    </svg>`
  },
  {
    bg: "#ef4444", // red - police car
    glyph: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 128" width="26" height="52">
      <rect x="18" y="8" width="28" height="112" rx="6" fill="#ef4444" stroke="#111" stroke-width="2"/>
      <rect x="24" y="10" width="16" height="6" fill="#0044ff"/>
      <rect x="20" y="30" width="24" height="16" fill="#222"/>
      <rect x="20" y="86" width="24" height="16" fill="#222"/>
      <text x="32" y="66" text-anchor="middle" font-size="10" fill="#fff" font-family="sans-serif">POL</text>
    </svg>`
  },
  {
    bg: "#14b8a6", // teal - luxury sedan
    glyph: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 128" width="26" height="52">
      <rect x="16" y="6" width="32" height="116" rx="6" fill="#14b8a6" stroke="#111" stroke-width="2"/>
      <rect x="20" y="20" width="24" height="22" fill="#333"/>
      <rect x="20" y="86" width="24" height="22" fill="#333"/>
      <circle cx="32" cy="64" r="2" fill="#000" opacity="0.5"/>
    </svg>`
  }
];

window.vehiclePositions = window.vehiclePositions || {};


function simulateMovement(vehicleId, currentPos) {
    const malaboLat = 3.7500, malaboLng = 8.7800, maxDelta = 0.005;
    const pos = currentPos || {
      latitude: malaboLat + (Math.random() - 0.5) * maxDelta,
      longitude: malaboLng + (Math.random() - 0.5) * maxDelta
    };
    const newLat = pos.latitude + (Math.random() - 0.5) * maxDelta * 0.2;
    const newLng = pos.longitude + (Math.random() - 0.5) * maxDelta * 0.2;
    return {
      latitude: Math.max(3.7, Math.min(3.8, newLat)),
      longitude: Math.max(8.7, Math.min(8.9, newLng)),
      status: "En movimiento",
      speed_kmh: Math.floor(Math.random() * 60) + 10,
      timestamp: new Date().toISOString()
    };
  }

/* =========================
   DOM READY
========================= */
document.addEventListener('DOMContentLoaded', () => {
  // Wire decommission (baja) controls after the DOM exists
  initializeDecommissionControls();

  // Optional form listener (guarded)
  const newVehicleForm = document.getElementById('newVehicleForm');
  if (newVehicleForm) {
    newVehicleForm.addEventListener('submit', handleNewVehicleSubmit);
  }

  // Optional analysis period change listener (guarded)
  const analysisPeriodSelect = document.getElementById('analysisPeriod');
  if (analysisPeriodSelect) {
    analysisPeriodSelect.addEventListener('change', updateConsumptionAnalysis);
  }

  // Wire edit/save/cancel buttons in vehicle details (guarded)
  const editDetailsButton = document.getElementById('editVehicleDetailsBtn');
  const saveDetailsButton = document.getElementById('saveVehicleDetailsBtn');
  const cancelDetailsButton = document.getElementById('cancelVehicleDetailsBtn');

  if (editDetailsButton) editDetailsButton.onclick = () => toggleEditMode(true);
  if (saveDetailsButton) saveDetailsButton.onclick = saveVehicleDetails;
  if (cancelDetailsButton) cancelDetailsButton.onclick = cancelEdit;
});

/* =========================
   PUBLIC API ON WINDOW
========================= */
window.loadPage = function (url) { window.location.href = url; };
window.showTab = showTab;
window.openTab = openTab; // from earlier
window.showSubTab = showSubTab;
window.selectVehicle = selectVehicle;
window.deleteVehicle = deleteVehiclePermanently;
window.addMaintenanceEntry = addMaintenanceEntry;
window.addUsageEntry = addUsageEntry;
window.positionVehicle = positionVehicleOnMap;
window.lastVehiclePositions = window.lastVehiclePositions || {};


// ---- API base resolver (no trailing slash) ----
function resolveApiBase() {
  // 1) Explicit override via global or <meta name="api-base" content="https://api.example.com">
  if (window.API_BASE && typeof window.API_BASE === 'string') {
    return window.API_BASE.replace(/\/+$/, '');
  }
  const meta = document.querySelector('meta[name="api-base"]');
  if (meta?.content) {
    return meta.content.trim().replace(/\/+$/, '');
  }

  // 2) Electron / file:// fallback
  const { protocol, hostname } = window.location;
  if (protocol === 'file:') {
    // running inside Electron or opening the HTML directly
    return 'http://127.0.0.1:5001';
  }

  // 3) If we‚Äôre on localhost or a LAN IP, talk to the same host on :5001
  const host = hostname || '127.0.0.1';
  const likelyLAN =
    host === 'localhost' ||
    host === '127.0.0.1' ||
    /^192\.168\./.test(host) ||
    /^10\./.test(host) ||
    /^172\.(1[6-9]|2\d|3[0-1])\./.test(host);

  if (likelyLAN) {
    return `${window.location.protocol}//${host}:5001`;
  }

  // 4) Default: same origin (assumes you have a reverse proxy exposing /api on this origin)
  // If your backend is mounted at /api, you can return "" and prefix URLs with /api.
  return `${window.location.origin}`;
}

const API_BASE = resolveApiBase();


/* =========================
   DECOMMISSION (BAJA) CONTROLS
========================= */
function initializeDecommissionControls() {
  const vehicleSelectForDecommission = document.getElementById('deleteVehicleSelect');
  const decommissionButton = document.getElementById('deleteVehicleBtn');

  if (!vehicleSelectForDecommission || !decommissionButton) return;

  decommissionButton.textContent = 'Dar de baja';
  decommissionButton.disabled = !vehicleSelectForDecommission.value;

  vehicleSelectForDecommission.onchange = () => {
    decommissionButton.disabled = !vehicleSelectForDecommission.value;
  };

  decommissionButton.onclick = () => {
    const vehicleId = vehicleSelectForDecommission.value;
    if (!vehicleId) { alert('Selecciona un veh√≠culo.'); return; }
    openDecommissionModal(vehicleId);
  };
}

function populateDecommissionDropdown(vehicles) {
  const vehicleSelectForDecommission = document.getElementById('deleteVehicleSelect');
  const decommissionButton = document.getElementById('deleteVehicleBtn');
  if (!vehicleSelectForDecommission) return;

  vehicleSelectForDecommission.innerHTML = '<option value="">-- Seleccionar un veh√≠culo --</option>';

  (vehicles || []).forEach(vehicle => {
    const option = document.createElement('option');
    option.value = vehicle.id;
    option.textContent = `${vehicle.marca} ${vehicle.modelo} (${vehicle.matricula})`;
    vehicleSelectForDecommission.appendChild(option);
  });

  if (decommissionButton) {
    decommissionButton.disabled = !vehicleSelectForDecommission.value;
    vehicleSelectForDecommission.onchange = () => {
      decommissionButton.disabled = !vehicleSelectForDecommission.value;
    };
  }
}

function openDecommissionModal(vehicleId) {
  const modal = document.getElementById('modalBaja');
  const confirmButton = document.getElementById('confirmarBajaBtn');
  const cancelButton = document.getElementById('cancelarBajaBtn');
  if (!modal) return;

  modal.classList.remove('hidden');

  const close = () => modal.classList.add('hidden');
  cancelButton.onclick = close;

  confirmButton.onclick = async () => {
    const reason = document.getElementById('motivoBaja').value.trim();
    const date = document.getElementById('fechaBaja').value;
    const notes = document.getElementById('observacionesBaja').value.trim();

    if (!reason) { alert('Selecciona un motivo.'); return; }
    if (!date)   { alert('Selecciona la fecha de baja.'); return; }

    try {
      await decommissionVehicle(vehicleId, { reason, date, notes });
      close();
      document.getElementById('motivoBaja').value = '';
      document.getElementById('fechaBaja').value = '';
      document.getElementById('observacionesBaja').value = '';
      alert('Veh√≠culo dado de baja correctamente.');
      await loadVehicles();
      populateDecommissionDropdown(currentAllVehicles);
      showTab('listVehiclesTab');
    } catch (error) {
      console.error(error);
      alert('No se pudo completar la baja: ' + (error.message || 'Error'));
    }
  };
}

async function decommissionVehicle(vehicleId, decommissionData) {
  if (!vehicleId) throw new Error('ID de veh√≠culo no proporcionado');

  const payload = {
    estado: 'baja',
    fecha_baja: decommissionData.date,
    motivo_baja: decommissionData.reason,
    observaciones_baja: decommissionData.notes || null,
    actualizado_en: new Date().toISOString()
  };

  showLoadingIndicator();
  try {
    const response = await makeAuthenticatedRequest(`/api/vehicle/${vehicleId}`, 'PUT', payload);
    if (!response || response.status !== 'success') {
      throw new Error(response?.message || 'Respuesta inv√°lida del servidor');
    }
    if (selectedVehicleId === vehicleId) selectedVehicleId = null;
    return true;
  } finally {
    hideLoadingIndicator();
  }
}

/* =========================
   UI HELPERS
========================= */
function showLoadingIndicator() {
  const loadingIndicator = document.getElementById('loadingIndicator');
  if (loadingIndicator) loadingIndicator.classList.remove('hidden');
}

function hideLoadingIndicator() {
  const loadingIndicator = document.getElementById('loadingIndicator');
  if (loadingIndicator) loadingIndicator.classList.add('hidden');
}


/* =========================
   VEHICLE ICON HELPERS
========================= */
function getIconPaletteEntryForVehicle(vehicleId) {
  if (!vehicleIconMap[vehicleId]) {
    const index = Object.keys(vehicleIconMap).length % vehicleIconPalette.length;
    vehicleIconMap[vehicleId] = vehicleIconPalette[index];
  }
  return vehicleIconMap[vehicleId];
}


/* =========================
   API HELPERS (AUTH + SIMULATION)
========================= */
// define before makeAuthenticatedRequest
window.simulateMovement = function simulateMovement(vehicleId, currentPos) {
  const malaboLat = 3.7500, malaboLng = 8.7800, maxDelta = 0.005;
  const pos = currentPos || {
    latitude: malaboLat + (Math.random() - 0.5) * maxDelta,
    longitude: malaboLng + (Math.random() - 0.5) * maxDelta
  };
  const newLat = pos.latitude + (Math.random() - 0.5) * maxDelta * 0.2;
  const newLng = pos.longitude + (Math.random() - 0.5) * maxDelta * 0.2;
  return {
    latitude: Math.max(3.7, Math.min(3.8, newLat)),
    longitude: Math.max(8.7, Math.min(8.9, newLng)),
    status: "En movimiento",
    speed_kmh: Math.floor(Math.random() * 60) + 10,
    timestamp: new Date().toISOString()
  };
};

function simulateVehicleMovement(vehicleId, currentPosition) {
  const malaboLat = 3.7500;
  const malaboLng = 8.7800;
  const maxDelta = 0.005;

  const start = currentPosition || {
    latitude: malaboLat + (Math.random() - 0.5) * maxDelta,
    longitude: malaboLng + (Math.random() - 0.5) * maxDelta
  };

  const newLat = start.latitude + (Math.random() - 0.5) * maxDelta * 0.2;
  const newLng = start.longitude + (Math.random() - 0.5) * maxDelta * 0.2;

  return {
    latitude: Math.max(3.7, Math.min(3.8, newLat)),
    longitude: Math.max(8.7, Math.min(8.9, newLng)),
    status: 'En movimiento',
    speed_kmh: Math.floor(Math.random() * 60) + 10,
    timestamp: new Date().toISOString()
  };
}

function getApiBase() {
  const { protocol, hostname, port } = window.location;
  const isLocal = hostname === 'localhost' || hostname === '127.0.0.1';
  return isLocal ? 'http://localhost:5001' : `${protocol}//${hostname}${port ? ':' + port : ''}`;
}


// ============================
// VEHICLE DROPDOWN MANAGEMENT
// ============================

function populateTrackingDropdown(vehicles) {
  const dropdown = document.getElementById("vehicleSelect");
  if (!dropdown) {
    console.warn("‚ö†Ô∏è vehicleSelect dropdown not found in DOM.");
    return;
  }

  dropdown.innerHTML = '<option value="">‚Äî Seleccione un veh√≠culo ‚Äî</option>';

  if (!Array.isArray(vehicles) || !vehicles.length) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "No hay veh√≠culos disponibles";
    dropdown.appendChild(opt);
    return;
  }

  vehicles.forEach(v => {
    const opt = document.createElement("option");
    opt.value = v.id;
    opt.textContent = `${v.marca || ""} ${v.modelo || ""} (${v.matricula || "sin matr√≠cula"})`;
    dropdown.appendChild(opt);
  });
}


async function populateVehicleSelector() {
  const selector = document.getElementById("vehicleSelector");
  if (!selector) return;

  selector.innerHTML = `<option value="all">Ver Todos los Veh√≠culos</option>`;

  try {
    const result = await makeAuthenticatedRequest("/api/vehicles", "GET");
    if (result.status === "success" && Array.isArray(result.vehicles)) {
      result.vehicles.forEach(vehicle => {
        const opt = document.createElement("option");
        opt.value = vehicle.id;
        opt.textContent = `${vehicle.marca || ""} ${vehicle.modelo || ""} (${vehicle.matricula || "sin placa"})`;
        selector.appendChild(opt);
      });
    } else {
      console.warn("‚ö†Ô∏è No se pudieron cargar los veh√≠culos:", result.message);
    }
  } catch (err) {
    console.error("‚ùå Error cargando lista de veh√≠culos:", err);
  }
}


function renderVehicles(vehicles) {
  const container = document.getElementById("vehiclesContainer");
  container.innerHTML = "";

  vehicles.forEach((v, index) => {
    const card = document.createElement("div");
    card.classList.add("vehicle-card");

    card.innerHTML = `
      <img src="${v.foto_url || '/static/assets/no-image.png'}" 
           alt="Foto del veh√≠culo" class="vehicle-photo">
      <h3>${v.marca || "Veh√≠culo sin marca"} ${v.modelo || ""}</h3>
      <p><strong>Matr√≠cula:</strong> ${v.matricula || "Desconocida"}</p>
      <p><strong>Uso:</strong> ${v.uso || "No especificado"}</p>
      <div class="vehicle-actions">
        <button class="view-btn" onclick="openVehicle3D('${v.id}')">Ver Detalles</button>
        <button class="map-btn" onclick="viewPosition('${v.id}')">Ver Posici√≥n</button>
      </div>
    `;
    container.appendChild(card);
  });
  attachVehicleImageListeners();

}

function renderVehicleList(vehicles) {
  const listContainer = document.getElementById('vehicleListContainer');
  const emptyMessage = document.getElementById('noVehiclesMessage');
  if (!listContainer) return;

  listContainer.innerHTML = '';

  if (!vehicles || vehicles.length === 0) {
    emptyMessage?.classList.remove('hidden');
    return;
  }
  emptyMessage?.classList.add('hidden');

  vehicles
    .slice()
    .sort((a, b) => new Date(b.fecha_de_adquisicion || '1970-01-01') - new Date(a.fecha_de_adquisicion || '1970-01-01'))
    .forEach((vehicle, index) => {
      const card = document.createElement('div');
      card.className = 'vehicle-card';
      card.innerHTML = `
        <img src="${vehicle.foto || 'https://placehold.co/220x160?text=Sin+foto'}"
             alt="${vehicle.marca || ''} ${vehicle.modelo || ''}"
             class="vehicle-thumb">
        <h3>${index + 1}. ${vehicle.a√±o || 'N/A'} ${vehicle.marca || 'N/A'} ${vehicle.modelo || 'N/A'}</h3>
        <p>Matr√≠cula: ${vehicle.matricula || 'N/A'}</p>
        <div class="button-group" style="margin-top:10px">
          <button class="edit" onclick="selectVehicle('${vehicle.id}')">Ver Detalles</button>
          <button class="btn-secondary" onclick="viewVehiclePosition('${vehicle.id}')">Ver Posici√≥n</button>
        </div>
      `;
      listContainer.appendChild(card);
    });
    attachVehicleImageListeners();

}

function renderAllVehicles(vehicles) {
  try {
    // Call both renderers safely (whichever exists and container is found)
    if (typeof renderVehicleList === "function") {
      renderVehicleList(vehicles);
    }
  } catch (err) {
    console.warn("‚ö†Ô∏è renderVehicleList failed:", err);
  }

  try {
    if (typeof renderVehicles === "function") {
      renderVehicles(vehicles);
    }
  } catch (err) {
    console.warn("‚ö†Ô∏è renderVehicles failed:", err);
  }

  // ‚úÖ Attach image click listener for 3D viewer
  setTimeout(() => {
    document.querySelectorAll(".vehicle-photo, .vehicle-thumb").forEach(img => {
      img.style.cursor = "zoom-in";
      img.addEventListener("click", () => {
        const id = img.dataset.id || img.getAttribute("data-id");
        const v = getVehicleById?.(id) || window.currentVehicleData;
        if (v) {
          open3DOrImageViewer(v, v.foto || v.foto_url || img.src);
        } else {
          console.warn("‚ö†Ô∏è No vehicle data found for 3D view.");
        }
      });
    });
  }, 100);
}


async function handleNewVehicleSubmit(event) {
  event.preventDefault();

  const payload = {
    matricula: document.getElementById('newVehicleMatricula').value,
    marca: document.getElementById('newVehicleMarca').value,
    modelo: document.getElementById('newVehicleModel').value,
    a√±o: parseInt(document.getElementById('newVehicleYear').value, 10),
    color: document.getElementById('newVehicleColor').value,
    vin: document.getElementById('newVehicleVin').value,
    tipo: document.getElementById('newVehicleTipo').value || 'N/A',
    foto: document.getElementById('newVehiclePhotoUrl').value || '',
    fecha_de_adquisicion: new Date().toISOString().split('T')[0]
  };

  try {
    showLoadingIndicator();
    const response = await makeAuthenticatedRequest('/api/vehicles', 'POST', payload);
    if (response.status === 'success') {
      alert('Veh√≠culo registrado con √©xito!');
      event.target.reset();
      showTab('listVehiclesTab');
      await loadVehicles();
      populateDecommissionDropdown(currentAllVehicles);
    } else {
      alert('Error al registrar el veh√≠culo: ' + (response.message || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error registering new vehicle:', error);
    alert('Error de red al registrar el veh√≠culo: ' + error.message);
  } finally {
    hideLoadingIndicator();
  }
}


function getVehicleById(id){
  if (id == null) return null;
  const key = String(id);

  // 1) Map cache (filled in loadVehicles)
  if (typeof vehiclesById !== 'undefined' && vehiclesById.has(key)) {
    return vehiclesById.get(key);
  }

  // 2) Fallback to the array the list was rendered from
  if (Array.isArray(currentAllVehicles)) {
    const v = currentAllVehicles.find(x => String(x.id) === key);
    if (v) {
      try { vehiclesById.set(key, v); } catch {}
      return v;
    }
  }

  // 3) Nothing
  return null;
}


/* =========================
   VEHICLE DETAILS VIEW / EDIT
========================= */

async function selectVehicle(vehicleId) {
  window.selectedVehicleId = vehicleId;

  // üîπ Default sub-tab logic removed ‚Äî no subtabs exist anymore
  // try { showSubTab('documentacionSubTab'); } catch {}

  // 1Ô∏è‚É£ If we have a cached copy, show it immediately (for snappy UI)
  const cached = getVehicleById(vehicleId);
  if (cached) {
    currentVehicleData = cached;
    try {
      populateVehicleDetailsView(cached);
    } catch (e) {
      console.warn("‚ö†Ô∏è populateVehicleDetailsView (cached) failed:", e);
    }

    const detailsBtn = document.getElementById("detailsTabBtn");
    if (detailsBtn) detailsBtn.classList.remove("hidden");

    // open the tab right away (no tracking start)
    showTab("detailsTab", false);
  }

  // 2Ô∏è‚É£ Fetch latest data from the backend
  try {
    showLoadingIndicator();

    const res = await makeAuthenticatedRequest(`/api/vehicle/${vehicleId}`, "GET");
    if (res?.status === "success" && res.vehicle) {
      currentVehicleData = res.vehicle;

      try {
        vehiclesById.set(String(vehicleId), res.vehicle);
      } catch {}

      try {
        populateVehicleDetailsView(res.vehicle);
      } catch (e) {
        console.warn("‚ö†Ô∏è populateVehicleDetailsView (API) failed:", e);
      }

      const detailsBtn = document.getElementById("detailsTabBtn");
      if (detailsBtn) detailsBtn.classList.remove("hidden");

      showTab("detailsTab", false);
    } else if (!cached) {
      alert("No se pudieron cargar los detalles del veh√≠culo.");
    }
  } catch (e) {
    console.error("‚ùå selectVehicle failed:", e);
    if (!cached)
      alert("Error al cargar los detalles del veh√≠culo: " + (e.message || e));
  } finally {
    hideLoadingIndicator();
  }
}

/**
 * Switches to the Posicionamiento tab and starts tracking one vehicle.
 */
function viewVehiclePosition(vehicleId) {
  try {
    // Switch to Posicionamiento tab
    showTab("trackingTab");

    // Small delay ensures the map is visible before drawing
    setTimeout(() => {
      console.log(`üöó Tracking vehicle: ${vehicleId}`);
      startTrackingSingleVehicle(vehicleId);
    }, 400);
  } catch (err) {
    console.error("Error showing vehicle position:", err);
    alert("No se pudo mostrar la posici√≥n del veh√≠culo.");
  }
}

// ============ 3D / Image Viewer ============

function attachVehicleImageListeners() {
  document.querySelectorAll(".vehicle-thumb, .vehicle-photo").forEach(img => {
    img.style.cursor = "pointer";
    img.removeEventListener("click", handleVehicleImageClick);
    img.addEventListener("click", handleVehicleImageClick);
  });
}

async function handleVehicleImageClick(event) {
  const img = event.currentTarget;
  const id = img.dataset.id || img.getAttribute("data-id");
  if (!id) {
    console.warn("‚ö†Ô∏è No vehicle ID found on thumbnail");
    return;
  }

  console.log(`üñ±Ô∏è Thumbnail clicked ‚Äî opening details for vehicle ${id}`);
  await selectVehicle(id); // ‚úÖ Only opens details view
}

function openVehicle3D(vehicleId) {
  const modal = document.getElementById("vehicle3DModal");
  const iframe = document.getElementById("vehicle3DViewer");
  const loader = document.getElementById("viewerLoader");

  loader.style.display = "block";
  iframe.style.display = "none";

  iframe.src = `/3d/vehicle_viewer.html?id=${vehicleId}`;
  modal.style.display = "flex";

  iframe.onload = () => {
    loader.style.display = "none";
    iframe.style.display = "block";
    console.log(`‚úÖ 3D viewer loaded for ${vehicleId}`);
  };
}

function closeVehicle3D() {
  const modal = document.getElementById("vehicle3DModal");
  const iframe = document.getElementById("vehicle3DViewer");
  if (modal) modal.style.display = "none";
  if (iframe) iframe.src = "";
}
// Utility: open/close modal
function openViewerModal() {
  const m = document.getElementById('viewer3DModal');
  if (!m) return;
  m.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}




// Pan/zoom fallback if no 3D model available
function attachPanZoom(wrapper, img) {
  let scale = 1, x = 0, y = 0, down = false, ox = 0, oy = 0;

  wrapper.addEventListener('wheel', (e) => {
    e.preventDefault();
    const delta = e.deltaY < 0 ? 0.1 : -0.1;
    scale = Math.max(0.2, Math.min(6, scale + delta));
    update();
  }, { passive: false });

  wrapper.addEventListener('pointerdown', (e) => {
    down = true;
    wrapper.setPointerCapture(e.pointerId);
    ox = e.clientX - x;
    oy = e.clientY - y;
  });
  wrapper.addEventListener('pointermove', (e) => {
    if (!down) return;
    x = e.clientX - ox;
    y = e.clientY - oy;
    update();
  });
  ['pointerup','pointercancel','pointerleave'].forEach(ev =>
    wrapper.addEventListener(ev, ()=> down = false)
  );

  function update(){
    img.style.transform = `translate(${x}px, ${y}px) scale(${scale})`;
  }
}

// Main entry: open 3D (GLB/GLTF) or Pan/Zoom image
function open3DOrImageViewer(vehicle, fallbackSrc) {
  const container = document.getElementById('viewer3DContainer');
  if (!container) return;

  // Prefer 3D model URL on the vehicle object
  // Expect fields like vehicle.photo3dUrl (glb/gltf) or vehicle.photoHiResUrl
  const modelUrl = vehicle?.photo3dUrl || vehicle?.model3dUrl;
  const imageUrl = vehicle?.photoHiResUrl || fallbackSrc;

  container.innerHTML = '';

  if (modelUrl) {
    // Real 3D
    container.innerHTML = `
      <model-viewer src="${modelUrl}"
        camera-controls
        auto-rotate
        shadow-intensity="1"
        exposure="1.0"
        style="width:100%;height:100%;background:#0b1020;">
      </model-viewer>`;
  } else {
    // Pan/zoom fallback (use hi-res if available)
    const url = imageUrl || '';
    container.innerHTML = `
      <div class="pz-wrap" id="pzWrap">
        <img id="pzImg" src="${url}" alt="Vista" draggable="false">
      </div>`;
    const wrap = document.getElementById('pzWrap');
    const img  = document.getElementById('pzImg');
    if (wrap && img) attachPanZoom(wrap, img);
  }

  openViewerModal();
}



// Click on the small image in Detalles -> open viewer
(function wireDetailsImageClick(){
  const img = document.getElementById('detail_vehicle_photo');
  if (!img) return;
  img.style.cursor = 'zoom-in';
  img.addEventListener('click', () => {
    const v = getVehicleById?.(window.selectedVehicleId);
    open3DOrImageViewer(v, img.src);
  });
})();

function safeSetTextContent(elementId, value, fallback = '---') {
  const element = document.getElementById(elementId);
  if (!element) return;
  element.textContent = (value === null || value === undefined || value === '') ? fallback : value;
}

function safeSetMoneyText(elementId, value, fallback = '---') {
  const element = document.getElementById(elementId);
  if (!element) return;
  element.textContent = (value === null || value === undefined || value === '') ? fallback : `FCFA ${value}`;
}

function attach3DViewerToDetailsImage() {
  const img = document.getElementById('detail_vehicle_photo');
  if (!img) return;

  img.style.cursor = 'zoom-in';
  img.onclick = async () => {
    const id = window.selectedVehicleId;
    if (!id) {
      console.warn("‚ö†Ô∏è No selectedVehicleId found.");
      return;
    }

    // Try cache first
    let v = getVehicleById?.(id);

    // üîπ Fallback: fetch fresh if not cached yet
    if (!v) {
      try {
        console.log(`‚è≥ Fetching vehicle ${id} for 3D view...`);
        const res = await makeAuthenticatedRequest(`/api/vehicle/${id}`, "GET");
        if (res?.status === "success" && res.vehicle) {
          v = res.vehicle;
          vehiclesById.set(String(id), v);
        }
      } catch (err) {
        console.error("‚ùå Error fetching vehicle for 3D view:", err);
      }
    }

    if (!v) {
      console.warn("‚ö†Ô∏è Still no vehicle data for 3D view.");
      return;
    }

    console.log(`üîç Opening 3D viewer for ${v.marca || "Veh√≠culo"} (${v.id})`);
    open3DOrImageViewer(v, v.foto || v.foto_url || img.src);
  };
}

// Re-attach listener every time details are shown
document.addEventListener("DOMContentLoaded", attach3DViewerToDetailsImage);


function populateVehicleDetailsView(vehicle) {
  // Header
  const photo = document.getElementById('detail_vehicle_photo');
  if (photo) photo.src = vehicle.foto || 'https://placehold.co/120';
  safeSetTextContent('detail_marca_modelo', `${vehicle.marca || 'N/A'} ${vehicle.modelo || 'N/A'}`);
  safeSetTextContent('detail_matricula_year', `${vehicle.matricula || 'N/A'} (${vehicle.a√±o || 'N/A'})`);

  // Basic fields
  safeSetTextContent('detail_matricula', vehicle.matricula);
  safeSetTextContent('detail_marca', vehicle.marca);
  safeSetTextContent('detail_modelo', vehicle.modelo);
  safeSetTextContent('detail_a√±o', vehicle.a√±o);
  safeSetTextContent('detail_color', vehicle.color);
  safeSetTextContent('detail_vin', vehicle.vin);
  safeSetTextContent('detail_tipo', vehicle.tipo);

  // Insurance
  safeSetTextContent('detail_insurance_compania', vehicle.seguro?.compania);
  safeSetTextContent('detail_insurance_poliza', vehicle.seguro?.poliza);
  safeSetTextContent('detail_insurance_vencimiento', vehicle.seguro?.vencimiento);

  // Documentation
  safeSetTextContent('detail_permiso_emision', vehicle.documentacion?.permiso_circulacion?.fecha_emision);
  safeSetTextContent('detail_permiso_vencimiento', vehicle.documentacion?.permiso_circulacion?.vencimiento);
  safeSetMoneyText('detail_permiso_costo', vehicle.documentacion?.permiso_circulacion?.costo);

  safeSetTextContent('detail_tasa_emision', vehicle.documentacion?.tasa_trafico_rodado?.fecha_emision);
  safeSetTextContent('detail_tasa_vencimiento', vehicle.documentacion?.tasa_trafico_rodado?.vencimiento);
  safeSetMoneyText('detail_tasa_costo', vehicle.documentacion?.tasa_trafico_rodado?.costo);

  // Maintenance history
  const maintenanceContainer = document.getElementById('maintenance_history');
  const maintenanceEmpty = document.getElementById('noMaintenanceMessage');
  if (maintenanceContainer) {
    maintenanceContainer.querySelectorAll('.maintenance-entry').forEach(el => el.remove());
    if (vehicle.mantenimiento?.length) {
      if (maintenanceEmpty) maintenanceEmpty.classList.add('hidden');
      vehicle.mantenimiento.forEach(entry => {
        const item = document.createElement('div');
        item.className = 'maintenance-entry';
        item.innerHTML = `
          <p><strong>Fecha:</strong> ${entry.date || '---'}</p>
          <p><strong>Descripci√≥n:</strong> ${entry.description || '---'}</p>
          <p><strong>Costo:</strong> ${entry.cost ? `FCFA ${entry.cost}` : '---'}</p>
        `;
        maintenanceContainer.appendChild(item);
      });
    } else if (maintenanceEmpty) {
      maintenanceEmpty.classList.remove('hidden');
    }
  }

  // Usage history table (by period)
  updateUsageTableForCurrentVehicle(vehicle);

  // Ensure mock data for charts exists
  if (!window.consumptionData) window.consumptionData = generateMockConsumptionData();

  // Kick analysis after a tick so DOM is settled
  setTimeout(() => updateConsumptionAnalysis(), 100);
  attach3DViewerToDetailsImage();

}

function updateUsageTableForCurrentVehicle(vehicle) {
  const tableBody = document.getElementById('usage_table_body');
  if (!tableBody) return;

  tableBody.innerHTML = '';

  if (!vehicle.uso?.length) {
    const row = tableBody.insertRow();
    row.innerHTML = `<td colspan="6" class="text-center text-gray-500 py-4">No hay registro de uso.</td>`;
    return;
  }

  const selectedPeriod = document.getElementById('analysisPeriod')?.value || 'all';
  const monthIndexMap = {
    january: 0, february: 1, march: 2, april: 3,
    may: 4, june: 5, july: 6, august: 7
  };

  let filtered = vehicle.uso.slice();
  if (selectedPeriod !== 'all') {
    const selectedIndex = monthIndexMap[selectedPeriod];
    filtered = filtered.filter(entry => new Date(entry.date).getMonth() === selectedIndex);
  }

  filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

  if (!filtered.length) {
    const row = tableBody.insertRow();
    row.innerHTML = `<td colspan="6" class="text-center text-gray-500 py-4">No hay datos para el per√≠odo seleccionado.</td>`;
    return;
  }

  filtered.forEach(u => {
    const consumptionLPer100 = u.km_recorridos > 0 ? (u.fuel / u.km_recorridos * 100).toFixed(1) : 'N/A';
    const costPerKm = u.km_recorridos > 0 ? (u.cost / u.km_recorridos).toFixed(0) : 'N/A';
    const date = new Date(u.date).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
    const row = tableBody.insertRow();
    row.innerHTML = `
      <td>${date}</td>
      <td class="text-right">${u.fuel || '---'} L</td>
      <td class="text-right">${u.km_recorridos || '---'} km</td>
      <td class="text-right">${consumptionLPer100} L/100km</td>
      <td class="text-right">${u.cost ? `FCFA ${u.cost.toLocaleString()}` : '---'}</td>
      <td class="text-right">${costPerKm !== 'N/A' ? `${costPerKm} FCFA/km` : '---'}</td>
    `;
  });
}

async function addMaintenanceEntry() {
  if (!selectedVehicleId) { alert('Selecciona un veh√≠culo.'); return; }
  const data = {
    date: document.getElementById('newMaintenanceDate').value,
    description: document.getElementById('newMaintenanceDescription').value,
    cost: parseFloat(document.getElementById('newMaintenanceCost').value) || 0
  };
  if (!data.date || !data.description) { alert('Rellena todos los campos.'); return; }

  try {
    showLoadingIndicator();
    const response = await makeAuthenticatedRequest(`/api/vehicle/${selectedVehicleId}/maintenance`, 'POST', data);
    if (response.status === 'success') {
      alert('Mantenimiento a√±adido con √©xito!');
      document.getElementById('newMaintenanceDate').value = '';
      document.getElementById('newMaintenanceDescription').value = '';
      document.getElementById('newMaintenanceCost').value = '';
      selectVehicle(selectedVehicleId);
    } else {
      alert('Error al a√±adir mantenimiento: ' + (response.message || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error adding maintenance:', error);
    alert('Error de red al a√±adir mantenimiento: ' + error.message);
  } finally {
    hideLoadingIndicator();
  }
}

async function addUsageEntry() {
  if (!selectedVehicleId) { alert('Selecciona un veh√≠culo.'); return; }
  const data = {
    date: document.getElementById('newUsageDate').value,
    fuel: parseFloat(document.getElementById('newUsageFuel').value) || 0,
    km_recorridos: parseFloat(document.getElementById('newUsageKm').value) || 0,
    cost: parseFloat(document.getElementById('newUsageCost').value) || 0
  };
  if (!data.date || !data.fuel || !data.km_recorridos) { alert('Rellena todos los campos de consumo.'); return; }

  try {
    showLoadingIndicator();
    const response = await makeAuthenticatedRequest(`/api/vehicle/${selectedVehicleId}/usage`, 'POST', data);
    if (response.status === 'success') {
      alert('Registro de consumo a√±adido con √©xito!');
      document.getElementById('newUsageDate').value = '';
      document.getElementById('newUsageFuel').value = '';
      document.getElementById('newUsageKm').value = '';
      document.getElementById('newUsageCost').value = '';
      selectVehicle(selectedVehicleId);
    } else {
      alert('Error al a√±adir registro de consumo: ' + (response.message || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error adding usage:', error);
    alert('Error de red al a√±adir registro de consumo: ' + error.message);
  } finally {
    hideLoadingIndicator();
  }
}


/* =========================
   EDIT MODE HELPERS
========================= */
function toggleEditMode(enable) {
  const mainDetailItems = document.querySelectorAll('#vehicleDetailsTab .details-grid .detail-item');
  const infoCardItems = document.querySelectorAll('#vehicleDetailsTab .info-card .info-grid .detail-item');
  const allItems = [...mainDetailItems, ...infoCardItems];

  allItems.forEach(item => {
    const labelElement = item.querySelector('strong');
    let valueSpan = item.querySelector('span');
    if (!labelElement) return;

    let keyPath = null;
    const sectionTitle = item.closest('.info-card')?.querySelector('h3')?.textContent || '';

    switch (labelElement.textContent.trim()) {
      case 'Matr√≠cula': keyPath = 'matricula'; break;
      case 'Marca': keyPath = 'marca'; break;
      case 'Modelo': keyPath = 'modelo'; break;
      case 'A√±o': keyPath = 'a√±o'; break;
      case 'Color': keyPath = 'color'; break;
      case 'VIN': keyPath = 'vin'; break;
      case 'Tipo': keyPath = 'tipo'; break;
      case 'Compa√±√≠a': keyPath = 'seguro.compania'; break;
      case 'P√≥liza': keyPath = 'seguro.poliza'; break;
      case 'Vencimiento':
        if (sectionTitle.includes('Seguro')) keyPath = 'seguro.vencimiento';
        if (sectionTitle.includes('Circulaci√≥n')) keyPath = 'documentacion.permiso_circulacion.vencimiento';
        if (sectionTitle.includes('Rodado')) keyPath = 'documentacion.tasa_trafico_rodado.vencimiento';
        break;
      case 'Fecha de Emisi√≥n':
        if (sectionTitle.includes('Circulaci√≥n')) keyPath = 'documentacion.permiso_circulacion.fecha_emision';
        if (sectionTitle.includes('Rodado')) keyPath = 'documentacion.tasa_trafico_rodado.fecha_emision';
        break;
      case 'Costo':
        if (sectionTitle.includes('Circulaci√≥n')) keyPath = 'documentacion.permiso_circulacion.costo';
        if (sectionTitle.includes('Rodado')) keyPath = 'documentacion.tasa_trafico_rodado.costo';
        break;
      default: keyPath = null;
    }
    if (!keyPath) return;

    if (enable) {
      const input = document.createElement('input');
      if (keyPath.includes('a√±o') || keyPath.includes('costo')) {
        input.type = 'number';
        input.step = keyPath.includes('costo') ? '0.01' : '1';
      } else if (keyPath.includes('fecha') || keyPath.includes('vencimiento')) {
        input.type = 'date';
      } else {
        input.type = 'text';
      }
      input.id = `edit_${keyPath.replace(/\./g, '_')}`;
      input.value = getNestedValue(currentVehicleData, keyPath) || '';
      if (valueSpan) valueSpan.remove();
      item.appendChild(input);
    } else {
      const input = item.querySelector(`#edit_${keyPath.replace(/\./g, '_')}`);
      if (input) {
        const value = getNestedValue(currentVehicleData, keyPath) || '---';
        valueSpan = document.createElement('span');
        valueSpan.textContent = value;
        input.replaceWith(valueSpan);
      }
    }
  });

  document.getElementById('editVehicleDetailsBtn')?.classList.toggle('hidden', enable);
  document.getElementById('saveVehicleDetailsBtn')?.classList.toggle('hidden', !enable);
  document.getElementById('cancelVehicleDetailsBtn')?.classList.toggle('hidden', !enable);
}

function getNestedValue(object, path) {
  return path.split('.').reduce((acc, part) => (acc && acc[part] !== undefined ? acc[part] : undefined), object);
}

function collectEditedDataFromInputs() {
  const updated = { ...currentVehicleData };
  updated.seguro = updated.seguro || {};
  updated.documentacion = updated.documentacion || {};

  document.querySelectorAll('#vehicleDetailsTab .detail-item').forEach(item => {
    const label = item.querySelector('strong');
    const input = item.querySelector('input');
    if (!label || !input) return;

    const sectionTitle = item.closest('.info-card')?.querySelector('h3')?.textContent || '';
    let keyPath = null;

    switch (label.textContent.trim()) {
      case 'Matr√≠cula': keyPath = 'matricula'; break;
      case 'Marca': keyPath = 'marca'; break;
      case 'Modelo': keyPath = 'modelo'; break;
      case 'A√±o': keyPath = 'a√±o'; break;
      case 'Color': keyPath = 'color'; break;
      case 'VIN': keyPath = 'vin'; break;
      case 'Tipo': keyPath = 'tipo'; break;
      case 'Compa√±√≠a': keyPath = 'seguro.compania'; break;
      case 'P√≥liza': keyPath = 'seguro.poliza'; break;
      case 'Vencimiento':
        if (sectionTitle.includes('Seguro')) keyPath = 'seguro.vencimiento';
        if (sectionTitle.includes('Circulaci√≥n')) keyPath = 'documentacion.permiso_circulacion.vencimiento';
        if (sectionTitle.includes('Rodado')) keyPath = 'documentacion.tasa_trafico_rodado.vencimiento';
        break;
      case 'Fecha de Emisi√≥n':
        if (sectionTitle.includes('Circulaci√≥n')) keyPath = 'documentacion.permiso_circulacion.fecha_emision';
        if (sectionTitle.includes('Rodado')) keyPath = 'documentacion.tasa_trafico_rodado.fecha_emision';
        break;
      case 'Costo':
        if (sectionTitle.includes('Circulaci√≥n')) keyPath = 'documentacion.permiso_circulacion.costo';
        if (sectionTitle.includes('Rodado')) keyPath = 'documentacion.tasa_trafico_rodado.costo';
        break;
      default: keyPath = null;
    }
    if (!keyPath) return;

    const parts = keyPath.split('.');
    let cursor = updated;
    for (let i = 0; i < parts.length - 1; i++) {
      cursor[parts[i]] = cursor[parts[i]] || {};
      cursor = cursor[parts[i]];
    }
    cursor[parts[parts.length - 1]] = input.value;
  });

  return updated;
}

async function saveVehicleDetails() {
  if (!selectedVehicleId) return;
  const updatedData = collectEditedDataFromInputs();

  try {
    showLoadingIndicator();
    const result = await makeAuthenticatedRequest(`/api/vehicle/${selectedVehicleId}`, 'PUT', updatedData);
    if (result.status === 'success') {
      alert('Veh√≠culo actualizado con √©xito.');
      selectVehicle(selectedVehicleId);
    } else {
      alert('Error al guardar los cambios: ' + (result.message || 'Error desconocido'));
    }
  } catch (error) {
    console.error('Error saving vehicle details:', error);
    alert('Error de red al guardar los cambios: ' + error.message);
  } finally {
    hideLoadingIndicator();
  }
}

function cancelEdit() {
  toggleEditMode(false);
  populateVehicleDetailsView(currentVehicleData);
}

/* =========================
   PERMANENT DELETE
========================= */
async function deleteVehiclePermanently(vehicleId = selectedVehicleId) {
  if (!vehicleId) return;
  if (!confirm('¬øEst√°s seguro de que quieres eliminar este veh√≠culo? Esta acci√≥n no se puede deshacer.')) return;

  try {
    showLoadingIndicator();
    const response = await makeAuthenticatedRequest(`/api/vehicle/${vehicleId}`, 'DELETE');
    if (response.status === 'success') {
      alert('Veh√≠culo eliminado con √©xito.');
      if (selectedVehicleId === vehicleId) selectedVehicleId = null;
      await loadVehicles();
      populateDecommissionDropdown(currentAllVehicles);
      showTab('listVehiclesTab');
    } else {
      alert('Error al eliminar el veh√≠culo: ' + (response.message || 'Error desconocido'));
    }
  } catch (error) {
    console.error('Error deleting vehicle:', error);
    alert('Error de red al eliminar el veh√≠culo: ' + error.message);
  } finally {
    hideLoadingIndicator();
  }
}

/* =========================
   MAP + TRACKING
========================= */
// ======================================================
// Dynamically load Google Maps JS API before calling initMap()
// ======================================================


function metersToLatitude(meters) { return meters / 111_111; }

function metersToLongitude(meters, latitude) { return meters / (111_111 * Math.cos(latitude * Math.PI / 180)); }

function assignVehicleOffsets() {
  if (!currentAllVehicles?.length || !map) return;

  const center = map.getCenter();
  const centerLat = center.lat();
  const centerLng = center.lng();
  const GOLDEN_ANGLE_DEGREES = 137.508;

  currentAllVehicles.forEach((vehicle, index) => {
    if (vehicleGeographicOffsets[vehicle.id]) return;

    const angleRadians = ((index * GOLDEN_ANGLE_DEGREES) % 360) * Math.PI / 180;
    const baseRadiusMeters = 450;
    const ring = index % 5;
    const radiusMeters = baseRadiusMeters + ring * 220;

    const deltaLat = metersToLatitude(Math.sin(angleRadians) * radiusMeters);
    const deltaLng = metersToLongitude(Math.cos(angleRadians) * radiusMeters, centerLat);
    vehicleGeographicOffsets[vehicle.id] = { deltaLat, deltaLng };
  });

  offsetsAssigned = true;
}

function applyOffsetToPosition(vehicleId, lat, lng) {
  // Ensure numeric values
  const latNum = parseFloat(lat);
  const lngNum = parseFloat(lng);

  // If coordinates are invalid, bail early to avoid NaN errors
  if (isNaN(latNum) || isNaN(lngNum)) {
    console.warn(`‚ö†Ô∏è Invalid coordinates for vehicle ${vehicleId}:`, lat, lng);
    return { lat: 0, lng: 0 }; // fallback to safe origin
  }

  const offset = vehicleGeographicOffsets[vehicleId] || { lat: 0, lng: 0 };

  // Ensure offsets are valid numbers
  const offsetLat = parseFloat(offset.lat) || 0;
  const offsetLng = parseFloat(offset.lng) || 0;

  return {
    lat: latNum + offsetLat,
    lng: lngNum + offsetLng
  };
}

function setMarkerMap(advancedMarker, mapInstance) {
  if (!advancedMarker) return;
  if (typeof advancedMarker.setMap === 'function') advancedMarker.setMap(mapInstance || null);
  else advancedMarker.map = mapInstance || null;
}

// ======================================================
//  Vehicle marker management (classic API)
// ======================================================

function updateAllVehicleMarkers(force = false) {
  if (!mapInitialized || !map) return;
  if (!window.vehiclesData || !Array.isArray(window.vehiclesData)) return;

  window.vehiclesData.forEach((vehicle) => {
    const lat = parseFloat(vehicle.lat);
    const lng = parseFloat(vehicle.lng);
    if (isNaN(lat) || isNaN(lng)) return;

    const pos = { lat, lng };

    if (markers[vehicle.id]) {
      markers[vehicle.id].setPosition(pos);
    } else {
      markers[vehicle.id] = new google.maps.Marker({
        position: pos,
        map,
        title: `${vehicle.marca} ${vehicle.modelo} (${vehicle.matricula})`,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          fillColor: "#004080",
          fillOpacity: 1,
          strokeColor: "#fff",
          strokeWeight: 2,
          scale: 7,
        },
      });
    }
  });
}
function easeInOutQuadratic(t) { return t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t; }

function toLiteralLatLng(latLng) {
  if (!latLng) return null;
  return latLng instanceof google.maps.LatLng ? { lat: latLng.lat(), lng: latLng.lng() } : latLng;
}

// =======================================
// =====================================================
// HELPER FUNCTIONS: Offsets, animation, heading rotation
// =====================================================

function calculateHeading(from, to) {
  if (!from || !to) {
    console.warn("‚ö†Ô∏è calculateHeading called with undefined coords:", { from, to });
    return 0;
  }

  const fromLat = typeof from.lat === "function" ? from.lat() : from.lat;
  const fromLng = typeof from.lng === "function" ? from.lng() : from.lng;
  const toLat   = typeof to.lat === "function" ? to.lat()   : to.lat;
  const toLng   = typeof to.lng === "function" ? to.lng()   : to.lng;

  if ([fromLat, fromLng, toLat, toLng].some(v => isNaN(v))) {
    console.warn("‚ö†Ô∏è Invalid numeric values in calculateHeading:", { from, to });
    return 0;
  }

  const œÜ1 = (fromLat * Math.PI) / 180;
  const œÜ2 = (toLat * Math.PI) / 180;
  const ŒîŒª = ((toLng - fromLng) * Math.PI) / 180;

  const y = Math.sin(ŒîŒª) * Math.cos(œÜ2);
  const x =
    Math.cos(œÜ1) * Math.sin(œÜ2) -
    Math.sin(œÜ1) * Math.cos(œÜ2) * Math.cos(ŒîŒª);

  const brng = (Math.atan2(y, x) * 180) / Math.PI;
  return (brng + 360) % 360;
}


function applyOffsetToPosition(vehicleId, lat, lng) {
  if (isNaN(lat) || isNaN(lng)) return { lat: 0, lng: 0 };
  const offset = vehicleGeographicOffsets?.[vehicleId] || { lat: 0, lng: 0 };
  return {
    lat: lat + offset.lat,
    lng: lng + offset.lng
  };
}

// Smooth interpolation between old and new positions

/**
 * Smoothly animates a vehicle marker from its current position to a new one,
 * while rotating its icon based on the travel heading.
 * Works safely with either {lat, lng} objects or google.maps.LatLng instances.
 */
function animateMarkerPosition(marker, vehicleId, targetLatLng, duration = 2000) {
  try {
    if (!marker || !marker.position) return;

    // Normalize positions
    const start = marker.position;
    const startLat = typeof start.lat === "function" ? start.lat() : start.lat;
    const startLng = typeof start.lng === "function" ? start.lng() : start.lng;
    const endLat   = typeof targetLatLng.lat === "function" ? targetLatLng.lat() : targetLatLng.lat;
    const endLng   = typeof targetLatLng.lng === "function" ? targetLatLng.lng() : targetLatLng.lng;

    if ([startLat, startLng, endLat, endLng].some(v => isNaN(v))) return;

    const deltaLat = endLat - startLat;
    const deltaLng = endLng - startLng;
    const startTime = performance.now();

    function step() {
      const elapsed = performance.now() - startTime;
      const progress = Math.min(elapsed / duration, 1);

      // Ease-in/out motion
      const eased = progress < 0.5
        ? 2 * progress * progress
        : -1 + (4 - 2 * progress) * progress;

      const currentLat = startLat + deltaLat * eased;
      const currentLng = startLng + deltaLng * eased;
      const newPos = new google.maps.LatLng(currentLat, currentLng);

      // Update rotation smoothly
      if (typeof updateMarkerRotation === "function") {
        updateMarkerRotation(
          marker,
          vehicleId,
          { lat: startLat, lng: startLng },
          { lat: currentLat, lng: currentLng }
        );
      }

      marker.position = newPos;

      if (progress < 1) requestAnimationFrame(step);
      else marker.position = new google.maps.LatLng(endLat, endLng);
    }

    requestAnimationFrame(step);
  } catch (err) {
    console.error(`‚ùå animateMarkerPosition error for ${vehicleId}:`, err);
  }
}


function updateMarkerRotation(marker, vehicleId, fromPos, toPos) {
  if (!marker || !marker.content || !fromPos || !toPos) return;

  const heading = calculateHeading(fromPos, toPos);
  if (isNaN(heading)) return;

  // Cache per-vehicle heading in memory
  const last = window.lastVehiclePositions?.[vehicleId] || {};
  const lastHeading = last.heading ?? 0;
  const diff = Math.abs(heading - lastHeading);

  // Ignore micro rotations (<5¬∞) to avoid jitter
  if (diff < 5) return;

  const el = marker.content;
  el.style.transition = "transform 0.6s linear";
  el.style.transformOrigin = "center center";
  el.style.transform = `rotate(${heading}deg)`;

  window.lastVehiclePositions = window.lastVehiclePositions || {};
  window.lastVehiclePositions[vehicleId] = { ...toPos, heading };
}

function applyOffsetToPosition(vehicleId, lat, lng) {
  const latNum = parseFloat(lat);
  const lngNum = parseFloat(lng);

  if (isNaN(latNum) || isNaN(lngNum)) {
    console.warn(`‚ö†Ô∏è Invalid coordinates for vehicle ${vehicleId}:`, lat, lng);
    return { lat: 0, lng: 0 };
  }

  const offset = vehicleGeographicOffsets?.[vehicleId] || { lat: 0, lng: 0 };
  const offsetLat = parseFloat(offset.lat) || 0;
  const offsetLng = parseFloat(offset.lng) || 0;

  return { lat: latNum + offsetLat, lng: lngNum + offsetLng };
}

function stopTracking() {
  if (trackingIntervalId) {
    clearInterval(trackingIntervalId);
    trackingIntervalId = null;
  }
  const trackingDisplay = document.getElementById('trackingDisplay');
  if (trackingDisplay) {
    trackingDisplay.innerHTML = `<p class="text-gray-500">Selecciona un veh√≠culo o "Ver Todos" para iniciar el monitoreo.</p>`;
  }
}

async function positionVehicleOnMap(vehicleId) {
  if (!vehicleId) { alert('No hay un veh√≠culo seleccionado para posicionar.'); return; }
  await showTab('trackingTab', false);
  const trackingSelect = document.getElementById('trackingVehicleSelect');
  if (trackingSelect) {
    trackingSelect.value = vehicleId;
    startTrackingSingleVehicle(vehicleId);
  }
}

/* ======================================================
   FREE STREET NAME LOOKUP (OpenStreetMap Nominatim)
   ====================================================== */
/**
 * Reverse-geocode coordinates into a street name using OpenStreetMap (free).
 * Uses real coordinates, robust parsing, and 60s per-vehicle caching.
 */
window.streetCache = window.streetCache || {};

// ======================================================
//  Reverse Geocoding Helper (OpenStreetMap Nominatim)
// ======================================================
async function getStreetNameFree(lat, lng, vehicleId) {
  const now = Date.now();
  const cacheKey = `${vehicleId}_${lat.toFixed(4)}_${lng.toFixed(4)}`;
  window.streetCache = window.streetCache || {};
  const cached = window.streetCache[cacheKey];

  // ‚úÖ Return cached value if < 60 seconds old
  if (cached && now - cached.timestamp < 60000) {
    return cached.name;
  }

  try {
    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`;
    const res = await fetch(url, {
      headers: {
        "User-Agent": "ElebiFleetTracker/1.0 (elebi@egembassydc.com)",
        "Accept-Language": "es,en;q=0.9"
      }
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    // ‚úÖ Safely extract best possible street name
    const street =
      data.address?.road ||
      data.address?.pedestrian ||
      data.address?.suburb ||
      data.address?.neighbourhood ||
      data.address?.hamlet ||
      data.name ||
      (data.display_name ? data.display_name.split(",")[0] : "") ||
      "Calle desconocida";

    // ‚úÖ Cache the result
    window.streetCache[cacheKey] = { name: street, timestamp: now };
    return street;
  } catch (err) {
    console.warn("‚ö†Ô∏è OSM reverse-geocode error:", err);
    return "Calle desconocida";
  }
}
/* ======================================================
   SINGLE VEHICLE TRACKING (WITH SPEED COLORS)
   ====================================================== */
async function startTrackingSingleVehicle(vehicleId) {
  stopTracking();
  if (!offsetsAssigned) assignVehicleOffsets();

  // Hide others
  for (const id in markers) {
    if (id !== vehicleId) setMarkerMap(markers[id], null);
  }

  const trackingDisplay = document.getElementById("trackingDisplay");
  trackingDisplay.innerHTML = `<p class="text-gray-500">Iniciando monitoreo del veh√≠culo seleccionado...</p>`;

  let lastCenter = null;

  async function tick() {
    try {
      const r = await makeAuthenticatedRequest(`/api/vehicle/${vehicleId}/location`, "GET");
      if (r.status !== "success" || !r.location) {
        trackingDisplay.innerHTML = `<p class="text-red-500">Error: ${r.message || "Sin ubicaci√≥n"}</p>`;
        return;
      }

      const loc = r.location;
      const v = currentAllVehicles.find(x => x.id === vehicleId) || { marca:'', modelo:'', matricula:'' };

      const pos = applyOffsetToPosition(vehicleId, loc.latitude, loc.longitude);
      const target = new google.maps.LatLng(pos.lat, pos.lng);

      // Update data panel
      trackingDisplay.innerHTML = `
        <p><strong>Veh√≠culo:</strong> ${v.marca} ${v.modelo} (${v.matricula})</p>
        <p><strong>Estado:</strong> ${loc.status || "‚Äî"}</p>
        <p><strong>Velocidad:</strong> ${(loc.speed_kmh ? loc.speed_kmh : 0).toFixed(1)} km/h</p>
        <p><strong>Ubicaci√≥n:</strong> Lat ${pos.lat.toFixed(5)}, Lng ${pos.lng.toFixed(5)}</p>
        <p class="text-sm text-gray-500">√öltima actualizaci√≥n: ${new Date(loc.timestamp).toLocaleString()}</p>
      `;

      // Advanced marker with your wrapper (palette + plate)
      const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
      if (markers[vehicleId]) {
        const m = markers[vehicleId];
        const oldPos = m.position;
        setMarkerMap(m, map);
        animateMarkerPosition(m, vehicleId, target, 1500);
        if (typeof updateMarkerRotation === "function")
          updateMarkerRotation(m, vehicleId, oldPos, target);
      } else {
        const palette = window.vehicleIconPalette;         // your existing palette
        const icon = palette[vehicleId.charCodeAt(0) % palette.length];

        const wrapper = document.createElement("div");
        wrapper.className = "vehicle-marker";
        wrapper.style.position = "relative";
        wrapper.style.display = "flex";
        wrapper.style.flexDirection = "column";
        wrapper.style.alignItems = "center";

        const circle = document.createElement("div");
        circle.style.width = "28px";
        circle.style.height = "28px";
        circle.style.display = "flex";
        circle.style.alignItems = "center";
        circle.style.justifyContent = "center";
        circle.style.borderRadius = "50%";
        circle.style.backgroundColor = icon.bg;
        circle.style.transition = "transform 0.5s linear";
        circle.innerHTML = icon.glyph;

        const label = document.createElement("div");
        label.textContent = v.matricula || "‚Äî";
        label.style.position = "absolute";
        label.style.top = "30px";
        label.style.whiteSpace = "nowrap";
        label.style.fontSize = "10px";
        label.style.fontWeight = "bold";
        label.style.color = "#222";
        label.style.background = "rgba(255,255,255,0.85)";
        label.style.border = "1px solid #333";
        label.style.borderRadius = "4px";
        label.style.padding = "0 2px";

        wrapper.appendChild(circle);
        wrapper.appendChild(label);

        markers[vehicleId] = new AdvancedMarkerElement({
          position: target,
          map,
          title: `${v.marca} ${v.modelo} (${v.matricula})`,
          content: wrapper,
        });
      }

      // Keep map centered smoothly
      if (!lastCenter) {
        map.setCenter(target);
        map.setZoom(15);
      } else if (google.maps.geometry) {
        const moved = google.maps.geometry.spherical.computeDistanceBetween(lastCenter, target);
        if (moved > 30) map.panTo(target);
      }
      lastCenter = target;
    } catch (e) {
      trackingDisplay.innerHTML = `<p class="text-red-500">Error al conectar con la API de tracking.</p>`;
      console.error("Tracking error:", e);
    }
  }

  tick();
  trackingIntervalId = setInterval(tick, 2000);
}
/* ======================================================
   ALL VEHICLES TRACKING (WITH SPEED COLORS)
   ====================================================== */

async function startTrackingAllVehicles() {
  stopTracking();
  if (!offsetsAssigned) assignVehicleOffsets();

  const trackingDisplay = document.getElementById("trackingDisplay");
  trackingDisplay.innerHTML = `<p class="text-gray-500">Mostrando todos los veh√≠culos. Se actualiza cada 2s.</p>`;

  async function tick() {
    if (!currentAllVehicles?.length) {
      trackingDisplay.innerHTML = `<p class="text-gray-500">No hay veh√≠culos para mostrar.</p>`;
      return;
    }
    if (!map) return;

    const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
    const bounds = new google.maps.LatLngBounds();

    for (const v of currentAllVehicles) {
      try {
        const r = await makeAuthenticatedRequest(`/api/vehicle/${v.id}/location`, "GET");
        if (r.status !== "success" || !r.location) continue;

        const pos = applyOffsetToPosition(v.id, r.location.latitude, r.location.longitude);
        const target = new google.maps.LatLng(pos.lat, pos.lng);
        bounds.extend(target);

        if (markers[v.id]) {
          const m = markers[v.id];
          const oldPos = m.position;
          setMarkerMap(m, map);
          animateMarkerPosition(m, v.id, target, 1200);
          if (typeof updateMarkerRotation === "function")
            updateMarkerRotation(m, v.id, oldPos, target);
        } else {
          const palette = window.vehicleIconPalette;
          const icon = palette[v.id.charCodeAt(0) % palette.length];

          const wrapper = document.createElement("div");
          wrapper.className = "vehicle-marker";
          wrapper.style.position = "relative";
          wrapper.style.display = "flex";
          wrapper.style.flexDirection = "column";
          wrapper.style.alignItems = "center";

          const circle = document.createElement("div");
          circle.style.width = "28px";
          circle.style.height = "28px";
          circle.style.display = "flex";
          circle.style.alignItems = "center";
          circle.style.justifyContent = "center";
          circle.style.borderRadius = "50%";
          circle.style.backgroundColor = icon.bg;
          circle.style.transition = "transform 0.5s linear";
          circle.innerHTML = icon.glyph;

          const label = document.createElement("div");
          label.textContent = v.matricula || "‚Äî";
          label.style.position = "absolute";
          label.style.top = "30px";
          label.style.whiteSpace = "nowrap";
          label.style.fontSize = "10px";
          label.style.fontWeight = "bold";
          label.style.color = "#222";
          label.style.background = "rgba(255,255,255,0.85)";
          label.style.border = "1px solid #333";
          label.style.borderRadius = "4px";
          label.style.padding = "0 2px";

          wrapper.appendChild(circle);
          wrapper.appendChild(label);

          markers[v.id] = new AdvancedMarkerElement({
            position: target,
            map,
            title: `${v.marca} ${v.modelo} (${v.matricula})`,
            content: wrapper,
          });
        }
      } catch (err) {
        console.error(`Error veh√≠culo ${v.id}:`, err);
      }
    }

    if (!bounds.isEmpty()) map.fitBounds(bounds, { padding: 50 });
  }

  tick();
  trackingIntervalId = setInterval(tick, 2000);
}


/* =========================
   CONSUMPTION ANALYSIS
========================= */
let consumptionChart = null;
let comparisonChart = null;

function toggleConsumptionForm() {
  const form = document.getElementById('consumptionForm');
  if (form) form.classList.toggle('hidden');
}

function generateMockConsumptionData() {
  const datasetByVehicle = {};
  const currentYear = new Date().getFullYear();

  currentAllVehicles.forEach(vehicle => {
    const entries = [];
    let baseConsumption;

    if (vehicle.tipo && vehicle.tipo.toLowerCase().includes('camion')) {
      baseConsumption = 14.5;
    } else if (vehicle.tipo && vehicle.tipo.toLowerCase().includes('suv')) {
      baseConsumption = 12.0;
    } else {
      baseConsumption = 10.5;
    }

    for (let month = 0; month < 8; month++) {
      for (let week = 1; week <= 4; week++) {
        const variation = (Math.random() * 0.3) - 0.15;
        const weeklyConsumption = baseConsumption * (1 + variation);
        const distanceKm = Math.floor(400 + (Math.random() * 400));
        const liters = Number((weeklyConsumption * distanceKm / 100).toFixed(1));
        const cost = Math.floor(liters * 665);
        const weekStart = new Date(currentYear, month, (week - 1) * 7 + 1).toISOString().split('T')[0];

        entries.push({
          date: weekStart,
          fuel: liters,
          km_recorridos: distanceKm,
          cost: cost,
          consumption: parseFloat(weeklyConsumption.toFixed(1)),
          month: month,
          week: week
        });
      }
    }
    datasetByVehicle[vehicle.id] = entries;
  });

  return datasetByVehicle;
}

function updateConsumptionAnalysis() {
  if (!selectedVehicleId || !window.consumptionData) return;

  const periodValue = document.getElementById('analysisPeriod')?.value || 'all';
  const rawData = window.consumptionData[selectedVehicleId] || [];

  const monthIndexMap = {
    january: 0, february: 1, march: 2, april: 3,
    may: 4, june: 5, july: 6, august: 7
  };

  let filtered = rawData.slice();
  if (periodValue !== 'all') {
    const index = monthIndexMap[periodValue];
    filtered = filtered.filter(entry => new Date(entry.date).getMonth() === index);
  }

  const totalFuel = filtered.reduce((sum, e) => sum + e.fuel, 0);
  const totalCost = filtered.reduce((sum, e) => sum + e.cost, 0);
  const totalDistance = filtered.reduce((sum, e) => sum + e.km_recorridos, 0);
  const averageConsumption = totalDistance > 0 ? (totalFuel / totalDistance * 100).toFixed(1) : 0;

  safeSetTextContent('totalFuel', `${totalFuel.toFixed(1)} L`, '0 L');
  safeSetTextContent('totalCost', `${totalCost.toLocaleString()} FCFA`, '0 FCFA');
  safeSetTextContent('avgConsumption', `${averageConsumption} L/100km`, '0 L/100km');
  safeSetTextContent('totalDistance', `${totalDistance.toLocaleString()} km`, '0 km');

  updateConsumptionTable(filtered);
  updateConsumptionChart(filtered);
  updateComparisonChart(filtered);
}

function updateConsumptionTable(data) {
  const tableBody = document.getElementById('usage_table_body');
  if (!tableBody) return;

  tableBody.innerHTML = '';

  if (!data?.length) {
    const row = tableBody.insertRow();
    row.innerHTML = `<td colspan="6" class="text-center text-gray-500 py-4">No hay datos para el per√≠odo seleccionado.</td>`;
    return;
  }

  data
    .slice()
    .sort((a, b) => new Date(b.date) - new Date(a.date))
    .forEach(entry => {
      const lPer100 = entry.km_recorridos > 0 ? (entry.fuel / entry.km_recorridos * 100).toFixed(1) : 'N/A';
      const costPerKm = entry.km_recorridos > 0 ? (entry.cost / entry.km_recorridos).toFixed(0) : 'N/A';
      const d = new Date(entry.date);
      const formatted = d.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
      const weekInMonth = Math.ceil((d.getDate() + 6 - d.getDay()) / 7);

      const row = tableBody.insertRow();
      row.innerHTML = `
        <td>Semana ${weekInMonth}, ${formatted}</td>
        <td class="text-right">${entry.fuel.toFixed(1)} L</td>
        <td class="text-right">${entry.km_recorridos} km</td>
        <td class="text-right">${lPer100} L/100km</td>
        <td class="text-right">FCFA ${entry.cost.toLocaleString()}</td>
        <td class="text-right">${costPerKm !== 'N/A' ? `${costPerKm} FCFA/km` : '---'}</td>
      `;
    });
}

function updateConsumptionChart(data) {
  const canvas = document.getElementById('consumptionChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');

  const monthLabels = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago'];
  const grouped = {};

  data.forEach(e => {
    const monthIndex = new Date(e.date).getMonth();
    const label = monthLabels[monthIndex];
    grouped[label] = grouped[label] || { fuel: 0, distance: 0 };
    grouped[label].fuel += e.fuel;
    grouped[label].distance += e.km_recorridos;
  });

  const labels = Object.keys(grouped);
  const values = labels.map(l => {
    const g = grouped[l];
    return g.distance > 0 ? (g.fuel / g.distance * 100).toFixed(1) : 0;
    });

  if (consumptionChart) consumptionChart.destroy();

  consumptionChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Consumo (L/100km)',
        data: values,
        backgroundColor: 'rgba(54, 162, 235, 0.7)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: { title: { display: true, text: 'Consumo por Mes' } },
      scales: {
        y: { beginAtZero: true, title: { display: true, text: 'Litros por 100km' } }
      }
    }
  });
}

function updateComparisonChart() {
  const canvas = document.getElementById('comparisonChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');

  if (!currentAllVehicles || currentAllVehicles.length < 2) {
    if (comparisonChart) { comparisonChart.destroy(); comparisonChart = null; }
    return;
  }

  const consumptionByVehicle = currentAllVehicles.map(vehicle => {
    const data = (window.consumptionData && window.consumptionData[vehicle.id]) ? window.consumptionData[vehicle.id] : [];
    const totalFuel = data.reduce((s, e) => s + e.fuel, 0);
    const totalDistance = data.reduce((s, e) => s + e.km_recorridos, 0);
    const avg = totalDistance > 0 ? (totalFuel / totalDistance * 100).toFixed(1) : 0;
    return { label: `${vehicle.marca} ${vehicle.modelo}`, value: parseFloat(avg) };
  });

  const labels = consumptionByVehicle.map(v => v.label);
  const values = consumptionByVehicle.map(v => v.value);

  if (comparisonChart) comparisonChart.destroy();

  comparisonChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Consumo Promedio (L/100km)',
        data: values,
        backgroundColor: 'rgba(255, 99, 132, 0.7)',
        borderColor: 'rgba(255, 99, 132, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: { title: { display: true, text: 'Comparaci√≥n con Flota' } },
      scales: {
        y: { beginAtZero: true, title: { display: true, text: 'Litros por 100km' } }
      }
    }
  });
}

function loadChartJS() {
  if (typeof Chart === 'undefined') {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
    script.onload = () => { if (selectedVehicleId) updateConsumptionAnalysis(); };
    document.head.appendChild(script);
  } else {
    if (selectedVehicleId) updateConsumptionAnalysis();
  }
}

 // run after the DOM is ready, so #detailsTabBtn is present
  document.addEventListener('DOMContentLoaded', () => {
    const detailsBtn = document.getElementById('detailsTabBtn');
    if (!detailsBtn) return;

    document.querySelectorAll('.tab .tablinks').forEach(b => {
      b.addEventListener('click', () => {
        // works whether you use onclick="openTab(...,'id')" or data-target
        const target = /'([^']+)'/.exec(b.getAttribute('onclick')||'')?.[1] || b.dataset.target;
        const isDetails = target === 'detailsTab';
        if (!isDetails) detailsBtn.classList.add('hidden'); // hide when leaving
      });
    });
  });

</script>
<script>
/* ---------- Helpers to switch tabs (reuse your existing openTab if present) ---------- */
function activateTabButton(btn){
  document.querySelectorAll('.tab .tablinks').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

function showTabPanel(id){
  document.querySelectorAll('.tabcontent').forEach(p => p.style.display = 'none');
  const panel = document.getElementById(id);
  if (panel){ panel.style.display = 'block'; panel.classList.remove('hidden'); }
}

/* ---------- Locate your new Details button ---------- */
const detailsBtn = document.getElementById('detailsTabBtn');

/* ---------- Replace with your real data fetch ---------- */
// Fast in-memory index keyed by id
window.__vehicleIndexById = window.__vehicleIndexById || Object.create(null);


function getVehicleById(id){
  if (!id) return null;
  const key = String(id);

  // 1) If we've already indexed, use it.
  if (window.__vehicleIndexById[key]) return window.__vehicleIndexById[key];

  // 2) Scan the current full list (kept by your app) and index it.
  if (Array.isArray(window.currentAllVehicles) && window.currentAllVehicles.length){
    const found = window.currentAllVehicles.find(v => String(v.id) === key);
    if (found){
      window.__vehicleIndexById[key] = found;
      return found;
    }
  }

  // 3) If the vehicle currently shown in details matches, use it.
  if (window.currentVehicleData && String(window.currentVehicleData.id) === key){
    window.__vehicleIndexById[key] = window.currentVehicleData;
    return window.currentVehicleData;
  }

  // 4) Final fallback (only if you set this elsewhere when clicking a card)
  if (window.__lastClickedVehicle && String(window.__lastClickedVehicle.id) === key){
    window.__vehicleIndexById[key] = window.__lastClickedVehicle;
    return window.__lastClickedVehicle;
  }

  return null;
}

/* ---------- Fill details panel ---------- */
function populateDetails(v){
  // Header
  const photo = document.getElementById('detail_vehicle_photo');
  const title = document.getElementById('detail_marca_modelo');
  const sub   = document.getElementById('detail_matricula_year');

  photo.src = v.photoUrl || 'https://placehold.co/120';
  title.textContent = `${v.marca || ''} ${v.modelo || ''}`.trim() || '‚Äî';
  sub.textContent = `${v.matricula || ''} ${v.a√±o ? '('+v.a√±o+')' : ''}`.trim() || '‚Äî';

  // Basics
  (document.getElementById('detail_matricula')||{}).textContent = v.matricula || '‚Äî';
  (document.getElementById('detail_marca')||{}).textContent     = v.marca || '‚Äî';
  (document.getElementById('detail_modelo')||{}).textContent    = v.modelo || '‚Äî';
  (document.getElementById('detail_a√±o')||{}).textContent       = v.a√±o || '‚Äî';
  (document.getElementById('detail_color')||{}).textContent     = v.color || '‚Äî';
  (document.getElementById('detail_vin')||{}).textContent       = v.vin || '‚Äî';
  (document.getElementById('detail_tipo')||{}).textContent      = v.tipo || '‚Äî';

  // Insurance
  (document.getElementById('detail_insurance_compania')||{}).textContent    = v.seguro?.compania || '‚Äî';
  (document.getElementById('detail_insurance_poliza')||{}).textContent      = v.seguro?.poliza || '‚Äî';
  (document.getElementById('detail_insurance_vencimiento')||{}).textContent = v.seguro?.vencimiento || '‚Äî';

  // Permiso
  (document.getElementById('detail_permiso_emision')||{}).textContent      = v.permiso?.emision || '‚Äî';
  (document.getElementById('detail_permiso_vencimiento')||{}).textContent  = v.permiso?.vencimiento || '‚Äî';
  (document.getElementById('detail_permiso_costo')||{}).textContent        = v.permiso?.costo || '‚Äî';

  // Tasa Tr√°fico Rodado
  (document.getElementById('detail_tasa_emision')||{}).textContent       = v.tasa?.emision || '‚Äî';
  (document.getElementById('detail_tasa_vencimiento')||{}).textContent   = v.tasa?.vencimiento || '‚Äî';
  (document.getElementById('detail_tasa_costo')||{}).textContent         = v.tasa?.costo || '‚Äî';
}

/* ---------- When user clicks "Ver Detalles" in any vehicle card ---------- */
const vehicleList = document.getElementById('vehicleListContainer');
if (vehicleList){
  vehicleList.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-action="view-details"]');
    if (!btn) return;

    const card = btn.closest('.vehicle-card');
    const vehId = btn.dataset.vehId || card?.dataset.vehId;
    // You can also store extra fields in data- attributes when building cards:
    const vehObj = {
      id: vehId,
      marca: card?.dataset.marca,
      modelo: card?.dataset.modelo,
      a√±o: card?.dataset.ano,
      matricula: card?.dataset.matricula,
      vin: card?.dataset.vin,
      tipo: card?.dataset.tipo,
      color: card?.dataset.color,
      photoUrl: card?.dataset.photoUrl || card?.querySelector('img')?.src,
      seguro: {
        compania: card?.dataset.seguroCompania,
        poliza: card?.dataset.seguroPoliza,
        vencimiento: card?.dataset.seguroVence,
      },
      permiso: {
        emision: card?.dataset.permisoEmision,
        vencimiento: card?.dataset.permisoVence,
        costo: card?.dataset.permisoCosto,
      },
      tasa: {
        emision: card?.dataset.tasaEmision,
        vencimiento: card?.dataset.tasaVence,
        costo: card?.dataset.tasaCosto,
      }
    };

    // Prefer your real data source if available:
    window.__lastClickedVehicle = vehObj;
    const v = getVehicleById(vehId) || vehObj;

    populateDetails(v);

    // Reveal "Detalles" tab and activate it
    detailsBtn.classList.remove('hidden');
    activateTabButton(detailsBtn);
    showTabPanel('detailsTab');

    // Optional: scroll to the tab bar top (helps when page is long)
    document.querySelector('.tab')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
  });
}

// Optional UX: hide the "Detalles" tab button when switching to another tab
(function(){
  const detailsBtn = document.getElementById('detailsTabBtn');
  if (!detailsBtn) return;

  document.querySelectorAll('.tab .tablinks').forEach(btn => {
    btn.addEventListener('click', () => {
      if (btn !== detailsBtn){
        // comment this line if you prefer the Detalles tab to remain visible
        detailsBtn.classList.add('hidden');
      }
    });
  });
})();

document.addEventListener("DOMContentLoaded", () => {
  const posBtn = document.getElementById("positionVehicleBtn");
  if (posBtn) {
    posBtn.addEventListener("click", () => {
      try {
        // Get the selected vehicle ID
        const vehicleId = window.selectedVehicleId || null;
        if (!vehicleId) {
          alert("No se ha seleccionado ning√∫n veh√≠culo.");
          return;
        }

        // Close the modal
        closeVehicleDetailsModal();

        // Open Posicionamiento tab
        showTab("trackingTab");

        // Start tracking this specific vehicle
        setTimeout(() => {
          console.log(`üöó Posicionando veh√≠culo ${vehicleId}`);
          startTrackingSingleVehicle(vehicleId);
        }, 500);
      } catch (err) {
        console.error("Error al posicionar veh√≠culo:", err);
      }
    });
  }
});

// ============================================
// üß© FLEET MANAGEMENT: MODALS + MOCK DATA
// ============================================

// -- Utility: generic modal builder --
function createModal(title, bodyHTML) {
  // remove existing modal
  const old = document.getElementById('dynamicModal');
  if (old) old.remove();

  // create new
  const modal = document.createElement('div');
  modal.id = 'dynamicModal';
  modal.className = 'modal';
  modal.innerHTML = `
    <div class="modal-content" style="max-width:850px;max-height:90vh;overflow:auto;padding:20px;border:2px solid black">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold text-blue-800">${title}</h3>
        <button class="modal-close" onclick="document.getElementById('dynamicModal').remove()">‚úï</button>
      </div>
      ${bodyHTML}
    </div>`;
  document.body.appendChild(modal);
  modal.classList.remove('hidden');
}

// ============================================================
// üìÅ DOCUMENTACI√ìN TAB ‚Äî CARTILLA √öNICA DE VEH√çCULOS (CUVE)
// ============================================================

// Populate dropdown
async function populateDocVehicleSelector() {
  const selector = document.getElementById("docVehicleSelector");
  if (!selector) return;

  selector.innerHTML = `<option value="">Seleccione un veh√≠culo</option>`;

  try {
    const result = await makeAuthenticatedRequest("/api/vehicles", "GET");
    if (result.status === "success" && Array.isArray(result.vehicles)) {
      result.vehicles.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v.id;
        opt.textContent = `${v.marca || ""} ${v.modelo || ""} (${v.matricula || ""})`;
        selector.appendChild(opt);
      });
    } else {
      console.warn("‚ö†Ô∏è No se pudieron cargar los veh√≠culos:", result.message);
    }
  } catch (err) {
    console.error("‚ùå Error cargando veh√≠culos:", err);
  }
}

// Handle selection
function handleDocVehicleChange() {
  const selector = document.getElementById("docVehicleSelector");
  const tbody = document.getElementById("documentacionTableBody");
  const vehicleId = selector.value;

  if (!vehicleId) {
    tbody.innerHTML = `<tr><td colspan="4" class="text-center py-2 text-gray-500">
      Seleccione un veh√≠culo para ver su documentaci√≥n.
    </td></tr>`;
    return;
  }

  // Mock data (replace later with real DB fetch)
  const docs = [
    {
      nombre: "Cartilla √önica de Veh√≠culos (CUVE)",
      vigencia: "Anual (renovaci√≥n cada 12 meses)",
      archivo: "cuve_demo.pdf"
    },
    {
      nombre: "Certificado de Inspecci√≥n T√©cnica",
      vigencia: "2025-12-15",
      archivo: "itv_demo.pdf"
    },
    {
      nombre: "T√≠tulo de Propiedad / Compraventa",
      vigencia: "Permanente",
      archivo: "propiedad_demo.pdf"
    },
    {
      nombre: "Seguro Obligatorio de Veh√≠culos",
      vigencia: "2026-01-01",
      archivo: "seguro_demo.pdf"
    },
    {
      nombre: "Certificado de Importaci√≥n / Aduanas",
      vigencia: "√önico",
      archivo: "importacion_demo.pdf"
    },
  ];

  tbody.innerHTML = docs.map(d => `
  <tr>
    <td class="border px-2 py-1">${d.nombre}</td>
    <td class="border px-2 py-1">${d.vigencia}</td>
    <td class="border px-2 py-1 text-center">
      <span class="text-blue-700 font-medium">PDF</span>
    </td>
    <td class="border px-2 py-1 text-center flex justify-center gap-2">
      <button class="sidebar-button text-xs" onclick="openPDFViewer('${d.archivo}')">Ver</button>
      <button class="sidebar-button text-xs" style="background:#4CAF50" 
              onclick="openUploadModal('${vehicleId}', '${d.nombre}')">Subir</button>
    </td>
  </tr>
`).join("");
}

// PDF Viewer ‚Äî same modal system used in 3D viewer
function openPDFViewer(filename) {
  const modal = document.getElementById("viewer3DModal");
  const container = document.getElementById("viewer3DContainer");
  if (!modal || !container) return;
  container.innerHTML = `
    <iframe src="/static/mock_pdfs/${filename}" width="100%" height="480px" style="border:none;"></iframe>`;
  modal.classList.remove("hidden");
}

// Initialize tab on load
document.addEventListener("DOMContentLoaded", () => {
  populateDocVehicleSelector();
  document.getElementById("docVehicleSelector")?.addEventListener("change", handleDocVehicleChange);
});

// ============================================================
// üì§ UPLOAD DOCUMENT MODAL LOGIC
// ============================================================

// Open upload modal
function openUploadModal(vehicleId, docName) {
  const modal = document.getElementById("uploadDocModal");
  if (!modal) return;

  document.getElementById("uploadDocVehicleId").value = vehicleId;
  document.getElementById("uploadDocType").value = docName;
  document.getElementById("uploadDocLabel").value = docName;
  modal.classList.remove("hidden");
}

// Close modal
function closeUploadModal() {
  document.getElementById("uploadDocModal").classList.add("hidden");
  document.getElementById("uploadDocForm").reset();
}

// Event listeners for modal buttons
document.getElementById("uploadDocClose")?.addEventListener("click", closeUploadModal);
document.getElementById("uploadDocCancel")?.addEventListener("click", closeUploadModal);

// Handle file upload
document.getElementById("uploadDocForm")?.addEventListener("submit", async (e) => {
  e.preventDefault();
  const vehicleId = document.getElementById("uploadDocVehicleId").value;
  const docType = document.getElementById("uploadDocType").value;
  const fileInput = document.getElementById("uploadDocFile");
  const file = fileInput.files[0];

  if (!file) {
    alert("Por favor, selecciona un archivo PDF.");
    return;
  }

  // For now, simulate upload success (later connect Firebase Storage or Flask /upload)
  console.log(`üì§ Simulando carga de ${file.name} para ${docType} (veh√≠culo: ${vehicleId})`);
  showToast(`Archivo "${file.name}" cargado correctamente para ${docType}`, "success");
  closeUploadModal();
});


// ===========================
// üë®‚Äç‚úàÔ∏è ASIGNACIONES
// ===========================
const mockAsignaciones = [
  { semana: "Semana 41 (2025)", conductor: "Juan Ndong", destino: "Embajada", km_inicio: 21040, km_fin: 21320 },
  { semana: "Semana 42 (2025)", conductor: "Pedro Obiang", destino: "Aeropuerto", km_inicio: 21320, km_fin: 21600 },
];

function showAsignaciones() {
  const body = `
    <table class="min-w-full border border-gray-300 rounded">
      <thead class="bg-blue-100">
        <tr>
          <th class="px-3 py-2 text-left text-sm">Semana</th>
          <th class="px-3 py-2 text-left text-sm">Conductor</th>
          <th class="px-3 py-2 text-left text-sm">Destino</th>
          <th class="px-3 py-2 text-left text-sm">Km Inicio</th>
          <th class="px-3 py-2 text-left text-sm">Km Fin</th>
        </tr>
      </thead>
      <tbody>
        ${mockAsignaciones.map(a => `
          <tr class="border-t">
            <td class="px-3 py-1">${a.semana}</td>
            <td class="px-3 py-1">${a.conductor}</td>
            <td class="px-3 py-1">${a.destino}</td>
            <td class="px-3 py-1">${a.km_inicio}</td>
            <td class="px-3 py-1">${a.km_fin}</td>
          </tr>`).join('')}
      </tbody>
    </table>`;
  createModal("Asignaciones Semanales", body);
}

// ===========================
// üß∞ MANTENIMIENTO
// ===========================
const mockMantenimientos = [
  { fecha: "2025-07-15", tipo: "Cambio de aceite", costo: "35,000 XAF", estado: "Completado" },
  { fecha: "2025-09-10", tipo: "Frenos", costo: "65,000 XAF", estado: "Pendiente" }
];

function showMantenimiento() {
  const body = `
    <table class="min-w-full border border-gray-300 rounded">
      <thead class="bg-blue-100">
        <tr>
          <th class="px-3 py-2 text-left text-sm">Fecha</th>
          <th class="px-3 py-2 text-left text-sm">Tipo</th>
          <th class="px-3 py-2 text-left text-sm">Costo</th>
          <th class="px-3 py-2 text-left text-sm">Estado</th>
        </tr>
      </thead>
      <tbody>
        ${mockMantenimientos.map(m => `
          <tr class="border-t">
            <td class="px-3 py-1">${m.fecha}</td>
            <td class="px-3 py-1">${m.tipo}</td>
            <td class="px-3 py-1">${m.costo}</td>
            <td class="px-3 py-1">${m.estado}</td>
          </tr>`).join('')}
      </tbody>
    </table>`;
  createModal("Historial de Mantenimiento", body);
}

// ===========================
// ‚õΩ CONSUMO
// ===========================
const mockConsumo = [
  { semana: "38", litros: 45, km: 350 },
  { semana: "39", litros: 50, km: 410 },
  { semana: "40", litros: 48, km: 390 },
  { semana: "41", litros: 52, km: 430 },
];

function showConsumo() {
  const avg = (mockConsumo.reduce((acc, x) => acc + (x.km / x.litros), 0) / mockConsumo.length).toFixed(2);
  const body = `
    <canvas id="fuelChart" height="140"></canvas>
    <p class="text-sm mt-2">Promedio de consumo: <strong>${avg} km/l</strong></p>`;
  createModal("Consumo de Combustible", body);
  renderFuelChart();
}

function renderFuelChart() {
  const ctx = document.getElementById('fuelChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: mockConsumo.map(c => "Semana " + c.semana),
      datasets: [{
        label: 'Litros',
        data: mockConsumo.map(c => c.litros),
        backgroundColor: '#004080'
      }]
    },
    options: { responsive: true, plugins: { legend: { display: false } } }
  });
}

// ============================================
// üß© CONNECT TO YOUR GESTI√ìN TAB BUTTONS
// ============================================
document.addEventListener("DOMContentLoaded", () => {
  const gestionTab = document.getElementById("gestionTab");
  if (!gestionTab) return;

  const [btnDocs, btnAsig] = gestionTab.querySelectorAll("button");

  if (btnDocs) btnDocs.addEventListener("click", showDocumentacion);
  if (btnAsig) btnAsig.addEventListener("click", showAsignaciones);
});

// ======================================================
// NEW DOCUMENTACION TAB CONTENT GENERATION (USING MOCK DATA)

// ======================================================
// ============================
// MOCK DOCUMENTS MAP (local demo)
// ============================
const mockDocs = {
  BN2450AD: [
    { name: "Cartilla √önica de Veh√≠culos (CUVE)", file: "cuve.pdf", vencimiento: "2026-01-13" },
    { name: "Certificado de Inspecci√≥n T√©cnica (ITV)", file: "itv.pdf", vencimiento: "2026-01-02" },
    { name: "T√≠tulo de Propiedad", file: "propiedad.pdf" },
    { name: "Seguro Obligatorio", file: "seguro.pdf", vencimiento: "2024-11-30" },
    { name: "Certificado de Importaci√≥n y Aduanas", file: "importacion.pdf" },
  ],
  BN0678TB: [
    { name: "Cartilla √önica de Veh√≠culos (CUVE)", file: "cuve.pdf", vencimiento: "2025-10-15" },
    { name: "Certificado de Inspecci√≥n T√©cnica (ITV)", file: "itv.pdf", vencimiento: "2026-01-02" },
    { name: "T√≠tulo de Propiedad", file: "propiedad.pdf" },
    { name: "Seguro Obligatorio", file: "seguro.pdf", vencimiento: "2025-10-15" },
    { name: "Certificado de Importaci√≥n y Aduanas", file: "importacion.pdf" },
  ],
  BN9098RT: [
    { name: "Cartilla √önica de Veh√≠culos (CUVE)", file: "cuve.pdf", vencimiento: "2026-01-13" },
    { name: "Certificado de Inspecci√≥n T√©cnica (ITV)", file: "itv.pdf", vencimiento: "2025-12-31" },
    { name: "T√≠tulo de Propiedad", file: "propiedad.pdf" },
    { name: "Seguro Obligatorio", file: "seguro.pdf", vencimiento: "2025-12-31" },
    { name: "Certificado de Importaci√≥n y Aduanas", file: "importacion.pdf" },
  ],
  BN4295CZ: [
    { name: "Cartilla √önica de Veh√≠culos (CUVE)", file: "cuve.pdf", vencimiento: "2026-01-13" },
    { name: "Certificado de Inspecci√≥n T√©cnica (ITV)", file: "itv.pdf", vencimiento: "2026-01-02" },
    { name: "T√≠tulo de Propiedad", file: "propiedad.pdf" },
    { name: "Seguro Obligatorio", file: "seguro.pdf", vencimiento: "2024-09-30" },
    { name: "Certificado de Importaci√≥n y Aduanas", file: "importacion.pdf" },
  ],
  BN1267CA: [
    { name: "Cartilla √önica de Veh√≠culos (CUVE)", file: "cuve.pdf", vencimiento: "2026-01-15" },
    { name: "Certificado de Inspecci√≥n T√©cnica (ITV)", file: "itv.pdf", vencimiento: "2026-01-02" },
    { name: "T√≠tulo de Propiedad", file: "propiedad.pdf" },
    { name: "Seguro Obligatorio", file: "seguro.pdf", vencimiento: "2026-01-15" },
    { name: "Certificado de Importaci√≥n y Aduanas", file: "importacion.pdf" },
  ],
};

function populateDocVehicleSelector() {
  const selector = document.getElementById("docVehicleSelector");
  if (!selector) return;

  const matriculas = Object.keys(mockDocs);
  selector.innerHTML = `<option value="">Seleccione un veh√≠culo</option>`;
  matriculas.forEach(m => {
    const opt = document.createElement("option");
    opt.value = m;
    opt.textContent = m;
    selector.appendChild(opt);
  });

  selector.addEventListener("change", e => renderDocumentacionList(e.target.value));
}


function renderDocumentacionList(matricula) {
  const container = document.getElementById("documentacionContainer");
  if (!container) return;
  container.innerHTML = "";

  if (!matricula || !mockDocs[matricula]) {
    container.innerHTML = `<p class="text-gray-500 text-sm text-center">Seleccione un veh√≠culo para ver su documentaci√≥n.</p>`;
    return;
  }

  const docs = mockDocs[matricula];
  const list = document.createElement("div");
  list.className = "flex flex-col gap-4 mt-4 w-full max-w-2xl mx-auto"; // ‚úÖ vertical stacking, centered

  docs.forEach(doc => {
    // Determine expiration status
    let statusColor = "bg-gray-300 text-gray-800";
    let statusText = "Sin fecha";

    if (doc.vencimiento) {
      const today = new Date();
      const exp = new Date(doc.vencimiento);
      const diffDays = Math.floor((exp - today) / (1000 * 60 * 60 * 24));

      if (diffDays < 0) {
        statusColor = "bg-red-600 text-white";
        statusText = `Vencido: ${doc.vencimiento}`;
      } else if (diffDays <= 30) {
        statusColor = "bg-orange-500 text-white";
        statusText = `Pr√≥x. vencimiento: ${doc.vencimiento}`;
      } else {
        statusColor = "bg-green-600 text-white";
        statusText = `Vence: ${doc.vencimiento}`;
      }
    }

    // Build the document button (stacked)
    const btn = document.createElement("button");
    btn.className = `
      flex flex-col sm:flex-row sm:items-center justify-between w-full
      border border-gray-300 rounded-lg px-4 py-3
      shadow-sm bg-white hover:bg-blue-50 transition-all duration-150
    `;
    btn.innerHTML = `
      <div class="flex items-center gap-3 text-left">
        <span class="text-lg">üìÑ</span>
        <div>
          <div class="font-medium text-gray-800">${doc.name}</div>
          <div class="text-xs text-gray-500">Haz clic para ver el documento PDF</div>
        </div>
      </div>
      <div class="mt-2 sm:mt-0">
        <span class="text-xs font-semibold px-2 py-1 rounded ${statusColor}">
          ${statusText}
        </span>
      </div>
    `;
    btn.addEventListener("click", () => openVehiclePDFViewer(matricula, doc.file, doc.name));
    list.appendChild(btn);
  });

  container.appendChild(list);
}

/* =========================
   üìÑ PDF VIEWER MODAL (Documentaci√≥n)
========================= */
function openVehiclePDFViewer(matricula, file, title) {
  const modal = document.getElementById("pdfViewerModal");
  const iframe = document.getElementById("pdfViewer");
  const nameEl = document.getElementById("pdfVehicleName");
  const plateEl = document.getElementById("pdfVehicleMatricula");
  const imgEl = document.getElementById("miniVehicleImg");
  const downloadBtn = document.getElementById("downloadPdfButton");

  const vehicleImages = {
    BN2450AD: "https://firebasestorage.googleapis.com/v0/b/atiempo-9f08a.firebasestorage.app/o/VIPClassMercedes-BenzSprinterbyCliveSutton022.jpg?alt=media&token=5e4de3e0-7a9d-4105-bb49-e09c94452969",
    BN0678TB: "https://firebasestorage.googleapis.com/v0/b/atiempo-9f08a.firebasestorage.app/o/corolla.jpg?alt=media&token=9f1abeae-e541-4a95-9d57-8dd784c4af69",
    BN9098RT: "https://firebasestorage.googleapis.com/v0/b/atiempo-9f08a.firebasestorage.app/o/F1.jpg?alt=media&token=82b293f5-8896-4717-964e-74dbef6ab3bf",
    BN4295CZ: "https://firebasestorage.googleapis.com/v0/b/atiempo-9f08a.firebasestorage.app/o/highlander-752x515.png?alt=media&token=9c751da1-da93-49d5-bdb5-c49fe226bae0",
    BN1267CA: "https://firebasestorage.googleapis.com/v0/b/atiempo-9f08a.firebasestorage.app/o/Tahoe.jpg?alt=media&token=1cef77cd-c340-47ee-92af-b4f7885304b1"
  };

  // set data
  iframe.src = `/static/mock_pdfs/${matricula}/${file}`;
  nameEl.textContent = title;
  plateEl.textContent = matricula;
  imgEl.src = vehicleImages[matricula] || "https://placehold.co/80x60";
  downloadBtn.href = `/static/mock_pdfs/${matricula}/${file}`;

  // show modal
  modal.classList.remove("hidden");
  modal.setAttribute("aria-hidden", "false");
  document.body.style.overflow = "hidden"; // lock scroll
}

function closeVehicleModal() {
  const modal = document.getElementById("pdfViewerModal");
  if (!modal) return;
  modal.classList.add("hidden");
  modal.setAttribute("aria-hidden", "true");
  document.body.style.overflow = ""; // unlock scroll
}

// universal handlers
document.addEventListener("click", (e) => {
  // Close when pressing the X
  if (e.target && e.target.id === "closeVehicleModal") {
    closeVehicleModal();
    return;
  }

  // Close when clicking the backdrop
  const modal = document.getElementById("pdfViewerModal");
  if (!modal || modal.classList.contains("hidden")) return;

  const content = modal.querySelector(".modal-content");
  if (e.target === modal && !content.contains(e.target)) {
    closeVehicleModal();
  }
});

// Close on ESC key
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    closeVehicleModal();
    closeVehicleDetailsModal(); // optional if vehicle modal open
  }
});

/* =========================
   üöó VEHICLE DETAILS MODAL (3D or info)
========================= */
function openVehicleDetailsModal() {
  const m = document.getElementById("vehicleDetailsModal");
  if (!m) return;
  m.classList.remove("hidden");
  m.setAttribute("aria-hidden", "false");
  document.body.style.overflow = "hidden";
}

function closeVehicleDetailsModal() {
  const m = document.getElementById("vehicleDetailsModal");
  if (!m) return;
  m.classList.add("hidden");
  m.setAttribute("aria-hidden", "true");
  document.body.style.overflow = "";
}

// Close vehicle details if X is clicked
document.getElementById("vehicleDetailsClose")?.addEventListener("click", closeVehicleDetailsModal);
/* ======================================================
   üß∞ MANTENIMIENTO Y REPARACIONES (Enhanced Version)
====================================================== */

// ‚úÖ Function to build correct PDF path dynamically
function getPdfPath(vehicleId, type) {
  return `static/maintenance_pdfs/${vehicleId}_${type}_sep2025.pdf`;
}

// ‚úÖ Mock maintenance summaries
const mockMaintenanceSummary = [
  {
    id: "isuzu123",
    marca: "Isuzu",
    modelo: "D-Max",
    matricula: "EG-4567-AB",
    totalGastado: 12500000,
    ultimaReparacion: "2025-09-12",
    proximaRevision: "2025-11-05",
  },
  {
    id: "mercedes456",
    marca: "Mercedes Sprinter",
    modelo: "315 CDI",
    matricula: "EG-9081-CD",
    totalGastado: 9800000,
    ultimaReparacion: "2025-08-29",
    proximaRevision: "2025-10-30",
  },
  {
    id: "toyota789",
    marca: "Toyota Land Cruiser V8",
    modelo: "V8",
    matricula: "EG-1234-EF",
    totalGastado: 15200000,
    ultimaReparacion: "2025-09-20",
    proximaRevision: "2025-11-15",
  },
  {
    id: "nissan321",
    marca: "Nissan Patrol",
    modelo: "SE",
    matricula: "EG-7782-GH",
    totalGastado: 8800000,
    ultimaReparacion: "2025-08-10",
    proximaRevision: "2025-10-10",
  },
  {
    id: "hilux654",
    marca: "Toyota Hilux SR5",
    modelo: "SR5",
    matricula: "EG-9999-IJ",
    totalGastado: 10500000,
    ultimaReparacion: "2025-09-05",
    proximaRevision: "2025-11-01",
  }
];

// ‚úÖ Mock maintenance history (10 months)
const mockMaintenanceHistory = {
  "isuzu123": [
    {
      fecha: "2025-09-12",
      tipo: "Cambio de frenos",
      taller: "Garage Central Malabo",
      descripcion: "Sustituci√≥n de discos y pastillas delanteras",
      montoCotizado: 1200000,
      montoPagado: 1200000,
      facturaPDF: getPdfPath("isuzu123", "factura"),
      pagoPDF: getPdfPath("isuzu123", "pago"),
    },
    {
      fecha: "2025-07-05",
      tipo: "Accidente leve",
      taller: "AutoClinic Malabo",
      descripcion: "Reparaci√≥n de parachoques y pintura parcial",
      montoCotizado: 1500000,
      montoPagado: 1500000,
      facturaPDF: getPdfPath("isuzu123", "factura"),
      pagoPDF: getPdfPath("isuzu123", "pago"),
    }
  ],
  "mercedes456": [
    {
      fecha: "2025-08-29",
      tipo: "Cambio de aceite + filtros",
      taller: "Mercedes Service Bata",
      descripcion: "Revisi√≥n general y mantenimiento preventivo",
      montoCotizado: 950000,
      montoPagado: 950000,
      facturaPDF: getPdfPath("mercedes456", "factura"),
      pagoPDF: getPdfPath("mercedes456", "pago"),
    }
  ],
  "toyota789": [
    {
      fecha: "2025-09-20",
      tipo: "Mantenimiento general",
      taller: "AutoHouse Malabo",
      descripcion: "Cambio de aceite, l√≠quidos y revisi√≥n de suspensi√≥n",
      montoCotizado: 1250000,
      montoPagado: 1250000,
      facturaPDF: getPdfPath("toyota789", "factura"),
      pagoPDF: getPdfPath("toyota789", "pago"),
    },
    {
      fecha: "2025-06-18",
      tipo: "Accidente moderado",
      taller: "Taller Premium EG",
      descripcion: "Reparaci√≥n de puerta y panel lateral",
      montoCotizado: 2200000,
      montoPagado: 2200000,
      facturaPDF: getPdfPath("toyota789", "factura"),
      pagoPDF: getPdfPath("toyota789", "pago"),
    }
  ],
  "nissan321": [
    {
      fecha: "2025-08-10",
      tipo: "Cambio de amortiguadores",
      taller: "AutoExpert Malabo",
      descripcion: "Sustituci√≥n de amortiguadores y alineaci√≥n de ruedas",
      montoCotizado: 1600000,
      montoPagado: 1600000,
      facturaPDF: getPdfPath("nissan321", "factura"),
      pagoPDF: getPdfPath("nissan321", "pago"),
    }
  ],
  "hilux654": [
    {
      fecha: "2025-09-05",
      tipo: "Cambio de correa de distribuci√≥n",
      taller: "Toyota Service Bata",
      descripcion: "Mantenimiento general con cambio de correa y revisi√≥n del motor",
      montoCotizado: 1400000,
      montoPagado: 1400000,
      facturaPDF: getPdfPath("hilux654", "factura"),
      pagoPDF: getPdfPath("hilux654", "pago"),
    }
  ]
};

/* ======================================================
   üìÑ PDF VIEWER HELPER
====================================================== */
function openPdfViewer(pdfPath) {
  const modal = document.getElementById("pdfModal");
  const frame = document.getElementById("pdfViewerFrame");
  frame.src = pdfPath;
  modal.classList.remove("hidden");
  modal.setAttribute("aria-hidden", "false");
  document.body.style.overflow = "hidden";
}
document.getElementById("closePdfBtn")?.addEventListener("click", () => {
  const modal = document.getElementById("pdfModal");
  const frame = document.getElementById("pdfViewerFrame");
  frame.src = "";
  modal.classList.add("hidden");
  modal.setAttribute("aria-hidden", "true");
  document.body.style.overflow = "";
});

/* ======================================================
   üß† RENDER MANTENIMIENTO TAB
====================================================== */
function renderMaintenanceTab() {
  const summaryContainer = document.getElementById("maintenanceSummaryContainer");
  const select = document.getElementById("maintenanceVehicleSelect");
  const tableBody = document.querySelector("#maintenanceHistoryTable tbody");
  if (!summaryContainer || !select || !tableBody) return;

  // --- Render resumen cards ---
  summaryContainer.innerHTML = "";
  mockMaintenanceSummary.forEach(v => {
    const card = document.createElement("div");
    card.className = "card border p-3 bg-white";
    card.innerHTML = `
      <h4 class="text-lg font-semibold mb-1">${v.marca} ${v.modelo}</h4>
      <p><strong>Matr√≠cula:</strong> ${v.matricula}</p>
      <p><strong>Total Gastado:</strong> ${v.totalGastado.toLocaleString()} XAF</p>
      <p><strong>√öltima Reparaci√≥n:</strong> ${v.ultimaReparacion}</p>
      <p><strong>Pr√≥xima Revisi√≥n:</strong> ${v.proximaRevision}</p>
      <button class="btn-secondary mt-2" onclick="loadMaintenanceHistory('${v.id}')">
        Ver Historial
      </button>
    `;
    summaryContainer.appendChild(card);
  });

  // --- Populate select dropdown ---
  select.innerHTML = `<option value="">‚Äî Seleccione un veh√≠culo ‚Äî</option>`;
  mockMaintenanceSummary.forEach(v => {
    const opt = document.createElement("option");
    opt.value = v.id;
    opt.textContent = `${v.marca} ${v.modelo} (${v.matricula})`;
    select.appendChild(opt);
  });
  select.onchange = () => loadMaintenanceHistory(select.value);

  // --- Load default vehicle ---
  loadMaintenanceHistory(mockMaintenanceSummary[0].id);
}

let maintenanceChartInstance = null;
function renderMaintenanceChart() {
  const ctx = document.getElementById("maintenanceChart");
  if (!ctx) return;
  const labels = mockMaintenanceSummary.map(v => `${v.marca} ${v.modelo}`);
  const data = mockMaintenanceSummary.map(v => v.totalGastado);
  if (maintenanceChartInstance) maintenanceChartInstance.destroy();
  maintenanceChartInstance = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "Total Gastado (XAF)",
        data,
        backgroundColor: ["#2563eb","#16a34a","#f59e0b","#ef4444","#6366f1"]
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, ticks: { callback: v => v.toLocaleString() } }
      }
    }
  });
}

/* ======================================================
   üìã LOAD HISTORY TABLE (Final: Works with .main-content scroll)
====================================================== */
function loadMaintenanceHistory(vehicleId) {
  const tableBody = document.querySelector("#maintenanceHistoryTable tbody");
  const historySection = document.getElementById("maintenanceHistoryTable");
  const scrollContainer =
    document.querySelector(".main-content") ||
    document.querySelector(".content-wrapper") ||
    window; // ‚úÖ pick whichever scrolls

  if (!tableBody || !historySection) return;

  // Clear existing rows
  tableBody.innerHTML = "";

  const records = mockMaintenanceHistory[vehicleId] || [];
  if (records.length === 0) {
    tableBody.innerHTML = `<tr><td colspan="8" class="text-center p-3">Sin registros de mantenimiento.</td></tr>`;
  } else {
    records.forEach(r => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${r.fecha}</td>
        <td>${r.tipo}</td>
        <td>${r.taller}</td>
        <td>${r.descripcion}</td>
        <td>${r.montoCotizado.toLocaleString()}</td>
        <td>${r.montoPagado.toLocaleString()}</td>
        <td><button class="btn" onclick="openPdfViewer('${r.facturaPDF}')">üìÑ</button></td>
        <td><button class="btn" onclick="openPdfViewer('${r.pagoPDF}')">üí∞</button></td>
      `;
      tableBody.appendChild(row);
    });
  }

  // üîΩ Scroll after table has rendered
  setTimeout(() => {
    if (scrollContainer && historySection) {
      const sectionOffset =
        historySection.getBoundingClientRect().top +
        (scrollContainer.scrollTop || window.scrollY) -
        100; // leave top margin

      scrollContainer.scrollTo({
        top: sectionOffset,
        behavior: "smooth"
      });

      // ‚ú® Highlight for visibility
      historySection.classList.add("ring", "ring-yellow-400", "ring-offset-2");
      setTimeout(() => {
        historySection.classList.remove("ring", "ring-yellow-400", "ring-offset-2");
      }, 1500);
    }
  }, 300);
}
/* ======================================================
   üë®‚Äç‚úàÔ∏è CONDUCTORES TAB LOGIC
====================================================== */

// Mock drivers
const mockDrivers = [
  {
    id: "D001",
    nombre: "Juan Mba",
    licencia: "EG-DL-10234",
    expiracion: "2026-03-15",
    foto: "static/driver_photos/juan_mba.jpg",
  },
  {
    id: "D002",
    nombre: "Mar√≠a Esono",
    licencia: "EG-DL-10455",
    expiracion: "2027-08-21",
    foto: "static/driver_photos/maria_esono.jpg",
  },
  {
    id: "D003",
    nombre: "Pedro Nchama",
    licencia: "EG-DL-11092",
    expiracion: "2026-11-09",
    foto: "static/driver_photos/pedro_nchama.jpg",
  },
  {
    id: "D004",
    nombre: "Carmen Nsue",
    licencia: "EG-DL-12045",
    expiracion: "2025-12-01",
    foto: "static/driver_photos/carmen_nsue.jpg",
  },
  {
    id: "D005",
    nombre: "Daniel Abaga",
    licencia: "EG-DL-13088",
    expiracion: "2027-04-10",
    foto: "static/driver_photos/daniel_abaga.jpg",
  },
];

// Reuse your existing vehicles
const mockVehicles = [
  { id: "isuzu123", nombre: "Isuzu D-Max", matricula: "EG-4567-AB" },
  { id: "mercedes456", nombre: "Mercedes Sprinter 315 CDI", matricula: "EG-9081-CD" },
  { id: "toyota789", nombre: "Toyota Land Cruiser V8 V8", matricula: "EG-1234-EF" },
  { id: "nissan321", nombre: "Nissan Patrol SE", matricula: "EG-7856-GH" },
  { id: "hilux654", nombre: "Toyota Hilux SR5 SR5", matricula: "EG-1278-YZ" },
];

// Generate 10 months of mock assignment data
const mockDriverAssignments = [];

(function generateDriverAssignments() {
  const startDate = new Date();
  startDate.setMonth(startDate.getMonth() - 10);

  for (let i = 0; i < 300; i++) {
    const driver = mockDrivers[Math.floor(Math.random() * mockDrivers.length)];
    const vehicle = mockVehicles[Math.floor(Math.random() * mockVehicles.length)];
    const fecha = new Date(startDate.getTime() + Math.random() * (Date.now() - startDate.getTime()));
    const fechaStr = fecha.toISOString().split("T")[0];
    const kmInicio = Math.floor(Math.random() * 90000) + 10000;
    const kmFin = kmInicio + Math.floor(Math.random() * 500);

    mockDriverAssignments.push({
      fecha: fechaStr,
      conductor: driver.nombre,
      conductorId: driver.id,
      vehiculo: vehicle.nombre,
      matricula: vehicle.matricula,
      kmInicio,
      kmFin,
      observacion: ["Viaje oficial", "Mantenimiento", "Transporte personal", "Recorrido local"][Math.floor(Math.random() * 4)],
    });
  }
})();

/* ======================================================
   üß≠ RENDER FUNCTIONS
====================================================== */
function showDriversTabContent() {
  populateDriverSelectors();
  renderDriverAssignmentsTable(mockDriverAssignments);
    renderDriversChart(); 
}

// Populate dropdowns
function populateDriverSelectors() {
  const driverSelect = document.getElementById("driverSelect");
  const vehicleSelect = document.getElementById("driverVehicleSelect");

  if (driverSelect && driverSelect.options.length <= 1) {
    mockDrivers.forEach(d => {
      const opt = document.createElement("option");
      opt.value = d.id;
      opt.textContent = d.nombre;
      driverSelect.appendChild(opt);
    });
  }

  if (vehicleSelect && vehicleSelect.options.length <= 1) {
    mockVehicles.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v.id;
      opt.textContent = `${v.nombre} (${v.matricula})`;
      vehicleSelect.appendChild(opt);
    });
  }
}

/* ======================================================
   üîç SEARCH FILTER HANDLER (with chart refresh)
====================================================== */
document.getElementById("searchAssignmentsBtn")?.addEventListener("click", () => {
  const driverId = document.getElementById("driverSelect").value;
  const vehicleId = document.getElementById("driverVehicleSelect").value;
  const date = document.getElementById("driverDateSelect").value;

  // Start from all mock assignments
  let filtered = [...mockDriverAssignments];

  // Apply filters one by one
  if (driverId) filtered = filtered.filter(a => a.conductorId === driverId);
  if (vehicleId) {
    const vehicleName = mockVehicles.find(v => v.id === vehicleId)?.nombre;
    if (vehicleName) filtered = filtered.filter(a => a.vehiculo === vehicleName);
  }
  if (date) filtered = filtered.filter(a => a.fecha === date);

  // üßæ Render filtered results in the table
  renderDriverAssignmentsTable(filtered);

  // üë§ Show driver info card (only if driver selected)
  showDriverInfo(driverId);

  // üìä Refresh chart with current filtered data
  renderDriversChart(filtered);
});


// Render results table
function renderDriverAssignmentsTable(assignments) {
  const tbody = document.querySelector("#driverAssignmentsTable tbody");
  tbody.innerHTML = "";

  if (assignments.length === 0) {
    tbody.innerHTML = `<tr><td colspan="7" class="text-center p-3">Sin registros de conducci√≥n.</td></tr>`;
    return;
  }

  assignments
    .sort((a, b) => new Date(b.fecha) - new Date(a.fecha))
    .forEach(a => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${a.fecha}</td>
        <td>${a.conductor}</td>
        <td>${a.vehiculo}</td>
        <td>${a.matricula}</td>
        <td>${a.kmInicio.toLocaleString()}</td>
        <td>${a.kmFin.toLocaleString()}</td>
        <td>${a.observacion}</td>
      `;
      tbody.appendChild(row);
    });
}

/* ======================================================
   üßë‚Äç‚úàÔ∏è Show Driver Info (Enhanced Visuals)
====================================================== */
/* ======================================================
   üßë‚Äç‚úàÔ∏è Show Driver Info (Interactive Tags)
====================================================== */
function showDriverInfo(driverId) {
  const card = document.getElementById("driverInfoCard");
  if (!card) return;

  if (!driverId) {
    card.classList.add("hidden");
    return;
  }

  const driver = mockDrivers.find(d => d.id === driverId);
  if (!driver) return;

  // Update driver info
  document.getElementById("driverPhoto").src = driver.foto;
  document.getElementById("driverName").textContent = driver.nombre;
  document.getElementById("driverLicense").textContent = `Licencia: ${driver.licencia}`;
  document.getElementById("driverExpiry").textContent = `Expira: ${driver.expiracion}`;

  // Status badge
  const badge = document.getElementById("driverStatusBadge");
  const active = Math.random() > 0.3;
  badge.textContent = active ? "ACTIVO" : "INACTIVO";
  badge.className = `absolute bottom-0 right-1 text-white text-xs px-2 py-1 rounded-full shadow-md font-semibold ${
    active ? "bg-green-500" : "bg-gray-400"
  }`;

  // Vehicle tags (interactive)
  const tagsContainer = document.getElementById("driverVehicleTags");
  tagsContainer.innerHTML = "";

  const recentAssignments = mockDriverAssignments
    .filter(a => a.conductorId === driverId)
    .slice(-3)
    .reverse();

  if (recentAssignments.length === 0) {
    tagsContainer.innerHTML = `<span class="text-gray-500 text-sm italic">Sin registros recientes</span>`;
  } else {
    recentAssignments.forEach(a => {
      const tag = document.createElement("span");
      tag.className =
        "bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-1 rounded-full border border-blue-300 cursor-pointer hover:bg-blue-700 hover:text-white transition-all";
      tag.textContent = `${a.vehiculo}`;
      tag.title = "Filtrar por este veh√≠culo";

      // ‚úÖ When clicked, filter table + chart for this vehicle
      tag.addEventListener("click", () => {
        const filtered = mockDriverAssignments.filter(
          r => r.conductorId === driverId && r.vehiculo === a.vehiculo
        );

        renderDriverAssignmentsTable(filtered);
        renderDriversChart(filtered);

        // Optional: Scroll down smoothly to table
        const table = document.getElementById("driverAssignmentsTable");
        if (table) {
          table.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      });

      tagsContainer.appendChild(tag);
    });
  }

  card.classList.remove("hidden");
}

/* ======================================================
   üìä CHART: Conducciones por Conductor (√∫ltimos 10 meses)
====================================================== */
let driversActivityChartInstance = null;

function renderDriversChart(assignments = mockDriverAssignments) {
  const canvas = document.getElementById("driversActivityChart");
  if (!canvas) return;

  // Aggregate counts per driver
  const counts = {};
  const tenMonthsAgo = new Date();
  tenMonthsAgo.setMonth(tenMonthsAgo.getMonth() - 10);

  mockDrivers.forEach(d => (counts[d.id] = 0));
  (assignments || []).forEach(a => {
    const d = new Date(a.fecha);
    if (d >= tenMonthsAgo && counts[a.conductorId] !== undefined) {
      counts[a.conductorId] += 1;
    }
  });

  const labels = mockDrivers.map(d => d.nombre);
  const data = mockDrivers.map(d => counts[d.id]);

  if (driversActivityChartInstance) driversActivityChartInstance.destroy();

  driversActivityChartInstance = new Chart(canvas, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "Conducciones",
        data,
        backgroundColor: ["#2563eb","#16a34a","#f59e0b","#ef4444","#6366f1"],
        borderColor: "#1e3a8a",
        borderWidth: 1.5
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: "Actividad por Conductor",
          color: "#1e3a8a",
          font: { size: 16, weight: "bold" }
        },
        tooltip: {
          callbacks: { label: ctx => `${ctx.parsed.x} conducciones` }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          grid: { color: "#e2e8f0" },
          ticks: { color: "#1e3a8a", precision: 0 }
        },
        y: {
          grid: { display: false },
          ticks: { color: "#1e3a8a" }
        }
      }
    }
  });
}
// ======================================================
// üõ¢Ô∏è MOCK DATA: CONSUMO DE COMBUSTIBLE (10 MESES)
// ======================================================
const mockFuelData = {
  isuzu123: [
    { mes: "Enero", litros: 420, km: 3100 },
    { mes: "Febrero", litros: 400, km: 2900 },
    { mes: "Marzo", litros: 410, km: 3050 },
    { mes: "Abril", litros: 390, km: 2850 },
    { mes: "Mayo", litros: 415, km: 3000 },
    { mes: "Junio", litros: 395, km: 2800 },
    { mes: "Julio", litros: 400, km: 2970 },
    { mes: "Agosto", litros: 405, km: 3005 },
    { mes: "Septiembre", litros: 410, km: 3035 },
    { mes: "Octubre", litros: 415, km: 3075 },
  ],
  mercedes456: [
    { mes: "Enero", litros: 350, km: 2300 },
    { mes: "Febrero", litros: 340, km: 2200 },
    { mes: "Marzo", litros: 355, km: 2350 },
    { mes: "Abril", litros: 330, km: 2150 },
    { mes: "Mayo", litros: 345, km: 2250 },
    { mes: "Junio", litros: 340, km: 2230 },
    { mes: "Julio", litros: 350, km: 2300 },
    { mes: "Agosto", litros: 360, km: 2350 },
    { mes: "Septiembre", litros: 355, km: 2320 },
    { mes: "Octubre", litros: 345, km: 2280 },
  ],
  toyota789: [
    { mes: "Enero", litros: 280, km: 1800 },
    { mes: "Febrero", litros: 275, km: 1750 },
    { mes: "Marzo", litros: 285, km: 1820 },
    { mes: "Abril", litros: 290, km: 1880 },
    { mes: "Mayo", litros: 300, km: 1900 },
    { mes: "Junio", litros: 295, km: 1870 },
    { mes: "Julio", litros: 305, km: 1950 },
    { mes: "Agosto", litros: 300, km: 1920 },
    { mes: "Septiembre", litros: 310, km: 1980 },
    { mes: "Octubre", litros: 305, km: 1960 },
  ],
  ford321: [
    { mes: "Enero", litros: 500, km: 3600 },
    { mes: "Febrero", litros: 520, km: 3700 },
    { mes: "Marzo", litros: 510, km: 3680 },
    { mes: "Abril", litros: 530, km: 3750 },
    { mes: "Mayo", litros: 525, km: 3740 },
    { mes: "Junio", litros: 510, km: 3650 },
    { mes: "Julio", litros: 515, km: 3700 },
    { mes: "Agosto", litros: 520, km: 3725 },
    { mes: "Septiembre", litros: 530, km: 3760 },
    { mes: "Octubre", litros: 540, km: 3820 },
  ],
  nissan654: [
    { mes: "Enero", litros: 310, km: 2000 },
    { mes: "Febrero", litros: 315, km: 2050 },
    { mes: "Marzo", litros: 320, km: 2100 },
    { mes: "Abril", litros: 305, km: 1980 },
    { mes: "Mayo", litros: 310, km: 2020 },
    { mes: "Junio", litros: 315, km: 2060 },
    { mes: "Julio", litros: 318, km: 2080 },
    { mes: "Agosto", litros: 322, km: 2110 },
    { mes: "Septiembre", litros: 325, km: 2130 },
    { mes: "Octubre", litros: 328, km: 2150 },
  ]
};

const FUEL_PRICE = 490; // XAF per liter
let consumptionChartInstance = null;

// ======================================================
// üß≠ UPDATED TAB RENDERER WITH COMPARISON MODE
// ======================================================
function renderConsumptionTab() {
  const vehicleSelect = document.getElementById("consumptionVehicleSelect");
  const metricSelect = document.getElementById("consumptionMetric");
  const monthSelect = document.getElementById("consumptionMonthSelect");
  const comparisonToggle = document.getElementById("comparisonMode");
  const tableBody = document.querySelector("#consumptionHistoryTable tbody");
  if (!vehicleSelect || !metricSelect || !tableBody) return;

  // Populate vehicle dropdown
  vehicleSelect.innerHTML = "";
  Object.keys(mockFuelData).forEach(id => {
    const opt = document.createElement("option");
    opt.value = id;
    opt.textContent = id.toUpperCase();
    vehicleSelect.appendChild(opt);
  });

  // Initial render
  const selectedVehicle = vehicleSelect.value || Object.keys(mockFuelData)[0];
  renderConsumptionChart(selectedVehicle, metricSelect.value, comparisonToggle.checked, monthSelect.value);
  renderConsumptionTable(selectedVehicle, monthSelect.value);

  // Listeners
  vehicleSelect.addEventListener("change", () => {
    renderConsumptionChart(vehicleSelect.value, metricSelect.value, comparisonToggle.checked, monthSelect.value);
    renderConsumptionTable(vehicleSelect.value, monthSelect.value);
  });

  metricSelect.addEventListener("change", () => {
    renderConsumptionChart(vehicleSelect.value, metricSelect.value, comparisonToggle.checked, monthSelect.value);
  });

  comparisonToggle.addEventListener("change", () => {
    const compare = comparisonToggle.checked;
    vehicleSelect.disabled = compare;
    renderConsumptionChart(vehicleSelect.value, metricSelect.value, compare, monthSelect.value);
    if (!compare) renderConsumptionTable(vehicleSelect.value, monthSelect.value);
    else tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-3">Comparaci√≥n activa: seleccione un veh√≠culo para ver detalles.</td></tr>`;
  });

  // New: month selector
  monthSelect.addEventListener("change", () => {
    renderConsumptionChart(vehicleSelect.value, metricSelect.value, comparisonToggle.checked, monthSelect.value);
    renderConsumptionTable(vehicleSelect.value, monthSelect.value);
  });
}


// ======================================================
// üíß LIQUID FUEL TANK PLUGIN (WAVES + TRANSPARENCY)
// ======================================================
const liquidGlassPlugin = {
  id: 'liquidGlass',
  afterDatasetsDraw(chart, args, options) {
    const { ctx } = chart;
    const dataset = chart.data.datasets[0];
    if (!dataset || !dataset.label || !dataset.label.toLowerCase().includes('litro')) return;

    const time = Date.now() / 600; // wave speed
    const meta = chart.getDatasetMeta(0);
    const bars = meta.data;

    bars.forEach((bar, i) => {
      const { x, y, base } = bar.getProps(['x', 'y', 'base'], true);
      const barHeight = base - y;
      const barWidth = bar.width;

      // Transparent glass tank outline
      ctx.save();
      ctx.beginPath();
      ctx.roundRect(x - barWidth / 2, y, barWidth, barHeight, 6);
      ctx.strokeStyle = "rgba(22, 163, 74, 0.5)";
      ctx.lineWidth = 3;
      ctx.stroke();

      // Clipping region for the ‚Äúliquid‚Äù
      ctx.clip();

      // Liquid gradient
      const gradient = ctx.createLinearGradient(0, y, 0, base);
      gradient.addColorStop(0, "rgba(52, 211, 153, 0.8)");
      gradient.addColorStop(0.5, "rgba(16, 185, 129, 0.9)");
      gradient.addColorStop(1, "rgba(6, 95, 70, 1)");
      ctx.fillStyle = gradient;

      // Draw the wavy liquid surface
      const waveAmplitude = Math.min(barHeight * 0.08, 6);
      const waveFrequency = 2;
      const waveOffset = (time + i) % (2 * Math.PI);

      ctx.beginPath();
      const points = 30;
      for (let j = 0; j <= points; j++) {
        const px = x - barWidth / 2 + (j / points) * barWidth;
        const py = base - barHeight +
          waveAmplitude * Math.sin((j / points) * waveFrequency * Math.PI * 2 + waveOffset);
        j === 0 ? ctx.moveTo(px, py) : ctx.lineTo(px, py);
      }
      ctx.lineTo(x + barWidth / 2, base);
      ctx.lineTo(x - barWidth / 2, base);
      ctx.closePath();
      ctx.fill();

      // Glass reflection highlight
      const reflection = ctx.createLinearGradient(x - barWidth / 2, y, x, base);
      reflection.addColorStop(0, "rgba(255,255,255,0.3)");
      reflection.addColorStop(1, "rgba(255,255,255,0)");
      ctx.fillStyle = reflection;
      ctx.fillRect(x - barWidth / 2, y, barWidth * 0.25, barHeight);

      ctx.restore();
    });
  }
};

// ======================================================
// üìä RENDER CONSUMPTION CHART (FINAL VERSION)
// ======================================================
function renderConsumptionChart(vehicleId, metric = "liters", comparisonMode = false, monthFilter = "all") {
  const ctx = document.getElementById("consumptionChart");
  if (!ctx) return;

  if (consumptionChartInstance) consumptionChartInstance.destroy();

  const labels = mockFuelData[Object.keys(mockFuelData)[0]].map(d => d.mes);
  const colors = ["#2563eb", "#22c55e", "#f59e0b", "#ef4444", "#8b5cf6"];
  let datasets = [];

  // ======================================================
  // üîÅ COMPARISON MODE
  // ======================================================
  if (comparisonMode) {
    Object.keys(mockFuelData).forEach((vid, index) => {
      const data = mockFuelData[vid].filter(d => monthFilter === "all" || d.mes === monthFilter);
      const values = metric === "liters"
        ? data.map(d => d.litros)
        : data.map(d => d.litros * FUEL_PRICE);

      datasets.push({
        label: vid.toUpperCase(),
        data: values,
        borderColor: colors[index % colors.length],
        backgroundColor: colors[index % colors.length] + "33",
        tension: 0.3,
        fill: false
      });
    });
  }

  // ======================================================
  // üöó SINGLE VEHICLE MODE (Animated ‚ÄúLiquid‚Äù bars)
  // ======================================================
  else {
    const data = mockFuelData[vehicleId].filter(d => monthFilter === "all" || d.mes === monthFilter);
    const values = metric === "liters"
      ? data.map(d => d.litros)
      : data.map(d => d.litros * FUEL_PRICE);

    const ctx2d = ctx.getContext("2d");
    let waveOffset = 0; // Used to animate the liquid wave

    // Create a gradient fill (animated wave)
    const createLiquidGradient = () => {
      const gradient = ctx2d.createLinearGradient(0, 0, 0, 400);
      if (metric === "liters") {
        gradient.addColorStop(0, `rgba(34,197,94,0.9)`); // bright green top
        gradient.addColorStop(1, `rgba(16,185,129,0.9)`); // deep green bottom
      } else {
        gradient.addColorStop(0, "#2563eb");
        gradient.addColorStop(1, "#1e3a8a");
      }
      return gradient;
    };

    datasets = [{
      label: metric === "liters" ? "Consumo (Litros)" : "Costo (XAF)",
      data: values,
      backgroundColor: createLiquidGradient(),
      borderColor: metric === "liters" ? "#065f46" : "#1e3a8a",
      borderWidth: 2,
      borderRadius: 6
    }];
const wavePlugin = {
  id: "liquidInsideBars",
  afterDatasetsDraw(chart) {
    const { ctx, chartArea, data } = chart;
    if (!chartArea) return;

    const dataset = data.datasets[0];
    const meta = chart.getDatasetMeta(0);
    if (!meta || !meta.data) return;

    const time = Date.now() / 250; // animation phase

    meta.data.forEach((bar, i) => {
      const { x, y, base } = bar;
      const barWidth = bar.width;
      const barHeight = base - y;

      // Create clipping region inside bar
      ctx.save();
      ctx.beginPath();
      ctx.rect(x - barWidth / 2, y, barWidth, barHeight);
      ctx.clip();

      // Draw moving liquid wave
      ctx.beginPath();
      const amplitude = 4;
      const frequency = 0.06;
      const phase = time + i;
      for (let px = x - barWidth / 2; px <= x + barWidth / 2; px++) {
        const py =
          base -
          ((barHeight / 2) +
            Math.sin((px * frequency) + phase) * amplitude);
        if (px === x - barWidth / 2) ctx.moveTo(px, py);
        else ctx.lineTo(px, py);
      }
      ctx.lineTo(x + barWidth / 2, base);
      ctx.lineTo(x - barWidth / 2, base);
      ctx.closePath();

      // üü† Orange gradient fill for the ‚Äúliquid‚Äù
      const gradient = ctx.createLinearGradient(0, y, 0, base);
      gradient.addColorStop(0, "rgba(249,115,22,0.9)");  // top (bright orange)
      gradient.addColorStop(1, "rgba(234,88,12,0.9)");   // bottom (deep orange)
      ctx.fillStyle = gradient;
      ctx.fill();
      ctx.restore();
    });
  }
};
Chart.register(wavePlugin);
  }

  // ======================================================
  // üìä CREATE CHART
  // ======================================================
  consumptionChartInstance = new Chart(ctx, {
    type: comparisonMode ? "line" : "bar",
    data: { labels, datasets },
    options: {
  responsive: true,
  animation: {
    duration: 1200,
    easing: "easeOutElastic"
  },
 plugins: {
  legend: {
    position: "top",
    align: "center",
    labels: {
      color: "#111827",           // darker text for visibility
      font: { size: 14, weight: "bold" },
      boxWidth: 18,
      boxHeight: 9,
      usePointStyle: true,
      pointStyle: "circle",
      padding: 14
    },
    // add a white translucent background and border around legend
    rtl: false,
    onHover: (e) => e.native.target.style.cursor = "pointer",
    onLeave: (e) => e.native.target.style.cursor = "default"
  },
  legendBackground: {
    display: true
  },
  title: {
    display: true,
    text: comparisonMode
      ? "Comparaci√≥n de Consumo entre Veh√≠culos"
      : metric === "liters"
        ? "Consumo de Combustible (Litros)"
        : "Costo Total de Combustible (XAF)",
    color: "#111827",
    font: { size: 16, weight: "bold" },
    padding: { top: 10, bottom: 10 }
  },
  tooltip: {
    backgroundColor: "rgba(17, 24, 39, 0.9)",
    titleColor: "#fefefe",
    bodyColor: "#fefefe",
    borderColor: "#1e3a8a",
    borderWidth: 1,
    padding: 10,
    cornerRadius: 6
  }
},

  scales: {
    y: {
      beginAtZero: true,
      ticks: {
        color: "#1e3a8a",
        font: { size: 12, weight: "bold" }
      },
      grid: { color: "rgba(0,0,0,0.05)" }
    },
    x: {
      ticks: {
        color: "#1e3a8a",
        font: { size: 12 }
      },
      grid: { color: "rgba(0,0,0,0.03)" }
    }
  }
}
  });

  // Animate wave fill when in liters mode
  if (!comparisonMode && metric === "liters") {
    const animate = () => {
      if (!consumptionChartInstance) return;
      consumptionChartInstance.update("none");
      requestAnimationFrame(animate);
    };
    requestAnimationFrame(animate);
  }
}

// ======================================================
// üìã RENDER TABLE
// ======================================================
function renderConsumptionTable(vehicleId, monthFilter = "all") {
  const data = mockFuelData[vehicleId].filter(d => monthFilter === "all" || d.mes === monthFilter);
  const tableBody = document.querySelector("#consumptionHistoryTable tbody");
  if (!data || !tableBody) return;

  tableBody.innerHTML = "";
  data.forEach(d => {
    const costo = d.litros * FUEL_PRICE;
    const rendimiento = (d.km / d.litros).toFixed(2);
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${d.mes}</td>
      <td>${d.litros.toLocaleString()}</td>
      <td>${costo.toLocaleString()}</td>
      <td>${d.km.toLocaleString()}</td>
      <td>${rendimiento}</td>
    `;
    tableBody.appendChild(row);
  });
}

window.renderConsumptionTab = renderConsumptionTab;

/* ======================================================
   üîß CONSUMO DE COMBUSTIBLE - INITIALIZATION FIX
====================================================== */
function showConsumoTabContent() {
  console.log("‚õΩ Rendering Consumo de Combustible tab...");
  renderConsumptionTab();
}

/* ======================================================
   üß© SPACING FIX FOR CONSUMPTION TAB
====================================================== */
document.addEventListener("DOMContentLoaded", () => {
  const consumoTab = document.getElementById("consumptionTab");
  if (consumoTab) {
    consumoTab.style.display = "flex";
    consumoTab.style.flexDirection = "column";
    consumoTab.style.gap = "20px"; // uniform gap between cards
  }
});

// --- Hard-stop bandaids so UI never crashes again ---

// Sub-tab toggler used in Detalles modal (safe no-op if the tab doesn't exist)
function showSubTab(id) {
  const ids = [
    "detailsSubDatos",
    "detailsSubSeguro",
    "detailsSubPermiso",
    "detailsSubTasa",
    "detailsSubMantenimiento",
    "detailsSubConsumo",
    "detailsSubDocs"
  ];
  ids.forEach(tid => {
    const el = document.getElementById(tid);
    const btn = document.querySelector(`[data-subtab="${tid}"]`);
    if (el) el.classList.add("hidden");
    if (btn) btn.classList.remove("active");
  });
  const target = document.getElementById(id);
  const targetBtn = document.querySelector(`[data-subtab="${id}"]`);
  if (target) target.classList.remove("hidden");
  if (targetBtn) targetBtn.classList.add("active");
}

// Open the main Documentaci√≥n tab, optionally preselect a vehicle
function showDocumentacion(vehicleId = "") {
  const btn = document.querySelector(`.tab .tablinks[onclick*="documentacionTab"]`);
  if (btn) btn.click();
  const sel = document.getElementById("docVehicleSelector");
  if (sel && vehicleId) {
    sel.value = vehicleId;
    const ev = new Event("change");
    sel.dispatchEvent(ev);
  }
}

// Minimal safe-guards for loaders used across the page
function showLoadingIndicator() {
  const el = document.getElementById("loadingIndicator");
  if (el) el.classList.remove("hidden");
}
function hideLoadingIndicator() {
  const el = document.getElementById("loadingIndicator");
  if (el) el.classList.add("hidden");
}

</script>
{% endblock %}