<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mi Perfil - ATiempo</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' https://www.gstatic.com;">
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <style>
        :root { --primary-color: #004080; --border-inner: 2px solid black; }
        body { font-family: 'Roboto', sans-serif; margin: 0; background: #f4f4f4; height: 100vh; display: flex; flex-direction: column; }
        header { background-color: var(--primary-color); color: white; padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; border: var(--border-inner); }
        header img { height: 60px; }
        .content-wrapper { flex: 1; display: flex; overflow: hidden; }
        .sidebar { background-color: var(--primary-color); border-right: var(--border-inner); width: 240px; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        .sidebar button { padding: 15px; font-size: 15px; text-align: left; border: var(--border-inner); border-radius: 6px; background-color: #007bff; color: white; cursor: pointer; }
        .main-content { border-left: var(--border-inner); flex: 1; padding: 30px; overflow-y: auto; }
        .tab-switcher { border-bottom: var(--border-inner); margin-bottom: 20px; }
        .tab-link { background-color: #f1f1f1; border: 1px solid #ccc; border-bottom: none; cursor: pointer; padding: 10px 20px; font-size: 16px; font-weight: 700; }
        .tab-link.active { background-color: var(--primary-color); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .profile-card { background: #fff; padding: 20px; border: var(--border-inner); border-radius: 8px; margin-bottom: 20px; }
        .profile-header { text-align: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 20px;}
        .profile-header img { width: 120px; height: 120px; border-radius: 50%; border: 3px solid var(--primary-color); object-fit: cover; }
        .profile-header h2 { margin: 10px 0 0; }
        .profile-header p { color: #555; margin: 5px 0; }
        .details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px 25px; }
        .detail-item strong { display: block; font-size: 12px; color: #555; text-transform: uppercase; }
        .detail-item span { font-size: 16px; color: #000; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
        th { background-color: #f2f2f2; }
        /* Style for nested table headers */
        th.deducciones-header { text-align: center; background-color: #e0e0e0; }
        .filter-group { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .filter-item label { font-weight: bold; margin-right: 5px; }
        .attendance-row { cursor: pointer; }
        .attendance-row:hover { background-color: #f0f8ff; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 25px 30px; border: 4px solid black; border-radius: 8px; width: 90%; max-width: 500px; }
        .modal-content textarea { width: 100%; height: 100px; padding: 10px; margin-top: 10px; box-sizing: border-box; }
        .modal-content button { margin-top: 15px; padding: 10px 20px; }
    </style>
</head>
<body>
    <header>
        <div style="display: flex; align-items: center;"><img src="{{ url_for('static', filename='assets/atiempologo.png') }}" alt="Logo"><h1>MI PERFIL</h1></div>
    </header>

    <div class="content-wrapper">
        <div class="sidebar">
            <button onclick="window.location.href='/'"> MENU PRINCIPAL</button>
            <button onclick="window.location.href='/mi-perfil'"> MI PERFIL</button>
            <button onclick="window.location.href='/asistencia'"> ASISTENCIA</button>
            <button onclick="window.location.href='/empleados'"> EMPLEADOS</button>
        </div>

        <div class="main-content">
            <div id="auth-message"><p>Autenticando...</p></div>

            <div id="profile-content" style="display: none;">
                <div class="profile-card profile-header">
                    <img id="detail_photo" src="https://placehold.co/120" alt="Foto de Perfil">
                    <h2 id="detail_nombre_completo">---</h2>
                    <p id="detail_puesto">---</p>
                </div>

                <div class="tab-switcher">
                    <button class="tab-link active" onclick="openTab(event, 'personales')">Datos Personales</button>
                    <button class="tab-link" onclick="openTab(event, 'asistencia')">Mi Asistencia</button>
                    <button class="tab-link" onclick="openTab(event, 'nomina')">Mis N贸minas</button>
                </div>

                <div id="personales" class="tab-content active">
                    <div class="profile-card">
                        <h3>Informaci贸n Personal</h3>
                        <div class="details-grid" id="personal-details-grid"></div>
                    </div>
                </div>
                <div id="asistencia" class="tab-content">
                    <div class="profile-card">
                        <h3>Consultar Asistencia</h3>
                        <div class="filter-group">
                            <div class="filter-item"><label for="yearSelect">A帽o:</label><select id="yearSelect"></select></div>
                            <div class="filter-item"><label for="monthSelect">Mes:</label><select id="monthSelect"></select></div>
                        </div>
                        <table id="attendanceTable"><thead><tr><th>D铆a</th><th>Entrada</th><th>Salida</th><th>Explicaci贸n</th></tr></thead><tbody></tbody></table>
                    </div>
                </div>
                <div id="nomina" class="tab-content">
                    <div class="profile-card">
                        <h3>Historial de N贸minas</h3>
                        <table id="payrollTable">
                            <thead>
                                <tr>
                                    <th rowspan="2">Periodo</th>
                                    <th rowspan="2">Fecha de Pago</th>
                                    <th rowspan="2">Salario Bruto</th>
                                    <th colspan="4" class="deducciones-header">Deducciones</th>
                                    <th rowspan="2">Salario Neto</th>
                                    <th rowspan="2">Ver N贸mina</th>
                                </tr>
                                <tr>
                                    <th>Seguridad Social</th>
                                    <th>IPRF</th>
                                    <th>PDGE</th>
                                    <th>Otros</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="justificationModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="this.parentElement.parentElement.style.display='none'">&times;</span>
            <h3 id="justification-title">A帽adir Justificaci贸n</h3>
            <textarea id="justification-text" placeholder="Escriba su justificaci贸n..."></textarea>
            <button id="save-justification-btn">Guardar</button>
        </div>
    </div>

    <div id="loginModal" class="modal"></div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script>
        let currentUserId = null;
        let employeeFullName = 'Cargando...'; // Global variable for employee's full name

        const firebaseConfig = {
            apiKey: "AIzaSyBTehSBePV6bjKkI_htP6NsU4agckkSOrE",
            authDomain: "atiempo-9f08a.firebaseapp.com",
            projectId: "atiempo-9f08a",
            storageBucket: "atiempo-9f08a.appspot.com",
            messagingSenderId: "221735208077",
            appId: "1:221735208077:web:28a3134fa23bd407a20ec4",
            measurementId: "G-NVPGWJQ9J6"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const loginModal = document.getElementById('loginModal');

        function openTab(evt, tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = "none");
            document.querySelectorAll('.tab-link').forEach(link => link.classList.remove("active"));
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.classList.add("active");
        }

        function populatePersonalTab(data) {
            const grid = document.getElementById('personal-details-grid');
            grid.innerHTML = '';
            const fields = {
                "Email Personal": data.email_personal, "Tel茅fono Personal": data.telefono_personal,
                "Direcci贸n": data.direccion, "Fecha de Nacimiento": data.fecha_nacimiento,
                "Edad": data.edad, "Estado Civil": data.estado_civil,
                "Sexo": data.sexo, "Dependientes": data.dependientes,
                "Nacionalidad": data.nacionalidad, "Natural de": data.natural_de,
                "DIP": data.dip_numero, "Pasaporte": data.pasaporte_numero
            };
            for (const [label, value] of Object.entries(fields)) {
                const item = document.createElement('div');
                item.className = 'detail-item';
                item.innerHTML = `<strong>${label}</strong><span>${value || '---'}</span>`;
                grid.appendChild(item);
            }
        }

        async function loadMyAttendance() {
            if (!currentUserId) return;
            const year = document.getElementById("yearSelect").value;
            const month = document.getElementById("monthSelect").value;
            try {
                const response = await fetch(`/attendance?employee_id=${currentUserId}&year=${year}&month=${month}`);
                const data = await response.json();
                const tableBody = document.querySelector("#attendanceTable tbody");
                tableBody.innerHTML = '';
                if (data.status === 'success' && Object.keys(data.days).length > 0) {
                    Object.keys(data.days).sort((a,b)=>Number(a)-Number(b)).forEach(key => {
                        const record = data.days[key];
                        const dateStr = `${year}-${String(new Date(Date.parse(month +" 1, 2012")).getMonth()+1).padStart(2,'0')}-${String(key).padStart(2,'0')}`;
                        const tr = document.createElement('tr');
                        tr.className = 'attendance-row';
                        tr.dataset.date = dateStr; 
                        tr.innerHTML = `<td>${dateStr}</td><td>${record.hora_entrada||'--'}</td><td>${record.hora_salida||'--'}</td><td>${record.explicacion||''}</td>`;
                        tr.addEventListener('click', () => openJustificationModal(dateStr, record.explicacion));
                        tableBody.appendChild(tr);
                    });
                } else { tableBody.innerHTML = '<tr><td colspan="4">No hay registros para este mes.</td></tr>'; }
            } catch (error) { console.error("Error fetching attendance", error); }
        }
        
        async function loadMyPayroll() {
            try {
                const response = await fetch('/api/me/payroll');
                const data = await response.json();
                const tableBody = document.querySelector("#payrollTable tbody");
                tableBody.innerHTML = '';
                if (data.status === 'success' && data.payroll.length > 0) {
                    data.payroll.forEach(slip => {
                        // Construct URL for mock PDF, passing necessary data
                        const mockPdfUrl = `/generate-payroll-pdf-mock?period=${encodeURIComponent(slip.periodo)}&pay_date=${encodeURIComponent(slip.fecha_pago)}&net_salary=${encodeURIComponent(slip.salario_neto)}&employee_name=${encodeURIComponent(employeeFullName)}`;
                        
                        tableBody.innerHTML += `
                            <tr>
                                <td>${slip.periodo}</td>
                                <td>${slip.fecha_pago}</td>
                                <td>FCFA ${parseFloat(slip.salario_bruto).toLocaleString('es-GQ', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                <td>FCFA ${parseFloat(slip.deducciones.seguridad_social).toLocaleString('es-GQ', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                <td>FCFA ${parseFloat(slip.deducciones.iprf).toLocaleString('es-GQ', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                <td>FCFA ${parseFloat(slip.deducciones.pdge).toLocaleString('es-GQ', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                <td>FCFA ${parseFloat(slip.deducciones.otros).toLocaleString('es-GQ', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                <td>FCFA ${parseFloat(slip.salario_neto).toLocaleString('es-GQ', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                <td><a href="${slip.url}" target="_blank">Ver N贸mina</a></td>
                            </tr>`;
                    });
                } else { tableBody.innerHTML = '<tr><td colspan="9">No hay n贸minas disponibles.</td></tr>'; }
            } catch (error) { console.error("Error fetching payroll", error); }
        }

        function setupAttendanceTab() {
            const yearSel = document.getElementById("yearSelect");
            const monthSel = document.getElementById("monthSelect");
            const yearNow = new Date().getFullYear();
            for (let y = yearNow - 1; y <= yearNow; y++) { yearSel.add(new Option(y, y)); }
            yearSel.value = yearNow;
            const months = ["enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"];
            months.forEach(m => monthSel.add(new Option(m.charAt(0).toUpperCase() + m.slice(1), m)));
            monthSel.value = months[new Date().getMonth()];
            yearSel.onchange = loadMyAttendance;
            monthSel.onchange = loadMyAttendance;
        }

      /**
 * Opens the modal to add or edit a justification for a specific date.
 * @param {string} date - The date of the record (e.g., "2025-07-12").
 * @param {string} currentJustification - The existing justification text.
 */
function openJustificationModal(date, currentJustification) {
    const modal = document.getElementById('justificationModal');
    const title = document.getElementById('justification-title');
    const text = document.getElementById('justification-text');
    const saveBtn = document.getElementById('save-justification-btn');

    // Set the modal title and pre-fill the textarea
    title.textContent = `Justificaci贸n para el d铆a: ${date}`;
    text.value = currentJustification || '';
    
    // Set the action for the save button to pass the correct date
    saveBtn.onclick = () => saveJustification(date);

    modal.style.display = 'block';
}

/**
 * Sends the justification text to the backend to be saved in the database.
 * @param {string} date - The date for which to save the justification.
 */
async function saveJustification(date) {
    const justification = document.getElementById('justification-text').value;
    // currentUserId should be set when the user's profile loads
    if (!currentUserId) {
        // Replaced alert with console.error for non-blocking error display
        console.error("Error: No se ha identificado al usuario.");
        // Consider a custom modal/message box here if user interaction is required
        return;
    }

    try {
        const response = await fetch('/api/attendance/justification', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                employee_id: currentUserId,
                date: date,
                justification: justification
            })
        });

        const result = await response.json();
        if (result.status === 'success') {
            // Replaced alert with console.log
            console.log('Justificaci贸n guardada con 茅xito.');
            document.getElementById('justificationModal').style.display = 'none';
            loadMyAttendance(); // Refresh the attendance table to show the new data
        } else {
            throw new Error(result.message);
        }
    } catch(error) {
        console.error(`Error al guardar la justificaci贸n: ${error.message}`);
        // Consider a custom modal/message box here if user interaction is required
    }
}

        auth.onAuthStateChanged(async user => {
            if (user) {
                try {
                    const token = await user.getIdToken();
                    const response = await fetch('/api/me', { headers: { 'Authorization': `Bearer ${token}` } });
                    const data = await response.json();
                    if (data.status === 'success') {
                        currentUserId = data.id;
                        employeeFullName = data.nombre_completo || '---'; // Set global employeeFullName
                        document.getElementById('detail_photo').src = data.url_foto || 'https://placehold.co/120';
                        document.getElementById('detail_nombre_completo').textContent = employeeFullName; // Use the global variable
                        document.getElementById('detail_puesto').textContent = data.puesto || '---';
                        
                        populatePersonalTab(data);
                        setupAttendanceTab();
                        loadMyAttendance();
                        loadMyPayroll(); // This will now use employeeFullName

                        document.getElementById('profile-content').style.display = 'block';
                        document.getElementById('auth-message').style.display = 'none';
                    } else { throw new Error(data.message); }
                } catch (error) {
                    const authMessage = document.getElementById('auth-message');
                    authMessage.innerHTML = `<p style="color:red;">Error: ${error.message}</p>`;
                    authMessage.style.display = 'block';
                }
            } else { loginModal.style.display = 'block'; }
        });
    </script>
</body>
</html>

